@{
    Layout = "_LayoutAdmin";
    ViewData["Title"] = "æµè§ˆå™¨ç®¡ç†";
}

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="row">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3 id="totalCount">0</h3>
                        <p>æ€»æ•°</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-browser"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3 id="runningCount">0</h3>
                        <p>è¿è¡Œä¸­</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-play-circle"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3 id="groupCount">0</h3>
                        <p>åˆ†ç»„æ•°</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-folder"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3 id="selectedCount">0</h3>
                        <p>å·²é€‰ä¸­</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-check-square"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- æµè§ˆå™¨åˆ—è¡¨ -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">æµè§ˆå™¨åˆ—è¡¨</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-success btn-sm mr-2" onclick="createRandomBrowser()">
                                <i class="fas fa-magic"></i> ä¸€é”®åˆ›å»ºéšæœºæµè§ˆå™¨
                            </button>
                            <button type="button" class="btn btn-primary btn-sm" onclick="openCreateModal()">
                                <i class="fas fa-plus"></i> æ·»åŠ æµè§ˆå™¨
                            </button>
                        </div>
                    </div>
                    <!-- è¿‡æ»¤å™¨ -->
                    <div class="card-body border-bottom">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group mb-2">
                                    <label class="mb-1"><small>æœç´¢</small></label>
                                    <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="åç§°ã€UAã€å¤‡æ³¨...">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group mb-2">
                                    <label class="mb-1"><small>åˆ†ç»„</small></label>
                                    <select id="groupFilter" class="form-control form-control-sm">
                                        <option value="">å…¨éƒ¨åˆ†ç»„</option>
                                        <option value="-1">æœªåˆ†ç»„</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group mb-2">
                                    <label class="mb-1"><small>å¼•æ“</small></label>
                                    <select id="engineFilter" class="form-control form-control-sm">
                                        <option value="">å…¨éƒ¨å¼•æ“</option>
                                        <option value="UndetectedChrome">UndetectedChrome</option>
                                        <option value="Chromium">Chromium</option>
                                        <option value="Firefox">Firefox</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group mb-2">
                                    <label class="mb-1"><small>æ“ä½œç³»ç»Ÿ</small></label>
                                    <select id="osFilter" class="form-control form-control-sm">
                                        <option value="">å…¨éƒ¨ç³»ç»Ÿ</option>
                                        <option value="windows">Windows</option>
                                        <option value="macos">MacOS</option>
                                        <option value="linux">Linux</option>
                                        <option value="android">Android</option>
                                        <option value="ios">iOS</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group mb-2">
                                    <label class="mb-1"><small>æ’åº</small></label>
                                    <select id="sortByFilter" class="form-control form-control-sm">
                                        <option value="createdat-desc">æœ€æ–°åˆ›å»º</option>
                                        <option value="createdat-asc">æœ€æ—©åˆ›å»º</option>
                                        <option value="name-asc">åç§° A-Z</option>
                                        <option value="name-desc">åç§° Z-A</option>
                                        <option value="launchcount-desc">å¯åŠ¨æ¬¡æ•°â†“</option>
                                        <option value="launchcount-asc">å¯åŠ¨æ¬¡æ•°â†‘</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-1">
                                <div class="form-group mb-2">
                                    <label class="mb-1"><small>&nbsp;</small></label>
                                    <button type="button" class="btn btn-primary btn-sm btn-block" onclick="applyFilters()">
                                        <i class="fas fa-filter"></i> ç­›é€‰
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body table-responsive p-0">
                        <table class="table table-hover text-nowrap">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAll"></th>
                                    <th>ID</th>
                                    <th>åç§°</th>
                                    <th>åˆ†ç»„</th>
                                    <th>å¼•æ“</th>
                                    <th>ç³»ç»Ÿ</th>
                                    <th>å¯åŠ¨æ¬¡æ•°</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="browsersTableBody">
                                <tr>
                                    <td colspan="9" class="text-center">
                                        <div class="spinner-border" role="status">
                                            <span class="sr-only">åŠ è½½ä¸­...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer clearfix">
                        <ul class="pagination pagination-sm m-0 float-right" id="pagination">
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- æµè§ˆå™¨ç¼–è¾‘å¼¹å‡ºæ¡† -->
<div class="modal fade" id="browserModal" tabindex="-1" role="dialog" aria-labelledby="browserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document" style="max-width: 90%;">
        <div class="modal-content" style="height: 90vh;">
            <div class="modal-header">
                <h5 class="modal-title" id="browserModalLabel">æµè§ˆå™¨ç®¡ç†</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="padding: 0; height: calc(90vh - 120px); overflow: auto;">
                <iframe id="browserIframe" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveButton">
                    <i class="fas fa-save"></i> ä¿å­˜
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- æŒ‡çº¹ä¿¡æ¯æŸ¥çœ‹æ¨¡æ€æ¡† -->
<div class="modal fade" id="fingerprintModal" tabindex="-1" role="dialog" aria-labelledby="fingerprintModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fingerprintModalLabel">ğŸ” æµè§ˆå™¨æŒ‡çº¹ä¿¡æ¯</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <button type="button" class="btn btn-sm btn-success" onclick="selectAllFingerprint()">
                        <i class="fas fa-check-square"></i> å…¨é€‰
                    </button>
                    <button type="button" class="btn btn-sm btn-primary ml-2" onclick="copyFingerprint()">
                        <i class="fas fa-copy"></i> å¤åˆ¶
                    </button>
                    <button type="button" class="btn btn-sm btn-info ml-2" onclick="downloadFingerprint()">
                        <i class="fas fa-download"></i> ä¸‹è½½
                    </button>
                </div>
                
                <!-- Tab åˆ‡æ¢ -->
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="text-tab" data-toggle="tab" href="#textFormat" role="tab">
                            ğŸ“„ æ–‡æœ¬æ ¼å¼
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="json-tab" data-toggle="tab" href="#jsonFormat" role="tab">
                            ğŸ“‹ JSON æ ¼å¼
                        </a>
                    </li>
                </ul>
                
                <!-- Tab å†…å®¹ -->
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="textFormat" role="tabpanel">
                        <textarea id="fingerprintText" class="form-control" style="font-family: 'Courier New', monospace; font-size: 12px; height: 500px; white-space: pre;" readonly></textarea>
                    </div>
                    <div class="tab-pane fade" id="jsonFormat" role="tabpanel">
                        <textarea id="fingerprintJson" class="form-control" style="font-family: 'Courier New', monospace; font-size: 12px; height: 500px; white-space: pre;" readonly></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> å…³é—­
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentPage = 1;
        const pageSize = 20;
        let selectedBrowsers = new Set();
        let runningIds = new Set(); // æ­£åœ¨è¿è¡Œçš„æµè§ˆå™¨IDé›†åˆ
        let runningMap = {}; // { browserId: processId }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        $(document).ready(function() {
            loadGroups();
            loadStatistics();
            loadRunning().always(function() {
                loadBrowsers();
            });
            // å®šæ—¶åˆ·æ–°è¿è¡Œä¸­çŠ¶æ€
            setInterval(loadRunning, 5000);

            // æœç´¢æ¡†å›è½¦äº‹ä»¶
            $('#searchInput').on('keypress', function(e) {
                if (e.which === 13) {
                    applyFilters();
                }
            });

            // è¿‡æ»¤å™¨å˜åŒ–æ—¶è‡ªåŠ¨åº”ç”¨
            $('#groupFilter, #engineFilter, #osFilter, #sortByFilter').on('change', function() {
                applyFilters();
            });

            // å…¨é€‰checkbox
            $('#selectAll').on('change', function() {
                const isChecked = $(this).is(':checked');
                $('.browser-checkbox').prop('checked', isChecked);
                updateSelectedCount();
            });
        });

        // åŠ è½½åˆ†ç»„åˆ—è¡¨
        function loadGroups() {
            $.ajax({
                url: '@Url.Action("GetGroups")',
                method: 'GET',
                success: function(data) {
                    const groupFilter = $('#groupFilter');
                    // ä¿ç•™"å…¨éƒ¨åˆ†ç»„"å’Œ"æœªåˆ†ç»„"é€‰é¡¹
                    groupFilter.find('option:gt(1)').remove();
                    
                    if (data && data.length > 0) {
                        data.forEach(function(group) {
                            groupFilter.append(`<option value="${group.id}">${group.name}</option>`);
                        });
                    }
                },
                error: function(xhr) {
                    console.error('åŠ è½½åˆ†ç»„åˆ—è¡¨å¤±è´¥:', xhr);
                }
            });
        }

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        function loadStatistics() {
            $.ajax({
                url: '@Url.Action("GetStatistics")',
                method: 'GET',
                success: function(data) {
                    $('#totalCount').text(data.totalCount || 0);
                    // runningCount æ”¹ç”±è¿è¡Œä¸­æ¥å£å®æ—¶æ›´æ–°
                    $('#groupCount').text(data.groupCount || 0);
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        window.location.href = '@Url.Action("Login", "Auth")';
                    }
                }
            });
        }

        // åŠ è½½æ­£åœ¨è¿è¡Œçš„æµè§ˆå™¨å¹¶æ›´æ–°æ ‡è®°
        function loadRunning() {
            return $.ajax({
                url: '@Url.Action("GetRunningBrowsers")',
                method: 'GET',
                success: function(resp) {
                    if (resp && resp.success && resp.data) {
                        // API è¿”å›çš„æ˜¯æ•°ç»„ [{id, name, processId, engine}, ...]
                        // è½¬æ¢ä¸º Map: {browserId: processId}
                        runningMap = {};
                        resp.data.forEach(browser => {
                            runningMap[browser.id] = browser.processId;
                        });
                        const ids = Object.keys(runningMap).map(id => parseInt(id));
                        runningIds = new Set(ids);
                        $('#runningCount').text(ids.length);
                        updateRunningIndicators();
                    }
                },
                error: function(xhr) {
                    console.error('åŠ è½½è¿è¡Œä¸­æµè§ˆå™¨å¤±è´¥:', xhr);
                }
            });
        }

        // åŠ è½½æµè§ˆå™¨åˆ—è¡¨
        function loadBrowsers(page = 1) {
            currentPage = page;
            const search = $('#searchInput').val();
            const groupId = $('#groupFilter').val();
            const engine = $('#engineFilter').val();
            const os = $('#osFilter').val();
            const sortBy = $('#sortByFilter').val();
            
            // è§£ææ’åºå­—æ®µå’Œé¡ºåº
            let sortField = 'createdat';
            let sortOrder = 'desc';
            if (sortBy) {
                const parts = sortBy.split('-');
                sortField = parts[0];
                sortOrder = parts[1];
            }
            
            $.ajax({
                url: '@Url.Action("GetBrowsers")',
                method: 'GET',
                data: {
                    page: page,
                    pageSize: pageSize,
                    search: search,
                    groupId: groupId,
                    engine: engine,
                    os: os,
                    sortBy: sortField,
                    sortOrder: sortOrder
                },
                success: function(data) {
                    renderBrowsers(data.items);
                    renderPagination(data.page, data.totalPages);
                    $('#totalCount').text(data.totalCount);
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        window.location.href = '@Url.Action("Login", "Auth")';
                    } else {
                        showError('åŠ è½½æµè§ˆå™¨åˆ—è¡¨å¤±è´¥');
                    }
                }
            });
        }

        // åº”ç”¨è¿‡æ»¤å™¨
        function applyFilters() {
            loadBrowsers(1);
        }

        // æ¸²æŸ“æµè§ˆå™¨åˆ—è¡¨
        function renderBrowsers(browsers) {
            const tbody = $('#browsersTableBody');
            tbody.empty();

            if (!browsers || browsers.length === 0) {
                tbody.html('<tr><td colspan="9" class="text-center">æš‚æ— æ•°æ®</td></tr>');
                return;
            }

            browsers.forEach(browser => {
                const isRunning = runningIds.has(browser.id);
                const row = `
                    <tr data-browser-id="${browser.id}">
                        <td><input type="checkbox" class="browser-checkbox" data-id="${browser.id}"></td>
                        <td>${browser.id}</td>
                        <td>
                            <strong>${browser.name}</strong>
                            ${isRunning ? '<span class="badge badge-success ml-2">è¿è¡Œä¸­</span>' : ''}
                        </td>
                        <td>${browser.groupName || '<span class="text-muted">æœªåˆ†ç»„</span>'}</td>
                        <td><span class="badge badge-info">${browser.engine}</span></td>
                        <td>${browser.os}</td>
                        <td>${browser.launchCount}</td>
                        <td>${formatDate(browser.createdAt)}</td>
                        <td>
                            <button class="btn btn-sm btn-success launch-btn" onclick="launchBrowser(${browser.id})" title="å¯åŠ¨" ${isRunning ? 'disabled' : ''}>
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="btn btn-sm btn-warning stop-btn" onclick="stopBrowser(${browser.id})" title="åœæ­¢" ${!isRunning ? 'disabled' : ''}>
                                <i class="fas fa-stop"></i>
                            </button>
                            <button class="btn btn-sm btn-info" onclick="openEditModal(${browser.id})" title="ç¼–è¾‘">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="viewFingerprint(${browser.id})" title="æŸ¥çœ‹æŒ‡çº¹">
                                <i class="fas fa-fingerprint"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteBrowser(${browser.id})" title="åˆ é™¤">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });

            // ç»‘å®šcheckboxäº‹ä»¶
            $('.browser-checkbox').on('change', updateSelectedCount);
        }

        // æ ¹æ® runningIds æ›´æ–°å·²æ¸²æŸ“è¡¨æ ¼ä¸­çš„â€œè¿è¡Œä¸­â€æ ‡è®°å’ŒæŒ‰é’®çŠ¶æ€
        function updateRunningIndicators() {
            $('#browsersTableBody tr').each(function() {
                const id = parseInt($(this).attr('data-browser-id'));
                const nameCell = $(this).find('td').eq(2);
                const launchBtn = $(this).find('button.launch-btn');
                const stopBtn = $(this).find('button.stop-btn');
                const isRunning = runningIds.has(id);

                // æ›´æ–°è¿è¡Œä¸­å¾½æ ‡ï¼šå…ˆç§»é™¤æ—§çš„ï¼Œå†æŒ‰éœ€è¦æ·»åŠ 
                nameCell.find('.badge-success').remove();
                if (isRunning) {
                    if (nameCell.find('.badge-success').length === 0) {
                        nameCell.append('<span class="badge badge-success ml-2">è¿è¡Œä¸­</span>');
                    }
                    launchBtn.attr('disabled', true);
                    stopBtn.attr('disabled', false);
                } else {
                    launchBtn.attr('disabled', false);
                    stopBtn.attr('disabled', true);
                }
            });
        }

        // æ¸²æŸ“åˆ†é¡µ
        function renderPagination(currentPage, totalPages) {
            const pagination = $('#pagination');
            pagination.empty();

            if (totalPages <= 1) return;

            // ä¸Šä¸€é¡µ
            pagination.append(`
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadBrowsers(${currentPage - 1}); return false;">Â«</a>
                </li>
            `);

            // é¡µç 
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    pagination.append(`
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="loadBrowsers(${i}); return false;">${i}</a>
                        </li>
                    `);
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    pagination.append('<li class="page-item disabled"><span class="page-link">...</span></li>');
                }
            }

            // ä¸‹ä¸€é¡µ
            pagination.append(`
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadBrowsers(${currentPage + 1}); return false;">Â»</a>
                </li>
            `);
        }

        // æ›´æ–°é€‰ä¸­æ•°é‡
        function updateSelectedCount() {
            const count = $('.browser-checkbox:checked').length;
            $('#selectedCount').text(count);
        }

        // å¯åŠ¨æµè§ˆå™¨
        function launchBrowser(id) {
            if (!confirm('ç¡®å®šè¦å¯åŠ¨è¿™ä¸ªæµè§ˆå™¨å—ï¼Ÿ')) return;

            $.ajax({
                url: '@Url.Action("LaunchBrowser")' + '?id=' + id,
                method: 'POST',
                success: function(data) {
                    if (data.success) {
                        showSuccess(data.message || 'æµè§ˆå™¨å¯åŠ¨æˆåŠŸ');
                        // å¯åŠ¨æˆåŠŸåï¼Œç«‹å³åˆ·æ–°è¿è¡Œä¸­çŠ¶æ€ä¸ç»Ÿè®¡
                        loadRunning();
                        loadStatistics();
                    } else {
                        showError(data.error || 'å¯åŠ¨å¤±è´¥');
                    }
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        window.location.href = '@Url.Action("Login", "Auth")';
                    } else {
                        showError('å¯åŠ¨æµè§ˆå™¨å¤±è´¥');
                    }
                }
            });
        }

        // åœæ­¢æµè§ˆå™¨
        function stopBrowser(id) {
            if (!confirm('ç¡®å®šè¦åœæ­¢è¿™ä¸ªæµè§ˆå™¨å—ï¼Ÿ')) return;

            $.ajax({
                url: '@Url.Action("StopBrowser")' + '?id=' + id,
                method: 'POST',
                success: function(data) {
                    if (data.success) {
                        showSuccess(data.message || 'æµè§ˆå™¨å·²åœæ­¢');
                        // åœæ­¢æˆåŠŸåï¼Œç«‹å³åˆ·æ–°è¿è¡Œä¸­çŠ¶æ€ä¸ç»Ÿè®¡
                        loadRunning();
                        loadStatistics();
                    } else {
                        showError(data.error || 'åœæ­¢å¤±è´¥');
                    }
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        window.location.href = '@Url.Action("Login", "Auth")';
                    } else {
                        showError('åœæ­¢æµè§ˆå™¨å¤±è´¥');
                    }
                }
            });
        }


        // åˆ é™¤æµè§ˆå™¨
        function deleteBrowser(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæµè§ˆå™¨å—ï¼Ÿ')) return;

            $.ajax({
                url: '@Url.Action("DeleteBrowser")' + '?id=' + id,
                method: 'DELETE',
                success: function(data) {
                    if (data.success) {
                        showSuccess('åˆ é™¤æˆåŠŸ');
                        loadBrowsers(currentPage);
                        loadStatistics();
                    } else {
                        showError(data.error || 'åˆ é™¤å¤±è´¥');
                    }
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        window.location.href = '@Url.Action("Login", "Auth")';
                    } else {
                        showError('åˆ é™¤å¤±è´¥');
                    }
                }
            });
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN');
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            if (typeof toastr !== 'undefined') {
                toastr.success(message);
            } else {
                alert(message);
            }
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            if (typeof toastr !== 'undefined') {
                toastr.error(message);
            } else {
                alert('é”™è¯¯: ' + message);
            }
        }

        // ä¸€é”®åˆ›å»ºéšæœºæµè§ˆå™¨
        function createRandomBrowser() {
            if (!confirm('ç¡®å®šè¦åˆ›å»ºä¸€ä¸ªéšæœºæµè§ˆå™¨ç¯å¢ƒå—ï¼Ÿ')) return;

            // æ˜¾ç¤ºåŠ è½½æç¤º
            if (typeof toastr !== 'undefined') {
                toastr.info('æ­£åœ¨åˆ›å»ºéšæœºæµè§ˆå™¨...');
            }

            $.ajax({
                url: '@Url.Action("CreateRandomBrowser")',
                method: 'POST',
                success: function(data) {
                    if (data.success) {
                        showSuccess(data.message || 'éšæœºæµè§ˆå™¨åˆ›å»ºæˆåŠŸ');
                        // åˆ·æ–°åˆ—è¡¨
                        loadBrowsers(currentPage);
                        loadStatistics();
                    } else {
                        showError(data.error || 'åˆ›å»ºå¤±è´¥');
                    }
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        window.location.href = '@Url.Action("Login", "Auth")';
                    } else {
                        showError('åˆ›å»ºéšæœºæµè§ˆå™¨å¤±è´¥');
                    }
                }
            });
        }

        // æ‰“å¼€åˆ›å»ºæµè§ˆå™¨å¼¹å‡ºæ¡†
        function openCreateModal() {
            $('#browserModalLabel').text('æ·»åŠ æµè§ˆå™¨');
            $('#browserIframe').attr('src', '@Url.Action("Create")?modal=1');
            $('#browserModal').modal('show');
        }

        // æ‰“å¼€ç¼–è¾‘æµè§ˆå™¨å¼¹å‡ºæ¡†
        function openEditModal(id) {
            $('#browserModalLabel').text('ç¼–è¾‘æµè§ˆå™¨');
            $('#browserIframe').attr('src', '@Url.Action("Create")?id=' + id + '&modal=1');
            $('#browserModal').modal('show');
        }

        // æŸ¥çœ‹æµè§ˆå™¨æŒ‡çº¹
        let currentFingerprintData = null;
        let currentBrowserId = null;
        function viewFingerprint(id) {
            currentBrowserId = id;
            
            // åŠ è½½æ–‡æœ¬æ ¼å¼
            $.ajax({
                url: '@Url.Action("GetBrowserFingerprint")' + '?id=' + id + '&format=text',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        currentFingerprintData = response.data;
                        $('#fingerprintText').val(response.data.text);
                        $('#fingerprintModalLabel').text(`ğŸ” æµè§ˆå™¨æŒ‡çº¹ä¿¡æ¯ - ${response.data.browser.name}`);
                        $('#fingerprintModal').modal('show');
                    } else {
                        showError(response.error || 'è·å–æŒ‡çº¹ä¿¡æ¯å¤±è´¥');
                    }
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        window.location.href = '@Url.Action("Login", "Auth")';
                    } else {
                        showError('è·å–æŒ‡çº¹ä¿¡æ¯å¤±è´¥');
                    }
                }
            });
        }
        
        // ç›‘å¬ JSON Tab åˆ‡æ¢ï¼Œæ‡’åŠ è½½ JSON æ•°æ®
        $('#json-tab').on('shown.bs.tab', function() {
            if (currentBrowserId && !$('#fingerprintJson').val()) {
                // åŠ è½½ JSON æ ¼å¼
                $.ajax({
                    url: '@Url.Action("GetBrowserFingerprint")' + '?id=' + currentBrowserId + '&format=json',
                    method: 'GET',
                    success: function(response) {
                        if (response.success) {
                            // æ ¼å¼åŒ– JSON æ˜¾ç¤º
                            const jsonObj = JSON.parse(response.data.json);
                            $('#fingerprintJson').val(JSON.stringify(jsonObj, null, 2));
                        } else {
                            $('#fingerprintJson').val('è·å– JSON å¤±è´¥: ' + response.error);
                        }
                    },
                    error: function() {
                        $('#fingerprintJson').val('è·å– JSON å¤±è´¥');
                    }
                });
            }
        });
        
        // æ¸…ç©º JSON å†…å®¹ï¼Œé¿å…ç¼“å­˜
        $('#fingerprintModal').on('hidden.bs.modal', function() {
            $('#fingerprintJson').val('');
            currentBrowserId = null;
        });

        // å…¨é€‰æŒ‡çº¹æ–‡æœ¬
        function selectAllFingerprint() {
            // æ ¹æ®å½“å‰æ¿€æ´»çš„ Tab é€‰æ‹©å¯¹åº”çš„ textarea
            const activeTab = $('#fingerprintModal .tab-pane.active');
            const textarea = activeTab.find('textarea')[0];
            if (textarea) {
                textarea.select();
            }
        }

        // å¤åˆ¶æŒ‡çº¹æ–‡æœ¬
        function copyFingerprint() {
            // æ ¹æ®å½“å‰æ¿€æ´»çš„ Tab é€‰æ‹©å¯¹åº”çš„ textarea
            const activeTab = $('#fingerprintModal .tab-pane.active');
            const textarea = activeTab.find('textarea')[0];
            if (textarea) {
                textarea.select();
                document.execCommand('copy');
                showSuccess('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }
        }

        // ä¸‹è½½æŒ‡çº¹æ–‡æœ¬
        function downloadFingerprint() {
            if (!currentFingerprintData) return;
            
            // æ ¹æ®å½“å‰æ¿€æ´»çš„ Tab é€‰æ‹©å¯¹åº”çš„å†…å®¹å’Œæ–‡ä»¶æ‰©å±•å
            const activeTabId = $('#fingerprintModal .nav-link.active').attr('href');
            let content, extension;
            
            if (activeTabId === '#jsonFormat') {
                content = $('#fingerprintJson').val();
                extension = 'json';
            } else {
                content = $('#fingerprintText').val();
                extension = 'txt';
            }
            
            if (!content) {
                showError('æ²¡æœ‰å¯å¯¼å‡ºçš„å†…å®¹');
                return;
            }
            
            const browserName = currentFingerprintData.browser.name;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const filename = `fingerprint-${browserName}-${timestamp}.${extension}`;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showSuccess('å·²å¯¼å‡ºåˆ°: ' + filename);
        }

        // ç›‘å¬ iframe å†…çš„ä¿å­˜æˆåŠŸäº‹ä»¶
        window.addEventListener('message', function(event) {
            // éªŒè¯æ¶ˆæ¯æ¥æºï¼ˆå¯é€‰ï¼Œå¢åŠ å®‰å…¨æ€§ï¼‰
            if (event.data && event.data.type === 'browserSaved') {
                // å…³é—­å¼¹å‡ºæ¡†
                $('#browserModal').modal('hide');
                // åˆ·æ–°åˆ—è¡¨
                loadBrowsers(currentPage);
                loadStatistics();
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showSuccess(event.data.message || 'ä¿å­˜æˆåŠŸ');
            }
        });

        // æ¸…ç† iframe å†…å®¹ï¼Œé¿å…ç¼“å­˜é—®é¢˜
        $('#browserModal').on('hidden.bs.modal', function () {
            $('#browserIframe').attr('src', 'about:blank');
        });

        // ä¿å­˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - è°ƒç”¨ iframe å†…çš„ä¿å­˜å‡½æ•°
        $('#saveButton').on('click', function() {
            const iframe = document.getElementById('browserIframe');
            if (iframe && iframe.contentWindow) {
                // è°ƒç”¨ iframe å†…çš„ saveBrowser å‡½æ•°
                iframe.contentWindow.saveBrowser();
            }
        });
    </script>
}
