@{
    Layout = "_LayoutAdmin";
    ViewData["Title"] = "ç¼–è¾‘æµè§ˆå™¨";
}

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <!-- ç¼–è¾‘è¡¨å• -->
            <div class="col-md-8">
                <input type="hidden" id="browserId" value="">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h3>
                    </div>
                    <div class="card-body">
                        <form id="editForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="browserName">æµè§ˆå™¨åç§° <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="browserName" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="browserGroup">æ‰€å±åˆ†ç»„</label>
                                        <select class="form-control" id="browserGroup">
                                            <option value="">æœªåˆ†ç»„</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="browserNotes">å¤‡æ³¨</label>
                                <textarea class="form-control" id="browserNotes" rows="3"></textarea>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- æµè§ˆå™¨é…ç½® -->
                <div class="card card-info">
                    <div class="card-header">
                        <h3 class="card-title">ğŸŒ æµè§ˆå™¨é…ç½®</h3>
                        <div class="card-tools">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="lockBrowserConfig">
                                <label class="custom-control-label" for="lockBrowserConfig">ğŸ“Œ å›ºå®šé…ç½®</label>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="browserEngine">æµè§ˆå™¨å¼•æ“ <span class="text-danger">*</span></label>
                                    <select class="form-control" id="browserEngine">
                                        <option value="UndetectedChrome">UndetectedChrome (æ¨è)</option>
                                        <option value="Chromium">Chromium</option>
                                        <option value="Firefox">Firefox</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="browserOS">æ“ä½œç³»ç»Ÿ <span class="text-danger">*</span></label>
                                    <select class="form-control" id="browserOS">
                                        <option value="Windows">Windows</option>
                                        <option value="MacOS">MacOS</option>
                                        <option value="Linux">Linux</option>
                                        <option value="Android">Android</option>
                                        <option value="iOS">iOS</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="browserResolution">å±å¹•åˆ†è¾¨ç‡</label>
                                    <select class="form-control" id="browserResolution">
                                        <option value="1920x1080">1920x1080 (æ¡Œé¢æ¨è)</option>
                                        <option value="1366x768">1366x768</option>
                                        <option value="1280x720">1280x720</option>
                                        <option value="2560x1440">2560x1440 (2K)</option>
                                        <option value="3840x2160">3840x2160 (4K)</option>
                                        <option value="390x844">390x844 (iPhone 13/14)</option>
                                        <option value="393x852">393x852 (iPhone 15)</option>
                                        <option value="360x800">360x800 (Android å¸¸è§)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="browserLocale">è¯­è¨€åŒºåŸŸ</label>
                                    <select class="form-control" id="browserLocale">
                                        <option value="zh-CN">zh-CN (ç®€ä½“ä¸­æ–‡)</option>
                                        <option value="en-US">en-US (ç¾å›½è‹±è¯­)</option>
                                        <option value="ja-JP">ja-JP (æ—¥æœ¬èª)</option>
                                        <option value="ko-KR">ko-KR (í•œêµ­ì–´)</option>
                                        <option value="zh-TW">zh-TW (ç¹é«”ä¸­æ–‡)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="persistence" checked>
                                <label class="custom-control-label" for="persistence">å¯ç”¨ä¼šè¯æŒä¹…åŒ–ï¼ˆä¿å­˜ Cookieã€å†å²è®°å½•ç­‰ï¼‰</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="headless">
                                <label class="custom-control-label" for="headless">æ— å¤´æ¨¡å¼ï¼ˆHeadlessï¼‰</label>
                            </div>
                            <small class="form-text text-muted">Windows é»˜è®¤æœ‰å¤´æ¨¡å¼ï¼ŒLinux å»ºè®®ä½¿ç”¨æ— å¤´æ¨¡å¼</small>
                        </div>
                    </div>
                </div>

                <!-- æŒ‡çº¹ç‰¹å¾ -->
                <div class="card card-purple">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ­ æŒ‡çº¹ç‰¹å¾</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-sm btn-success" onclick="fullyRandomize()">
                                <i class="fas fa-dice"></i> å®Œå…¨éšæœº
                            </button>
                            <button type="button" class="btn btn-sm btn-primary" onclick="regenerate()">
                                <i class="fas fa-sync"></i> é‡æ–°ç”Ÿæˆ
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="userAgent">User-Agent</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="userAgent" onchange="updateFingerprint()">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" onclick="randomizeUA()">
                                        <i class="fas fa-sync"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="platform">Platform</label>
                                    <input type="text" class="form-control" id="platform" onchange="updateFingerprint()">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="timezone">Timezone</label>
                                    <input type="text" class="form-control" id="timezone" value="Asia/Shanghai" onchange="updateFingerprint()">
                                </div>
                            </div>
                        </div>

                        <h6 class="mt-3"><strong>ç¡¬ä»¶é…ç½®</strong></h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="cpuCores">CPU æ ¸å¿ƒæ•°</label>
                                    <input type="number" class="form-control" id="cpuCores" value="8" onchange="updateFingerprint()">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="memory">å†…å­˜ (GB)</label>
                                    <input type="number" class="form-control" id="memory" value="8" onchange="updateFingerprint()">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="touchPoints">è§¦æ‘¸ç‚¹æ•°</label>
                                    <input type="number" class="form-control" id="touchPoints" value="0" onchange="updateFingerprint()">
                                </div>
                            </div>
                        </div>

                        <h6 class="mt-3">
                            <strong>WebGL é…ç½®</strong>
                            <button type="button" class="btn btn-xs btn-primary ml-2" onclick="randomizeWebGL()">
                                <i class="fas fa-sync"></i> éšæœº
                            </button>
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="webglVendor">WebGL Vendor</label>
                                    <input type="text" class="form-control" id="webglVendor" onchange="updateFingerprint()">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="webglRenderer">WebGL Renderer</label>
                                    <input type="text" class="form-control" id="webglRenderer" onchange="updateFingerprint()">
                                </div>
                            </div>
                        </div>

                        <h6 class="mt-3">
                            <strong>å­—ä½“åˆ—è¡¨</strong>
                            <button type="button" class="btn btn-xs btn-primary ml-2" onclick="randomizeFonts()">
                                <i class="fas fa-sync"></i> éšæœº
                            </button>
                            <span class="badge badge-info ml-2" id="fontsCount">0 ä¸ªå­—ä½“</span>
                        </h6>
                        <div class="form-group">
                            <textarea class="form-control" id="fontsList" rows="3" readonly></textarea>
                        </div>
                    </div>
                </div>

                <!-- ä»£ç†é…ç½® -->
                <div class="card card-warning">
                    <div class="card-header">
                        <h3 class="card-title">ğŸŒ ä»£ç†é…ç½®</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="proxyMode">ä»£ç†æ¨¡å¼</label>
                                    <select class="form-control" id="proxyMode">
                                        <option value="none">ä¸ä½¿ç”¨ä»£ç†</option>
                                        <option value="api">API ä»£ç†</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="proxyUrl">ä»£ç† API URL</label>
                                    <input type="text" class="form-control" id="proxyUrl" placeholder="http://127.0.0.1:7890">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="card">
                    <div class="card-footer">
                        <button type="button" class="btn btn-primary" onclick="saveBrowser()">
                            <i class="fas fa-save"></i> ä¿å­˜
                        </button>
                        <a href="@Url.Action("Index")" class="btn btn-secondary">
                            <i class="fas fa-times"></i> å–æ¶ˆ
                        </a>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæŒ‡çº¹è¯„åˆ† -->
            <div class="col-md-4">
                <!-- æ€»ä½“è¯„åˆ† -->
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ“Š æŒ‡çº¹è¯„åˆ†</h3>
                    </div>
                    <div class="card-body">
                        <h5>æ€»ä½“è¯„åˆ†</h5>
                        <div class="progress mb-3" style="height: 30px;">
                            <div class="progress-bar" id="totalScoreBar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                <span id="totalScoreText" style="font-size: 18px; font-weight: bold;">0</span>
                            </div>
                        </div>
                        <p class="text-muted" id="riskLevel">é£é™©ç­‰çº§: æœªè¯„ä¼°</p>
                    </div>
                </div>

                <!-- è¯¦ç»†è¯„åˆ† -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ“ˆ è¯¦ç»†è¯„åˆ†</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <small class="text-muted">ä¸€è‡´æ€§æ£€æŸ¥</small>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-success" id="consistencyBar" style="width: 0%">
                                    <span id="consistencyText">0</span>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">çœŸå®æ€§æ£€æŸ¥</small>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-info" id="realismBar" style="width: 0%">
                                    <span id="realismText">0</span>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">Cloudflare é£é™© (è¶Šä½è¶Šå¥½)</small>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-danger" id="cloudflareBar" style="width: 0%">
                                    <span id="cloudflareText">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä¼˜åŒ–å»ºè®® -->
                <div class="card card-warning">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ’¡ ä¼˜åŒ–å»ºè®®</h3>
                    </div>
                    <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                        <ul id="recommendations" class="list-unstyled">
                            <li class="text-muted">â€¢ é…ç½®æŒ‡çº¹åå°†æ˜¾ç¤ºå»ºè®®</li>
                        </ul>
                    </div>
                </div>

                <!-- å¿«é€Ÿæ“ä½œ -->
                <div class="card bg-light">
                    <div class="card-body">
                        <button type="button" class="btn btn-success btn-block mb-2" onclick="launchBrowserNow()">
                            <i class="fas fa-play"></i> ç«‹å³å¯åŠ¨
                        </button>
                        <button type="button" class="btn btn-danger btn-block" onclick="deleteBrowserNow()">
                            <i class="fas fa-trash"></i> åˆ é™¤æµè§ˆå™¨
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        let browserId = new URLSearchParams(window.location.search).get('id');

        $(document).ready(function() {
            if (browserId) {
                // å…ˆåŠ è½½åˆ†ç»„ï¼Œå†åŠ è½½æµè§ˆå™¨æ•°æ®
                loadGroups().then(() => {
                    loadBrowserData();
                });
            }
        });

        // åŠ è½½æµè§ˆå™¨æ•°æ®
        function loadBrowserData() {
            $.ajax({
                url: '@Url.Action("GetBrowserDetail")' + '?id=' + browserId,
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        const data = response.data;
                        
                        // åŸºæœ¬ä¿¡æ¯
                        $('#browserId').val(data.id);
                        $('#browserName').val(data.name || '');
                        $('#browserNotes').val(data.notes || '');
                        $('#browserGroup').val(data.groupId || '');
                        
                        // æµè§ˆå™¨é…ç½®
                        $('#browserEngine').val(data.engine || 'UndetectedChrome');
                        $('#browserOS').val(data.os || 'Windows');
                        $('#browserResolution').val((data.viewportWidth || 1920) + 'x' + (data.viewportHeight || 1080));
                        $('#browserLocale').val(data.locale || 'zh-CN');
                        $('#persistence').prop('checked', data.enablePersistence !== false);
                        $('#headless').prop('checked', data.headless === true);
                        
                        // æŒ‡çº¹ç‰¹å¾
                        $('#userAgent').val(data.userAgent || '');
                        $('#platform').val(data.platform || 'Win32');
                        $('#timezone').val(data.timezone || 'Asia/Shanghai');
                        $('#cpuCores').val(data.hardwareConcurrency || 8);
                        $('#memory').val(data.deviceMemory || 8);
                        $('#touchPoints').val(data.maxTouchPoints || 0);
                        $('#webglVendor').val(data.webglVendor || '');
                        $('#webglRenderer').val(data.webglRenderer || '');
                        
                        // å­—ä½“åˆ—è¡¨
                        if (data.fontsJson) {
                            try {
                                const fonts = JSON.parse(data.fontsJson);
                                $('#fontsList').val(fonts.join(', '));
                                $('#fontsCount').text(fonts.length + ' ä¸ªå­—ä½“');
                            } catch (e) {
                                $('#fontsList').val('');
                                $('#fontsCount').text('0 ä¸ªå­—ä½“');
                            }
                        } else {
                            $('#fontsList').val('');
                            $('#fontsCount').text('0 ä¸ªå­—ä½“');
                        }
                        
                        // ä»£ç†é…ç½®
                        $('#proxyMode').val(data.proxyMode || 'none');
                        $('#proxyUrl').val(data.proxyApiUrl || '');
                        
                        // æ›´æ–°æŒ‡çº¹è¯„åˆ†
                        updateFingerprint();
                    } else {
                        showError(response.error || 'åŠ è½½å¤±è´¥');
                    }
                },
                error: function() {
                    showError('åŠ è½½æµè§ˆå™¨ä¿¡æ¯å¤±è´¥');
                }
            });
        }

        // åŠ è½½åˆ†ç»„
        function loadGroups() {
            return $.ajax({
                url: '@Url.Action("GetGroups")',
                method: 'GET',
                success: function(response) {
                    console.log('åˆ†ç»„å“åº”:', response);
                    const select = $('#browserGroup');
                    select.empty();
                    select.append('<option value="">æœªåˆ†ç»„</option>');
                    
                    // å¤„ç† API è¿”å›çš„æ•°æ®æ ¼å¼
                    let groups = [];
                    if (response && response.success && response.data) {
                        groups = response.data;
                    } else if (response && Array.isArray(response)) {
                        groups = response;
                    }
                    
                    if (groups && groups.length > 0) {
                        groups.forEach(function(group) {
                            select.append(`<option value="${group.id}">${group.name}</option>`);
                        });
                    }
                },
                error: function(xhr) {
                    console.error('åŠ è½½åˆ†ç»„å¤±è´¥:', xhr);
                    showError('åŠ è½½åˆ†ç»„å¤±è´¥');
                }
            });
        }

        // ä¿å­˜æµè§ˆå™¨
        function saveBrowser() {
            // è§£æåˆ†è¾¨ç‡
            const resolution = $('#browserResolution').val().split('x');
            const viewportWidth = parseInt(resolution[0]) || 1920;
            const viewportHeight = parseInt(resolution[1]) || 1080;
            
            // è§£æå­—ä½“åˆ—è¡¨ä¸º JSON
            const fontsText = $('#fontsList').val();
            const fontsArray = fontsText ? fontsText.split(',').map(f => f.trim()).filter(f => f) : [];
            const fontsJson = JSON.stringify(fontsArray);
            
            const data = {
                name: $('#browserName').val(),
                notes: $('#browserNotes').val(),
                groupId: $('#browserGroup').val() || null,
                // æµè§ˆå™¨é…ç½®
                engine: $('#browserEngine').val(),
                os: $('#browserOS').val(),
                viewportWidth: viewportWidth,
                viewportHeight: viewportHeight,
                locale: $('#browserLocale').val(),
                timezone: $('#timezone').val(),
                enablePersistence: $('#persistence').is(':checked'),
                headless: $('#headless').is(':checked'),
                // æŒ‡çº¹ç‰¹å¾
                userAgent: $('#userAgent').val(),
                platform: $('#platform').val(),
                hardwareConcurrency: parseInt($('#cpuCores').val()) || 8,
                deviceMemory: parseInt($('#memory').val()) || 8,
                maxTouchPoints: parseInt($('#touchPoints').val()) || 0,
                webGLVendor: $('#webglVendor').val(),
                webGLRenderer: $('#webglRenderer').val(),
                fontsJson: fontsJson,
                // ä»£ç†é…ç½®
                proxyMode: $('#proxyMode').val(),
                proxyApiUrl: $('#proxyUrl').val()
            };

            $.ajax({
                url: '@Url.Action("UpdateBrowser")' + '?id=' + browserId,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.success) {
                        showSuccess('ä¿å­˜æˆåŠŸ');
                        setTimeout(() => {
                            window.location.href = '@Url.Action("Index")';
                        }, 1000);
                    } else {
                        showError(response.error || 'ä¿å­˜å¤±è´¥');
                    }
                },
                error: function() {
                    showError('ä¿å­˜å¤±è´¥');
                }
            });
        }

        // ç«‹å³å¯åŠ¨
        function launchBrowserNow() {
            if (!confirm('ç¡®å®šè¦å¯åŠ¨è¿™ä¸ªæµè§ˆå™¨å—ï¼Ÿ')) return;

            $.ajax({
                url: '@Url.Action("LaunchBrowser")' + '?id=' + browserId,
                method: 'POST',
                success: function(data) {
                    if (data.success) {
                        showSuccess('æµè§ˆå™¨å¯åŠ¨æˆåŠŸ');
                        loadBrowserData();
                    } else {
                        showError(data.error || 'å¯åŠ¨å¤±è´¥');
                    }
                },
                error: function() {
                    showError('å¯åŠ¨æµè§ˆå™¨å¤±è´¥');
                }
            });
        }

        // å®Œå…¨éšæœº
        function fullyRandomize() {
            randomizeUA();
            randomizeWebGL();
            randomizeFonts();
            $('#cpuCores').val(Math.floor(Math.random() * 8) + 4);
            $('#memory').val(Math.pow(2, Math.floor(Math.random() * 3) + 2));
            $('#touchPoints').val(Math.floor(Math.random() * 2) * 5);
            updateFingerprint();
            showSuccess('å·²ç”Ÿæˆå®Œå…¨éšæœºçš„æŒ‡çº¹');
        }

        // é‡æ–°ç”Ÿæˆ
        function regenerate() {
            randomizeUA();
            updateFingerprint();
            showSuccess('å·²é‡æ–°ç”ŸæˆæŒ‡çº¹');
        }

        // éšæœº UA
        function randomizeUA() {
            const uas = [
                'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
            ];
            $('#userAgent').val(uas[Math.floor(Math.random() * uas.length)]);
            $('#platform').val('Win32');
            updateFingerprint();
        }

        // éšæœº WebGL
        function randomizeWebGL() {
            const vendors = ['Google Inc.', 'NVIDIA Corporation', 'Intel Inc.'];
            const renderers = [
                'ANGLE (NVIDIA GeForce GTX 1660 Ti Direct3D11 vs_5_0 ps_5_0)',
                'ANGLE (Intel(R) UHD Graphics 630 Direct3D11 vs_5_0 ps_5_0)',
                'ANGLE (AMD Radeon RX 580 Series Direct3D11 vs_5_0 ps_5_0)'
            ];
            $('#webglVendor').val(vendors[Math.floor(Math.random() * vendors.length)]);
            $('#webglRenderer').val(renderers[Math.floor(Math.random() * renderers.length)]);
            updateFingerprint();
        }

        // éšæœºå­—ä½“
        function randomizeFonts() {
            const allFonts = ['Arial', 'Verdana', 'Tahoma', 'Times New Roman', 'Georgia', 'Courier New', 'Comic Sans MS', 'Impact', 'Trebuchet MS', 'Arial Black', 'Palatino', 'Garamond', 'Bookman', 'Avant Garde', 'Helvetica', 'Calibri', 'Cambria', 'Candara', 'Consolas', 'Constantia', 'Corbel', 'Franklin Gothic', 'Lucida Console', 'Segoe UI', 'Microsoft Sans Serif', 'SimSun', 'SimHei', 'Microsoft YaHei', 'KaiTi', 'FangSong'];
            const count = Math.floor(Math.random() * 20) + 30;
            const selected = [];
            for (let i = 0; i < count && i < allFonts.length; i++) {
                const idx = Math.floor(Math.random() * allFonts.length);
                if (!selected.includes(allFonts[idx])) {
                    selected.push(allFonts[idx]);
                }
            }
            $('#fontsList').val(selected.join(', '));
            $('#fontsCount').text(selected.length + ' ä¸ªå­—ä½“');
            updateFingerprint();
        }

        // æ›´æ–°æŒ‡çº¹è¯„åˆ†
        function updateFingerprint() {
            // è®¡ç®—è¯„åˆ†
            let totalScore = 0;
            let consistency = 0;
            let realism = 0;
            let cloudflare = 0;
            const recommendations = [];

            // æ£€æŸ¥ UA
            if ($('#userAgent').val()) {
                consistency += 25;
                realism += 20;
            } else {
                recommendations.push('å»ºè®®è®¾ç½® User-Agent');
            }

            // æ£€æŸ¥ WebGL
            if ($('#webglVendor').val() && $('#webglRenderer').val()) {
                consistency += 25;
                realism += 30;
                cloudflare = Math.max(0, cloudflare - 20);
            } else {
                recommendations.push('å»ºè®®é…ç½® WebGL ä¿¡æ¯');
            }

            // æ£€æŸ¥å­—ä½“
            const fontsCount = $('#fontsList').val().split(',').filter(f => f.trim()).length;
            if (fontsCount >= 30) {
                consistency += 25;
                realism += 25;
                cloudflare = Math.max(0, cloudflare - 15);
            } else if (fontsCount > 0) {
                consistency += 15;
                realism += 15;
                recommendations.push('å»ºè®®å¢åŠ å­—ä½“æ•°é‡åˆ° 30+ ä¸ª');
            } else {
                recommendations.push('å»ºè®®æ·»åŠ å­—ä½“åˆ—è¡¨');
            }

            // æ£€æŸ¥ç¡¬ä»¶
            if ($('#cpuCores').val() && $('#memory').val()) {
                consistency += 25;
                realism += 25;
            }

            totalScore = Math.round((consistency + realism) / 2);
            cloudflare = Math.min(100, Math.max(0, 100 - totalScore + Math.random() * 20));

            // æ›´æ–°æ˜¾ç¤º
            updateScoreBar('totalScoreBar', 'totalScoreText', totalScore);
            updateScoreBar('consistencyBar', 'consistencyText', consistency);
            updateScoreBar('realismBar', 'realismText', realism);
            updateScoreBar('cloudflareBar', 'cloudflareText', Math.round(cloudflare));

            // é£é™©ç­‰çº§
            let riskLevel = 'æœªè¯„ä¼°';
            if (totalScore >= 80) riskLevel = 'âœ… ä½é£é™©';
            else if (totalScore >= 60) riskLevel = 'âš ï¸ ä¸­é£é™©';
            else if (totalScore > 0) riskLevel = 'âŒ é«˜é£é™©';
            $('#riskLevel').text('é£é™©ç­‰çº§: ' + riskLevel);

            // å»ºè®®
            if (recommendations.length === 0) {
                recommendations.push('é…ç½®è‰¯å¥½ï¼');
            }
            $('#recommendations').html(recommendations.map(r => `<li class="text-warning">â€¢ ${r}</li>`).join(''));
        }

        function updateScoreBar(barId, textId, value) {
            $('#' + barId).css('width', value + '%').attr('aria-valuenow', value);
            $('#' + textId).text(Math.round(value));
        }

        // åˆ é™¤æµè§ˆå™¨
        function deleteBrowserNow() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæµè§ˆå™¨å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) return;

            $.ajax({
                url: '@Url.Action("DeleteBrowser")' + '?id=' + browserId,
                method: 'DELETE',
                success: function(data) {
                    if (data.success) {
                        showSuccess('åˆ é™¤æˆåŠŸ');
                        setTimeout(() => {
                            window.location.href = '@Url.Action("Index")';
                        }, 1000);
                    } else {
                        showError(data.error || 'åˆ é™¤å¤±è´¥');
                    }
                },
                error: function() {
                    showError('åˆ é™¤å¤±è´¥');
                }
            });
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            if (typeof toastr !== 'undefined') {
                toastr.success(message);
            } else {
                alert('æˆåŠŸ: ' + message);
            }
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            if (typeof toastr !== 'undefined') {
                toastr.error(message);
            } else {
                alert('é”™è¯¯: ' + message);
            }
        }
    </script>

    <!-- Toastr CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <!-- Toastr JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
}
