@{
    Layout = "_LayoutAdmin";
    ViewData["Title"] = "æ–°å»ºæµè§ˆå™¨";
}

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <!-- ç¼–è¾‘è¡¨å• -->
            <div class="col-md-8">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="browserName">æµè§ˆå™¨åç§° <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="browserName" placeholder="è¾“å…¥æµè§ˆå™¨åç§°" required>
                        </div>

                        <div class="form-group">
                            <label for="browserNotes">å¤‡æ³¨</label>
                            <textarea class="form-control" id="browserNotes" rows="3" placeholder="è¾“å…¥å¤‡æ³¨ä¿¡æ¯"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="browserGroup">åˆ†ç»„</label>
                            <select class="form-control" id="browserGroup">
                                <option value="">æœªåˆ†ç»„</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card card-info">
                    <div class="card-header">
                        <h3 class="card-title">âš™ï¸ æµè§ˆå™¨é…ç½®</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="browserEngine">æµè§ˆå™¨å¼•æ“</label>
                            <select class="form-control" id="browserEngine">
                                <option value="UndetectedChrome">UndetectedChrome (æ¨è)</option>
                                <option value="Chromium">Chromium</option>
                                <option value="Firefox">Firefox</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="browserOS">æ“ä½œç³»ç»Ÿ</label>
                            <select class="form-control" id="browserOS">
                                <option value="Windows">Windows</option>
                                <option value="MacOS">MacOS</option>
                                <option value="Linux">Linux</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="browserResolution">åˆ†è¾¨ç‡</label>
                            <input type="text" class="form-control" id="browserResolution" value="1920x1080" placeholder="å®½xé«˜">
                        </div>

                        <div class="form-group">
                            <label for="browserLocale">è¯­è¨€/åœ°åŒº</label>
                            <input type="text" class="form-control" id="browserLocale" value="zh-CN" placeholder="ä¾‹: zh-CN, en-US">
                        </div>

                        <div class="form-group">
                            <label for="timezone">æ—¶åŒº</label>
                            <input type="text" class="form-control" id="timezone" value="Asia/Shanghai" placeholder="ä¾‹: Asia/Shanghai">
                        </div>

                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="persistence" checked>
                                <label class="custom-control-label" for="persistence">å¯ç”¨ä¼šè¯æŒä¹…åŒ–ï¼ˆä¿å­˜ Cookieã€å†å²è®°å½•ç­‰ï¼‰</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="headless">
                                <label class="custom-control-label" for="headless">æ— å¤´æ¨¡å¼ï¼ˆHeadlessï¼‰</label>
                            </div>
                            <small class="form-text text-muted">Windows é»˜è®¤æœ‰å¤´æ¨¡å¼ï¼ŒLinux å»ºè®®ä½¿ç”¨æ— å¤´æ¨¡å¼</small>
                        </div>
                    </div>
                </div>

                <!-- æŒ‡çº¹ç‰¹å¾ -->
                <div class="card card-purple">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ­ æŒ‡çº¹ç‰¹å¾</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-sm btn-success" onclick="fullyRandomize()">
                                <i class="fas fa-dice"></i> å®Œå…¨éšæœº
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="userAgent">User Agent</label>
                            <input type="text" class="form-control" id="userAgent" placeholder="æµè§ˆå™¨æ ‡è¯†">
                        </div>

                        <div class="form-group">
                            <label for="platform">å¹³å°</label>
                            <select class="form-control" id="platform">
                                <option value="Win32">Win32 (Windows)</option>
                                <option value="MacIntel">MacIntel (Mac)</option>
                                <option value="Linux x86_64">Linux x86_64</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="cpuCores">CPU æ ¸å¿ƒæ•°</label>
                            <input type="number" class="form-control" id="cpuCores" value="8" min="1" max="128">
                        </div>

                        <div class="form-group">
                            <label for="memory">å†…å­˜ (GB)</label>
                            <input type="number" class="form-control" id="memory" value="8" min="1" max="256">
                        </div>

                        <div class="form-group">
                            <label for="touchPoints">è§¦æ‘¸ç‚¹æ•°</label>
                            <input type="number" class="form-control" id="touchPoints" value="0" min="0">
                        </div>

                        <div class="form-group">
                            <label for="webglVendor">WebGL Vendor</label>
                            <input type="text" class="form-control" id="webglVendor" placeholder="ä¾‹: Google Inc.">
                        </div>

                        <div class="form-group">
                            <label for="webglRenderer">WebGL Renderer</label>
                            <input type="text" class="form-control" id="webglRenderer" placeholder="ä¾‹: ANGLE (Intel HD Graphics)">
                        </div>

                        <div class="form-group">
                            <label for="fontsList">å­—ä½“åˆ—è¡¨ <small class="text-muted">(é€—å·åˆ†éš”)</small></label>
                            <textarea class="form-control" id="fontsList" rows="3" placeholder="Arial, Verdana, Times New Roman..."></textarea>
                            <small class="form-text text-muted" id="fontsCount">0 ä¸ªå­—ä½“</small>
                        </div>
                    </div>
                </div>

                <!-- ä»£ç†é…ç½® -->
                <div class="card card-warning">
                    <div class="card-header">
                        <h3 class="card-title">ğŸŒ ä»£ç†é…ç½®</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="proxyMode">ä»£ç†æ¨¡å¼</label>
                            <select class="form-control" id="proxyMode">
                                <option value="none">æ— ä»£ç†</option>
                                <option value="api">API ä»£ç†</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="proxyUrl">ä»£ç†åœ°å€</label>
                            <input type="text" class="form-control" id="proxyUrl" placeholder="http://proxy.example.com:8080">
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="card">
                    <div class="card-body">
                        <button type="button" class="btn btn-primary" onclick="saveBrowser()">
                            <i class="fas fa-save"></i> åˆ›å»º
                        </button>
                        <a href="@Url.Action("Index")" class="btn btn-secondary">
                            <i class="fas fa-times"></i> å–æ¶ˆ
                        </a>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§é¢æ¿ -->
            <div class="col-md-4">
                <!-- æŒ‡çº¹è¯„åˆ† -->
                <div class="card card-success">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ“Š æŒ‡çº¹è¯„åˆ†</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span>æ€»ä½“è¯„åˆ†</span>
                                <strong id="totalScore">0</strong>
                            </div>
                            <div class="progress">
                                <div id="scoreBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>

                        <hr>

                        <div class="small">
                            <div class="mb-2">
                                <span>User Agent: </span>
                                <span id="uaScore" class="badge badge-secondary">0%</span>
                            </div>
                            <div class="mb-2">
                                <span>Platform: </span>
                                <span id="platformScore" class="badge badge-secondary">0%</span>
                            </div>
                            <div class="mb-2">
                                <span>Hardware: </span>
                                <span id="hardwareScore" class="badge badge-secondary">0%</span>
                            </div>
                            <div class="mb-2">
                                <span>WebGL: </span>
                                <span id="webglScore" class="badge badge-secondary">0%</span>
                            </div>
                            <div class="mb-2">
                                <span>Fonts: </span>
                                <span id="fontsScore" class="badge badge-secondary">0%</span>
                            </div>
                        </div>

                        <hr>

                        <div id="riskLevel" class="alert alert-info mb-0">
                            <strong>é£é™©ç­‰çº§:</strong> æœªè¯„ä¼°
                        </div>
                    </div>
                </div>

                <!-- å¿«é€Ÿæ“ä½œ -->
                <div class="card card-info">
                    <div class="card-header">
                        <h3 class="card-title">âš¡ å¿«é€Ÿæ“ä½œ</h3>
                    </div>
                    <div class="card-body">
                        <button type="button" class="btn btn-block btn-success mb-2" onclick="randomizeUA()">
                            <i class="fas fa-random"></i> éšæœº User Agent
                        </button>
                        <button type="button" class="btn btn-block btn-info mb-2" onclick="randomizeWebGL()">
                            <i class="fas fa-random"></i> éšæœº WebGL
                        </button>
                        <button type="button" class="btn btn-block btn-warning" onclick="randomizeFonts()">
                            <i class="fas fa-random"></i> éšæœºå­—ä½“
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        $(document).ready(function() {
            loadGroups();
            updateFingerprint();
            
            // ç›‘å¬æŒ‡çº¹å­—æ®µå˜åŒ–
            $('#userAgent, #platform, #cpuCores, #memory, #touchPoints, #webglVendor, #webglRenderer, #fontsList').on('change keyup', function() {
                updateFingerprint();
            });
        });

        // åŠ è½½åˆ†ç»„
        function loadGroups() {
            $.ajax({
                url: '@Url.Action("GetGroups", "Browser")',
                method: 'GET',
                success: function(response) {
                    console.log('åˆ†ç»„å“åº”:', response);
                    const select = $('#browserGroup');
                    
                    // å¤„ç† API è¿”å›çš„æ•°æ®æ ¼å¼
                    let groups = [];
                    if (response && response.success && response.data) {
                        groups = response.data;
                    } else if (response && Array.isArray(response)) {
                        groups = response;
                    }
                    
                    if (groups && groups.length > 0) {
                        groups.forEach(function(group) {
                            select.append(`<option value="${group.id}">${group.name}</option>`);
                        });
                    }
                },
                error: function(xhr) {
                    console.error('åŠ è½½åˆ†ç»„å¤±è´¥:', xhr);
                    showError('åŠ è½½åˆ†ç»„å¤±è´¥');
                }
            });
        }

        // ä¿å­˜æµè§ˆå™¨
        function saveBrowser() {
            // è§£æåˆ†è¾¨ç‡
            const resolution = $('#browserResolution').val().split('x');
            const viewportWidth = parseInt(resolution[0]) || 1920;
            const viewportHeight = parseInt(resolution[1]) || 1080;
            
            // è§£æå­—ä½“åˆ—è¡¨ä¸º JSON
            const fontsText = $('#fontsList').val();
            const fontsArray = fontsText ? fontsText.split(',').map(f => f.trim()).filter(f => f) : [];
            const fontsJson = JSON.stringify(fontsArray);
            
            const data = {
                name: $('#browserName').val(),
                notes: $('#browserNotes').val(),
                groupId: $('#browserGroup').val() || null,
                // æµè§ˆå™¨é…ç½®
                engine: $('#browserEngine').val(),
                os: $('#browserOS').val(),
                viewportWidth: viewportWidth,
                viewportHeight: viewportHeight,
                locale: $('#browserLocale').val(),
                timezone: $('#timezone').val(),
                enablePersistence: $('#persistence').is(':checked'),
                headless: $('#headless').is(':checked'),
                // æŒ‡çº¹ç‰¹å¾
                userAgent: $('#userAgent').val(),
                platform: $('#platform').val(),
                hardwareConcurrency: parseInt($('#cpuCores').val()) || 8,
                deviceMemory: parseInt($('#memory').val()) || 8,
                maxTouchPoints: parseInt($('#touchPoints').val()) || 0,
                webGLVendor: $('#webglVendor').val(),
                webGLRenderer: $('#webglRenderer').val(),
                fontsJson: fontsJson,
                // ä»£ç†é…ç½®
                proxyMode: $('#proxyMode').val(),
                proxyApiUrl: $('#proxyUrl').val()
            };

            $.ajax({
                url: '@Url.Action("CreateBrowser")',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.success) {
                        showSuccess('æµè§ˆå™¨åˆ›å»ºæˆåŠŸ');
                        setTimeout(() => {
                            window.location.href = '@Url.Action("Index")';
                        }, 1000);
                    } else {
                        showError(response.error || 'åˆ›å»ºå¤±è´¥');
                    }
                },
                error: function() {
                    showError('åˆ›å»ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            });
        }

        // æ›´æ–°æŒ‡çº¹è¯„åˆ†
        function updateFingerprint() {
            let score = 0;
            
            // User Agent è¯„åˆ†
            const ua = $('#userAgent').val();
            const uaScore = ua && ua.length > 50 ? 25 : 0;
            score += uaScore;
            $('#uaScore').text(uaScore + '%');
            
            // Platform è¯„åˆ†
            const platform = $('#platform').val();
            const platformScore = platform ? 15 : 0;
            score += platformScore;
            $('#platformScore').text(platformScore + '%');
            
            // Hardware è¯„åˆ†
            const cpuCores = parseInt($('#cpuCores').val()) || 0;
            const memory = parseInt($('#memory').val()) || 0;
            const hardwareScore = (cpuCores > 0 && memory > 0) ? 20 : 0;
            score += hardwareScore;
            $('#hardwareScore').text(hardwareScore + '%');
            
            // WebGL è¯„åˆ†
            const webgl = $('#webglVendor').val() && $('#webglRenderer').val();
            const webglScore = webgl ? 20 : 0;
            score += webglScore;
            $('#webglScore').text(webglScore + '%');
            
            // Fonts è¯„åˆ†
            const fonts = $('#fontsList').val();
            const fontCount = fonts ? fonts.split(',').length : 0;
            const fontsScore = fontCount > 5 ? 20 : (fontCount > 0 ? 10 : 0);
            score += fontsScore;
            $('#fontsScore').text(fontsScore + '%');
            $('#fontsCount').text(fontCount + ' ä¸ªå­—ä½“');
            
            // æ›´æ–°æ€»åˆ†
            $('#totalScore').text(score);
            $('#scoreBar').css('width', score + '%');
            
            // é£é™©ç­‰çº§
            let riskLevel = 'æœªè¯„ä¼°';
            let alertClass = 'alert-info';
            if (score >= 80) {
                riskLevel = 'âœ… ä½é£é™© (æ¨è)';
                alertClass = 'alert-success';
            } else if (score >= 60) {
                riskLevel = 'âš ï¸ ä¸­é£é™©';
                alertClass = 'alert-warning';
            } else if (score > 0) {
                riskLevel = 'âŒ é«˜é£é™©';
                alertClass = 'alert-danger';
            }
            
            $('#riskLevel').removeClass('alert-info alert-success alert-warning alert-danger').addClass(alertClass);
            $('#riskLevel').html(`<strong>é£é™©ç­‰çº§:</strong> ${riskLevel}`);
        }

        // å®Œå…¨éšæœº
        function fullyRandomize() {
            randomizeUA();
            randomizeWebGL();
            randomizeFonts();
            updateFingerprint();
        }

        // éšæœº User Agent
        function randomizeUA() {
            const uas = [
                'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36',
                'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
            ];
            $('#userAgent').val(uas[Math.floor(Math.random() * uas.length)]);
            updateFingerprint();
        }

        // éšæœº WebGL
        function randomizeWebGL() {
            const vendors = ['Google Inc.', 'Apple Inc.', 'NVIDIA Corporation'];
            const renderers = ['ANGLE (Intel HD Graphics)', 'ANGLE (NVIDIA GeForce GTX 1080)', 'Apple M1'];
            $('#webglVendor').val(vendors[Math.floor(Math.random() * vendors.length)]);
            $('#webglRenderer').val(renderers[Math.floor(Math.random() * renderers.length)]);
            updateFingerprint();
        }

        // éšæœºå­—ä½“
        function randomizeFonts() {
            const allFonts = ['Arial', 'Verdana', 'Times New Roman', 'Courier New', 'Georgia', 'Palatino', 'Garamond', 'Bookman', 'Comic Sans MS', 'Trebuchet MS', 'Impact', 'Lucida Console', 'Tahoma', 'Lucida Grande', 'Segoe UI'];
            const shuffled = allFonts.sort(() => 0.5 - Math.random()).slice(0, Math.floor(Math.random() * 8) + 3);
            $('#fontsList').val(shuffled.join(', '));
            updateFingerprint();
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            if (typeof toastr !== 'undefined') {
                toastr.success(message);
            } else {
                alert('æˆåŠŸ: ' + message);
            }
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            if (typeof toastr !== 'undefined') {
                toastr.error(message);
            } else {
                alert('é”™è¯¯: ' + message);
            }
        }
    </script>

    <!-- Toastr CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <!-- Toastr JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
}
