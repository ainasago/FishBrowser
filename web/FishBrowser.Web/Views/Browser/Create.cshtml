@{
    var isModal = Context.Request.Query.ContainsKey("modal");
    var browserId = Context.Request.Query["id"].ToString();
    var isEdit = !string.IsNullOrEmpty(browserId);
    Layout = "_LayoutAdmin";
    ViewData["Title"] = isEdit ? "ç¼–è¾‘æµè§ˆå™¨" : "æ–°å»ºæµè§ˆå™¨";
}

@if (isModal)
{
    <style>
        .main-header, .main-sidebar, .content-wrapper > .content-header { display: none !important; }
        .content-wrapper { margin-left: 0 !important; }
        body { background: #f4f6f9; }
    </style>
}

<style>
    .section-header { font-size: 16px; font-weight: bold; margin-bottom: 12px; }
    .field-label { font-size: 12px; color: #666; margin-bottom: 4px; }
    .lock-btn { font-size: 16px; cursor: pointer; opacity: 0.3; transition: opacity 0.2s; }
    .lock-btn.locked { opacity: 1; color: #ff9800; }
    .score-card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .recommendation-item { padding: 4px 0; color: #666; font-size: 11px; }
    .recommendation-item:before { content: "â€¢ "; color: #ff9800; margin-right: 8px; }
</style>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <!-- å·¦ä¾§ï¼šç¼–è¾‘åŒº (2/3) -->
            <div class="col-md-8">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h3>
                    </div>
                    <div class="card-body" style="background: #f9f9f9;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="field-label">æµè§ˆå™¨åç§° <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="browserName" placeholder="è¾“å…¥æµè§ˆå™¨åç§°" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="field-label">æ‰€å±åˆ†ç»„</label>
                                    <select class="form-control" id="browserGroup">
                                        <option value="">æœªåˆ†ç»„</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="field-label">å¤‡æ³¨</label>
                            <textarea class="form-control" id="browserNotes" rows="2" placeholder="è¾“å…¥å¤‡æ³¨ä¿¡æ¯"></textarea>
                        </div>
                    </div>
                </div>

                <div class="card card-info">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="card-title mb-0">ğŸŒ æµè§ˆå™¨é…ç½®</h3>
                        <div class="custom-control custom-checkbox mb-0">
                            <input type="checkbox" class="custom-control-input" id="lockBrowserConfig">
                            <label class="custom-control-label" for="lockBrowserConfig">ğŸ“Œ å›ºå®šé…ç½®</label>
                        </div>
                    </div>
                    <div class="card-body" style="background: #f9f9f9;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="field-label">æµè§ˆå™¨å¼•æ“ <span class="text-danger">*</span></label>
                                    <select class="form-control" id="browserEngine">
                                        <option value="UndetectedChrome">UndetectedChrome (æ¨è)</option>
                                        <option value="Chromium">Chromium</option>
                                        <option value="Firefox">Firefox</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="field-label">æ“ä½œç³»ç»Ÿ <span class="text-danger">*</span></label>
                                    <select class="form-control" id="browserOS">
                                        <option value="Windows">Windows</option>
                                        <option value="MacOS">MacOS</option>
                                        <option value="Linux">Linux</option>
                                        <option value="Android">Android</option>
                                        <option value="iOS">iOS</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="field-label">å±å¹•åˆ†è¾¨ç‡</label>
                                    <select class="form-control" id="browserResolution">
                                        <option value="1920x1080">1920x1080 (æ¡Œé¢æ¨è)</option>
                                        <option value="1366x768">1366x768</option>
                                        <option value="1280x720">1280x720</option>
                                        <option value="2560x1440">2560x1440 (2K)</option>
                                        <option value="3840x2160">3840x2160 (4K)</option>
                                        <option value="390x844">390x844 (iPhone 13/14)</option>
                                        <option value="393x852">393x852 (iPhone 15)</option>
                                        <option value="428x926">428x926 (iPhone 14 Pro Max)</option>
                                        <option value="360x800">360x800 (Android å¸¸è§)</option>
                                        <option value="412x915">412x915 (Pixel 7)</option>
                                        <option value="1080x2400">1080x2400 (Android æ——èˆ°)</option>
                                        <option value="820x1180">820x1180 (iPad)</option>
                                        <option value="1024x1366">1024x1366 (iPad Pro)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="field-label">è¯­è¨€åŒºåŸŸ</label>
                                    <select class="form-control" id="browserLocale">
                                        <option value="zh-CN">zh-CN (ç®€ä½“ä¸­æ–‡)</option>
                                        <option value="en-US">en-US (ç¾å›½è‹±è¯­)</option>
                                        <option value="ja-JP">ja-JP (æ—¥æœ¬èª)</option>
                                        <option value="ko-KR">ko-KR (í•œêµ­ì–´)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="persistence" checked>
                                <label class="custom-control-label" for="persistence">å¯ç”¨ä¼šè¯æŒä¹…åŒ–ï¼ˆä¿å­˜ Cookieã€å†å²è®°å½•ç­‰ï¼‰</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æŒ‡çº¹ç‰¹å¾ -->
                <div class="card card-purple">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="card-title mb-0">ğŸ­ æŒ‡çº¹ç‰¹å¾</h3>
                        <div>
                            <button type="button" class="btn btn-sm btn-success mr-2" onclick="fullyRandomize()">
                                ğŸ² å®Œå…¨éšæœº
                            </button>
                            <button type="button" class="btn btn-sm btn-info" onclick="regenerate()">
                                ğŸ”„ é‡æ–°ç”Ÿæˆ
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="background: #f9f9f9;">
                        <!-- User-Agent -->
                        <div class="form-group">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="field-label mb-0">User-Agent</label>
                                <div>
                                    <span class="lock-btn" id="lockUA" onclick="toggleLock('lockUA')" title="å›ºå®šæ­¤é¡¹">ğŸ“Œ</span>
                                    <button type="button" class="btn btn-sm btn-outline-secondary ml-2" onclick="randomizeUA()">ğŸ”„</button>
                                </div>
                            </div>
                            <input type="text" class="form-control" id="userAgent" placeholder="æµè§ˆå™¨æ ‡è¯†">
                        </div>

                        <!-- Platform & Timezone -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="field-label">Platform</label>
                                    <input type="text" class="form-control" id="platform" value="Win32">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="field-label">Timezone</label>
                                    <input type="text" class="form-control" id="timezone" value="Asia/Shanghai">
                                </div>
                            </div>
                        </div>

                        <!-- ç¡¬ä»¶é…ç½® -->
                        <h6 class="font-weight-bold mt-3 mb-2">ç¡¬ä»¶é…ç½®</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="field-label">CPU æ ¸å¿ƒæ•°</label>
                                    <input type="number" class="form-control" id="cpuCores" value="8" min="1" max="128">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="field-label">å†…å­˜ (GB)</label>
                                    <input type="number" class="form-control" id="memory" value="8" min="1" max="256">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="field-label">è§¦æ‘¸ç‚¹æ•°</label>
                                    <input type="number" class="form-control" id="touchPoints" value="0" min="0">
                                </div>
                            </div>
                        </div>

                        <!-- WebGL é…ç½® -->
                        <div class="d-flex justify-content-between align-items-center mt-3 mb-2">
                            <h6 class="font-weight-bold mb-0">WebGL é…ç½®</h6>
                            <div>
                                <span class="lock-btn" id="lockWebGL" onclick="toggleLock('lockWebGL')" title="å›ºå®šæ­¤é¡¹">ğŸ“Œ å›ºå®š</span>
                                <button type="button" class="btn btn-sm btn-outline-secondary ml-2" onclick="randomizeWebGL()">ğŸ”„ éšæœº</button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="field-label">WebGL Vendor</label>
                                    <input type="text" class="form-control" id="webglVendor" placeholder="ä¾‹: Google Inc.">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="field-label">WebGL Renderer</label>
                                    <input type="text" class="form-control" id="webglRenderer" placeholder="ä¾‹: ANGLE (Intel HD Graphics)">
                                </div>
                            </div>
                        </div>

                        <!-- å­—ä½“åˆ—è¡¨ -->
                        <div class="d-flex justify-content-between align-items-center mt-3 mb-2">
                            <h6 class="font-weight-bold mb-0">å­—ä½“åˆ—è¡¨</h6>
                            <div>
                                <span class="lock-btn" id="lockFonts" onclick="toggleLock('lockFonts')" title="å›ºå®šæ­¤é¡¹">ğŸ“Œ å›ºå®š</span>
                                <button type="button" class="btn btn-sm btn-outline-secondary ml-2" onclick="randomizeFonts()">ğŸ”„ éšæœº</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <textarea class="form-control" id="fontsList" rows="2" readonly placeholder="å­—ä½“åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰"></textarea>
                            <small class="form-text text-muted" id="fontsCount">0 ä¸ªå­—ä½“</small>
                        </div>

                        <!-- é«˜çº§é€‰é¡¹ -->
                        <div class="mt-3">
                            <a data-toggle="collapse" href="#advancedOptions" role="button" aria-expanded="false">
                                <h6 class="font-weight-bold">ğŸ”§ é«˜çº§é€‰é¡¹ï¼ˆLanguages, Plugins, Sec-CH-UA ç­‰ï¼‰ <i class="fas fa-chevron-down"></i></h6>
                            </a>
                            <div class="collapse" id="advancedOptions">
                                <div class="mt-2">
                                    <div class="form-group">
                                        <label class="field-label">Languages JSON</label>
                                        <input type="text" class="form-control" id="languagesJson" placeholder='["zh-CN", "zh", "en-US", "en"]'>
                                    </div>
                                    <div class="form-group">
                                        <label class="field-label">Plugins JSON</label>
                                        <input type="text" class="form-control" id="pluginsJson" placeholder="[]">
                                    </div>
                                    <div class="form-group">
                                        <label class="field-label">Sec-CH-UA</label>
                                        <input type="text" class="form-control" id="secChUa">
                                    </div>
                                    <div class="form-group">
                                        <label class="field-label">Sec-CH-UA-Platform</label>
                                        <input type="text" class="form-control" id="secChUaPlatform">
                                    </div>
                                    <div class="form-group">
                                        <label class="field-label">Webdriver æ¨¡å¼</label>
                                        <select class="form-control" id="webdriverMode">
                                            <option value="undefined">undefined (æ¨è - å®Œå…¨ç§»é™¤)</option>
                                            <option value="true">true (ä¸çœŸå® Chrome ä¸€è‡´)</option>
                                            <option value="false">false (å¯èƒ½è¢«æ£€æµ‹)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä»£ç†é…ç½® -->
                <div class="card card-warning">
                    <div class="card-header">
                        <h3 class="card-title">ğŸŒ ä»£ç†é…ç½®</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="proxyMode">ä»£ç†æ¨¡å¼</label>
                            <select class="form-control" id="proxyMode">
                                <option value="none">æ— ä»£ç†</option>
                                <option value="api">API ä»£ç†</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="proxyUrl">ä»£ç†åœ°å€</label>
                            <input type="text" class="form-control" id="proxyUrl" placeholder="http://proxy.example.com:8080">
                        </div>
                    </div>
                </div>

                @if (!isModal)
                {
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="card">
                        <div class="card-body">
                            <button type="button" class="btn btn-primary" onclick="saveBrowser()">
                                <i class="fas fa-save"></i> @(isEdit ? "ä¿å­˜" : "åˆ›å»º")
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit()">
                                <i class="fas fa-times"></i> å–æ¶ˆ
                            </button>
                            @if (isEdit)
                            {
                                <button type="button" class="btn btn-danger float-right" onclick="deleteBrowserNow()">
                                    <i class="fas fa-trash"></i> åˆ é™¤
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>

            <!-- å³ä¾§ï¼šå®æ—¶é¢„è§ˆå’Œè¯„åˆ† (1/3) -->
            <div class="col-md-4" style="background: #fafafa; padding: 16px;">
                <h5 class="section-header">ğŸ“Š æŒ‡çº¹è¯„åˆ†</h5>
                
                <!-- æ€»ä½“è¯„åˆ† -->
                <div class="score-card">
                    <small class="text-muted">æ€»ä½“è¯„åˆ†</small>
                    <div class="d-flex align-items-center mt-2">
                        <div class="progress flex-grow-1" style="height: 24px;">
                            <div id="scoreBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                        </div>
                        <strong id="totalScore" class="ml-3" style="font-size: 20px;">0</strong>
                    </div>
                    <small id="riskLevel" class="text-muted mt-2 d-block">é£é™©ç­‰çº§: æœªè¯„ä¼°</small>
                </div>

                <!-- è¯¦ç»†è¯„åˆ† -->
                <h6 class="font-weight-bold mt-3 mb-2">ğŸ“ˆ è¯¦ç»†è¯„åˆ†</h6>
                
                <div class="bg-white border rounded p-2 mb-2">
                    <small class="text-muted">ä¸€è‡´æ€§æ£€æŸ¥</small>
                    <div class="progress mt-1" style="height: 16px;">
                        <div id="consistencyBar" class="progress-bar bg-success" style="width: 0%">
                            <small id="consistencyText">0</small>
                        </div>
                    </div>
                </div>

                <div class="bg-white border rounded p-2 mb-2">
                    <small class="text-muted">çœŸå®æ€§æ£€æŸ¥</small>
                    <div class="progress mt-1" style="height: 16px;">
                        <div id="realismBar" class="progress-bar bg-info" style="width: 0%">
                            <small id="realismText">0</small>
                        </div>
                    </div>
                </div>

                <div class="bg-white border rounded p-2 mb-3">
                    <small class="text-muted">Cloudflare é£é™© (è¶Šä½è¶Šå¥½)</small>
                    <div class="progress mt-1" style="height: 16px;">
                        <div id="cloudflareBar" class="progress-bar bg-danger" style="width: 0%">
                            <small id="cloudflareText">0</small>
                        </div>
                    </div>
                </div>

                <!-- ä¼˜åŒ–å»ºè®® -->
                <h6 class="font-weight-bold mt-3 mb-2">ğŸ’¡ ä¼˜åŒ–å»ºè®®</h6>
                <div class="bg-white border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                    <div id="recommendations">
                        <small class="text-muted">é…ç½®æŒ‡çº¹åå°†æ˜¾ç¤ºå»ºè®®</small>
                    </div>
                </div>

                <!-- æŒ‡çº¹é¢„è§ˆ -->
                <h6 class="font-weight-bold mt-3 mb-2">ğŸ” æŒ‡çº¹é¢„è§ˆ</h6>
                <div class="bg-white border rounded p-2" style="max-height: 250px; overflow-y: auto;">
                    <pre id="fingerprintPreview" style="font-size: 10px; margin: 0; font-family: Consolas, monospace;"></pre>
                </div>

                <!-- å¿«é€Ÿæ“ä½œ (ä¿ç•™) -->
                <h6 class="font-weight-bold mt-3 mb-2">âš¡ å¿«é€Ÿæ“ä½œ</h6>
                <button type="button" class="btn btn-block btn-success btn-sm mb-2" onclick="randomizeUA()">
                    <i class="fas fa-random"></i> éšæœº User Agent
                </button>
                <button type="button" class="btn btn-block btn-info btn-sm mb-2" onclick="randomizeWebGL()">
                    <i class="fas fa-random"></i> éšæœº WebGL
                </button>
                <button type="button" class="btn btn-block btn-warning btn-sm" onclick="randomizeFonts()">
                    <i class="fas fa-random"></i> éšæœºå­—ä½“
                </button>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        // ç¼–è¾‘æ¨¡å¼
        const isEditMode = @(isEdit ? "true" : "false");
        const browserId = '@browserId';

        // é”å®šçŠ¶æ€
        const locks = {
            lockUA: false,
            lockWebGL: false,
            lockFonts: false,
            lockBrowserConfig: false
        };

        $(document).ready(function() {
            loadGroups().then(() => {
                if (isEditMode && browserId) {
                    loadBrowserData(browserId);
                } else {
                    // æ–°å»ºæ¨¡å¼ï¼šç”Ÿæˆé»˜è®¤éšæœºæŒ‡çº¹
                    fullyRandomize();
                }
            });
            
            // ç›‘å¬æŒ‡çº¹å­—æ®µå˜åŒ–
            $('#userAgent, #platform, #cpuCores, #memory, #touchPoints, #webglVendor, #webglRenderer, #fontsList, #timezone, #languagesJson, #pluginsJson, #secChUa').on('change keyup', function() {
                updateFingerprint();
            });

            // ç›‘å¬ OS å˜åŒ–ï¼ˆé‡æ–°ç”ŸæˆæŒ‡çº¹ï¼‰
            $('#browserOS').on('change', async function() {
                await generateFingerprintBasedOnConfig();
            });

            // ç›‘å¬ Locale å˜åŒ–ï¼ˆé‡æ–°ç”ŸæˆæŒ‡çº¹ï¼‰
            $('#browserLocale').on('change', async function() {
                await generateFingerprintBasedOnConfig();
            });

            // å¯åŠ¨å®æ—¶æ ¡éªŒï¼ˆæ¯ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
            setInterval(updateFingerprint, 1000);
        });

        // åˆ‡æ¢é”å®šçŠ¶æ€
        function toggleLock(lockId) {
            locks[lockId] = !locks[lockId];
            const element = document.getElementById(lockId);
            if (locks[lockId]) {
                element.classList.add('locked');
            } else {
                element.classList.remove('locked');
            }
        }

        // é‡æ–°ç”Ÿæˆï¼ˆåŸºäºå½“å‰é…ç½®ï¼‰
        function regenerate() {
            if (!locks.lockUA) randomizeUA();
            if (!locks.lockWebGL) randomizeWebGL();
            if (!locks.lockFonts) randomizeFonts();
            updateFingerprint();
            showSuccess('æŒ‡çº¹å·²é‡æ–°ç”Ÿæˆ');
        }

        // åŠ è½½åˆ†ç»„
        function loadGroups() {
            return $.ajax({
                url: '@Url.Action("GetGroups", "Browser")',
                method: 'GET',
                success: function(response) {
                    console.log('åˆ†ç»„å“åº”:', response);
                    const select = $('#browserGroup');
                    
                    // å¤„ç† API è¿”å›çš„æ•°æ®æ ¼å¼
                    let groups = [];
                    if (response && response.success && response.data) {
                        groups = response.data;
                    } else if (response && Array.isArray(response)) {
                        groups = response;
                    }
                    
                    if (groups && groups.length > 0) {
                        groups.forEach(function(group) {
                            select.append(`<option value="${group.id}">${group.name}</option>`);
                        });
                    }
                },
                error: function(xhr) {
                    console.error('åŠ è½½åˆ†ç»„å¤±è´¥:', xhr);
                    showError('åŠ è½½åˆ†ç»„å¤±è´¥');
                }
            });
        }

        // åŠ è½½æµè§ˆå™¨æ•°æ®ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
        function loadBrowserData(id) {
            $.ajax({
                url: '@Url.Action("GetBrowserDetail")' + '?id=' + id,
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        const data = response.data;
                        
                        // åŸºæœ¬ä¿¡æ¯
                        $('#browserName').val(data.name || '');
                        $('#browserNotes').val(data.notes || '');
                        $('#browserGroup').val(data.groupId || '');
                        
                        // æµè§ˆå™¨é…ç½®
                        $('#browserEngine').val(data.engine || 'UndetectedChrome');
                        $('#browserOS').val(data.os || 'Windows');
                        $('#browserResolution').val((data.viewportWidth || 1920) + 'x' + (data.viewportHeight || 1080));
                        $('#browserLocale').val(data.locale || 'zh-CN');
                        $('#persistence').prop('checked', data.enablePersistence !== false);
                        
                        // æŒ‡çº¹ç‰¹å¾
                        $('#userAgent').val(data.userAgent || '');
                        $('#platform').val(data.platform || 'Win32');
                        $('#timezone').val(data.timezone || 'Asia/Shanghai');
                        $('#cpuCores').val(data.hardwareConcurrency || 8);
                        $('#memory').val(data.deviceMemory || 8);
                        $('#touchPoints').val(data.maxTouchPoints || 0);
                        $('#webglVendor').val(data.webglVendor || '');
                        $('#webglRenderer').val(data.webglRenderer || '');
                        
                        // å­—ä½“åˆ—è¡¨
                        if (data.fontsJson) {
                            try {
                                const fonts = JSON.parse(data.fontsJson);
                                $('#fontsList').val(fonts.join(', '));
                            } catch (e) {
                                $('#fontsList').val('');
                            }
                        }
                        
                        // ä»£ç†é…ç½®
                        $('#proxyMode').val(data.proxyMode || 'none');
                        $('#proxyUrl').val(data.proxyApiUrl || '');
                        
                        // æ›´æ–°æŒ‡çº¹è¯„åˆ†
                        updateFingerprint();
                    } else {
                        showError(response.error || 'åŠ è½½å¤±è´¥');
                    }
                },
                error: function() {
                    showError('åŠ è½½æµè§ˆå™¨ä¿¡æ¯å¤±è´¥');
                }
            });
        }

        // ä¿å­˜æµè§ˆå™¨
        function saveBrowser() {
            // è§£æåˆ†è¾¨ç‡
            const resolution = $('#browserResolution').val().split('x');
            const viewportWidth = parseInt(resolution[0]) || 1920;
            const viewportHeight = parseInt(resolution[1]) || 1080;
            
            // è§£æå­—ä½“åˆ—è¡¨ä¸º JSON
            const fontsText = $('#fontsList').val();
            const fontsArray = fontsText ? fontsText.split(',').map(f => f.trim()).filter(f => f) : [];
            const fontsJson = JSON.stringify(fontsArray);
            
            const data = {
                name: $('#browserName').val(),
                notes: $('#browserNotes').val(),
                groupId: parseInt($('#browserGroup').val()) || null,
                // æµè§ˆå™¨é…ç½®
                engine: $('#browserEngine').val(),
                os: $('#browserOS').val(),
                viewportWidth: viewportWidth,
                viewportHeight: viewportHeight,
                locale: $('#browserLocale').val(),
                timezone: $('#timezone').val(),
                enablePersistence: $('#persistence').is(':checked'),
                headless: $('#headless').is(':checked'),
                // æŒ‡çº¹ç‰¹å¾
                userAgent: $('#userAgent').val(),
                platform: $('#platform').val(),
                hardwareConcurrency: parseInt($('#cpuCores').val()) || 8,
                deviceMemory: parseInt($('#memory').val()) || 8,
                maxTouchPoints: parseInt($('#touchPoints').val()) || 0,
                webGLVendor: $('#webglVendor').val(),
                webGLRenderer: $('#webglRenderer').val(),
                fontsJson: fontsJson,
                languagesJson: $('#languagesJson').val(),
                pluginsJson: $('#pluginsJson').val(),
                secChUa: $('#secChUa').val(),
                secChUaPlatform: $('#secChUaPlatform').val(),
                // ä»£ç†é…ç½®
                proxyMode: $('#proxyMode').val(),
                proxyApiUrl: $('#proxyUrl').val()
            };

            const url = isEditMode ? '@Url.Action("UpdateBrowser")' + '?id=' + browserId : '@Url.Action("CreateBrowser")';
            const method = isEditMode ? 'PUT' : 'POST';
            const successMsg = isEditMode ? 'ä¿å­˜æˆåŠŸ' : 'æµè§ˆå™¨åˆ›å»ºæˆåŠŸ';

            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.success) {
                        showSuccess(successMsg);
                        // é€šçŸ¥çˆ¶çª—å£ä¿å­˜æˆåŠŸ
                        if (window.parent !== window) {
                            window.parent.postMessage({
                                type: 'browserSaved',
                                message: successMsg
                            }, '*');
                        } else {
                            // å¦‚æœä¸åœ¨ iframe ä¸­ï¼Œè·³è½¬åˆ°åˆ—è¡¨é¡µ
                            setTimeout(() => {
                                window.location.href = '@Url.Action("Index")';
                            }, 1000);
                        }
                    } else {
                        showError(response.error || (isEditMode ? 'ä¿å­˜å¤±è´¥' : 'åˆ›å»ºå¤±è´¥'));
                    }
                },
                error: function() {
                    showError(isEditMode ? 'ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' : 'åˆ›å»ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            });
        }

        // æ›´æ–°æŒ‡çº¹è¯„åˆ†ï¼ˆä¸ WPF é€»è¾‘å®Œå…¨ä¸€è‡´ï¼‰
        function updateFingerprint() {
            try {
                // åˆ›å»ºä¸´æ—¶ Profile ç”¨äºæ ¡éªŒ
                const tempProfile = {
                    userAgent: $('#userAgent').val() || '',
                    platform: $('#platform').val() || '',
                    timezone: $('#timezone').val() || '',
                    locale: $('#browserLocale').val() || 'zh-CN',
                    hardwareConcurrency: parseInt($('#cpuCores').val()) || 8,
                    deviceMemory: parseInt($('#memory').val()) || 8,
                    maxTouchPoints: parseInt($('#touchPoints').val()) || 0,
                    webglVendor: $('#webglVendor').val() || '',
                    webglRenderer: $('#webglRenderer').val() || '',
                    languagesJson: $('#languagesJson').val() || '',
                    pluginsJson: $('#pluginsJson').val() || '',
                    secChUa: $('#secChUa').val() || '',
                    secChUaPlatform: $('#secChUaPlatform').val() || ''
                };

                // ä¸€è‡´æ€§æ£€æŸ¥
                const consistencyScore = checkConsistency(tempProfile);
                $('#consistencyBar').css('width', consistencyScore + '%');
                $('#consistencyText').text(consistencyScore);

                // çœŸå®æ€§æ£€æŸ¥
                const realismScore = checkRealism(tempProfile);
                $('#realismBar').css('width', realismScore + '%');
                $('#realismText').text(realismScore);

                // Cloudflare é£é™©æ£€æŸ¥
                const cloudflareRisk = checkCloudflareRisk(tempProfile);
                $('#cloudflareBar').css('width', cloudflareRisk + '%');
                $('#cloudflareText').text(cloudflareRisk);

                // è®¡ç®—æ€»åˆ†
                const totalScore = Math.round((consistencyScore + realismScore + (100 - cloudflareRisk)) / 3);
                $('#totalScore').text(totalScore);
                $('#scoreBar').css('width', totalScore + '%');

                // é£é™©ç­‰çº§
                let riskLevel = 'æœªè¯„ä¼°';
                if (totalScore >= 90) {
                    riskLevel = 'âœ… å®‰å…¨';
                } else if (totalScore >= 70) {
                    riskLevel = 'âš ï¸ ä½é£é™©';
                } else if (totalScore >= 50) {
                    riskLevel = 'âš ï¸ ä¸­é£é™©';
                } else {
                    riskLevel = 'âŒ é«˜é£é™©';
                }
                $('#riskLevel').text('é£é™©ç­‰çº§: ' + riskLevel);

                // ç”Ÿæˆå»ºè®®
                const recommendations = generateRecommendations(tempProfile, consistencyScore, realismScore, cloudflareRisk);
                if (recommendations.length > 0) {
                    $('#recommendations').html(recommendations.map(r => `<div class="recommendation-item">${r}</div>`).join(''));
                } else {
                    $('#recommendations').html('<small class="text-success">âœ… æŒ‡çº¹é…ç½®è‰¯å¥½ï¼Œæ— éœ€ä¼˜åŒ–</small>');
                }

                // æ›´æ–°æŒ‡çº¹é¢„è§ˆ
                const fontCount = tempProfile.languagesJson ? tempProfile.languagesJson.split(',').filter(f => f.trim()).length : 0;
                const preview = `User-Agent: ${tempProfile.userAgent}
Platform: ${tempProfile.platform}
Timezone: ${tempProfile.timezone}
Locale: ${tempProfile.locale}
Hardware: ${tempProfile.hardwareConcurrency} cores, ${tempProfile.deviceMemory} GB
WebGL: ${tempProfile.webglVendor}
  Renderer: ${tempProfile.webglRenderer}
Touch Points: ${tempProfile.maxTouchPoints}${tempProfile.secChUa ? '\nSec-CH-UA: ' + tempProfile.secChUa : ''}`;
                $('#fingerprintPreview').text(preview);

                // æ›´æ–°å­—ä½“è®¡æ•°
                const fonts = $('#fontsList').val();
                const fontsCount = fonts ? fonts.split(',').filter(f => f.trim()).length : 0;
                $('#fontsCount').text(fontsCount + ' ä¸ªå­—ä½“');
            } catch (ex) {
                console.error('æ ¡éªŒå¤±è´¥:', ex);
            }
        }

        // ä¸€è‡´æ€§æ£€æŸ¥ï¼ˆä¸ WPF é€»è¾‘å®Œå…¨ä¸€è‡´ï¼‰
        function checkConsistency(profile) {
            const checks = [];

            // UAä¸Platformä¸€è‡´æ€§ï¼ˆæ™ºèƒ½æ£€æŸ¥ï¼‰
            let uaPlatformMatch = false;
            if (profile.platform === 'Win32' && profile.userAgent.toLowerCase().includes('windows'))
                uaPlatformMatch = true;
            else if (profile.platform === 'MacIntel' && profile.userAgent.toLowerCase().includes('macintosh'))
                uaPlatformMatch = true;
            else if (profile.platform.toLowerCase().includes('linux') && profile.userAgent.toLowerCase().includes('linux'))
                uaPlatformMatch = true;
            else if (profile.userAgent.toLowerCase().includes('android'))
                uaPlatformMatch = true;
            else if (profile.userAgent.toLowerCase().includes('iphone') || profile.userAgent.toLowerCase().includes('ipad'))
                uaPlatformMatch = true;
            checks.push(uaPlatformMatch);

            // Platformä¸SecChUAä¸€è‡´æ€§
            checks.push(!profile.secChUaPlatform || profile.secChUaPlatform.toLowerCase().includes(profile.platform.toLowerCase()));

            // Localeä¸Languagesä¸€è‡´æ€§
            checks.push(!profile.languagesJson || profile.languagesJson.toLowerCase().includes(profile.locale.toLowerCase()));

            const passedChecks = checks.filter(c => c).length;
            return Math.round((passedChecks * 100) / checks.length);
        }

        // çœŸå®æ€§æ£€æŸ¥ï¼ˆä¸ WPF é€»è¾‘å®Œå…¨ä¸€è‡´ï¼‰
        function checkRealism(profile) {
            const scores = [];

            // Chromeç‰ˆæœ¬æ£€æŸ¥ï¼ˆ120-141 éƒ½æ˜¯æœ‰æ•ˆçš„ç°ä»£ç‰ˆæœ¬ï¼‰
            const chromeVersion = extractChromeVersion(profile.userAgent);
            if (chromeVersion) {
                if (chromeVersion >= 120 && chromeVersion <= 141)
                    scores.push(100); // æœ€æ–°ç‰ˆæœ¬
                else if (chromeVersion >= 100 && chromeVersion < 120)
                    scores.push(85); // è¾ƒæ–°ç‰ˆæœ¬
                else if (chromeVersion >= 80 && chromeVersion < 100)
                    scores.push(70); // æ—§ç‰ˆæœ¬
                else
                    scores.push(50); // è¿‡æ—¶ç‰ˆæœ¬
            } else {
                scores.push(60); // æ— æ³•è¯†åˆ«ç‰ˆæœ¬
            }

            // ç¡¬ä»¶é…ç½®æ£€æŸ¥
            scores.push((profile.hardwareConcurrency >= 8 && profile.hardwareConcurrency <= 16) ? 100 : 70);

            // GPUæ£€æŸ¥
            scores.push(profile.webglVendor ? 100 : 50);

            // é˜²æ£€æµ‹æ•°æ®æ£€æŸ¥
            scores.push((profile.pluginsJson && profile.languagesJson && profile.secChUa) ? 100 : 60);

            return Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
        }

        // Cloudflare é£é™©æ£€æŸ¥ï¼ˆä¸ WPF é€»è¾‘å®Œå…¨ä¸€è‡´ï¼‰
        function checkCloudflareRisk(profile) {
            let risk = 0;

            // HeadlessChromeæ ‡å¿—
            if (profile.userAgent.toLowerCase().includes('headlesschrome'))
                risk += 30;

            // é˜²æ£€æµ‹æ•°æ®ç¼ºå¤±
            if (!profile.pluginsJson) risk += 20;
            if (!profile.languagesJson) risk += 20;
            if (!profile.secChUa) risk += 20;

            // è§¦æ‘¸ç‚¹æ•°å¼‚å¸¸ï¼ˆæ¡Œé¢è®¾å¤‡ä¸åº”æœ‰è§¦æ‘¸ç‚¹ï¼‰
            if (profile.maxTouchPoints > 0 && !profile.userAgent.toLowerCase().includes('mobile')) 
                risk += 10;

            return Math.min(risk, 100);
        }

        // ç”Ÿæˆå»ºè®®ï¼ˆä¸ WPF é€»è¾‘å®Œå…¨ä¸€è‡´ï¼‰
        function generateRecommendations(profile, consistency, realism, risk) {
            const recommendations = [];

            if (consistency < 90)
                recommendations.push('ä¸€è‡´æ€§è¾ƒä½ï¼šæ£€æŸ¥ UAã€Platformã€Locale æ˜¯å¦åŒ¹é…');

            if (realism < 80)
                recommendations.push('çœŸå®æ€§ä¸è¶³ï¼šå»ºè®®ä½¿ç”¨ Chrome 141+ ç‰ˆæœ¬');

            if (!profile.webglVendor)
                recommendations.push('ç¼ºå°‘ WebGL é…ç½®ï¼šå»ºè®®æ·»åŠ  GPU ä¿¡æ¯');

            if (!profile.pluginsJson)
                recommendations.push('ç¼ºå°‘ Plugins æ•°æ®ï¼šç‚¹å‡»ã€Œå®Œå…¨éšæœºã€ç”Ÿæˆ');

            if (risk > 30)
                recommendations.push('Cloudflare é£é™©è¾ƒé«˜ï¼šæ£€æŸ¥é˜²æ£€æµ‹æ•°æ®å®Œæ•´æ€§');

            if (profile.maxTouchPoints > 0 && !profile.userAgent.toLowerCase().includes('mobile'))
                recommendations.push('æ¡Œé¢è®¾å¤‡è§¦æ‘¸ç‚¹åº”ä¸º 0');

            return recommendations;
        }

        // ä» User-Agent æå– Chrome ç‰ˆæœ¬å·
        function extractChromeVersion(userAgent) {
            try {
                const match = userAgent.match(/Chrome\/(\d+)\./);
                if (match && match[1]) {
                    return parseInt(match[1]);
                }
            } catch (ex) {}
            return null;
        }

        // å®Œå…¨éšæœºï¼ˆä¸ WPF é€»è¾‘å®Œå…¨ä¸€è‡´ï¼‰
        async function fullyRandomize() {
            try {
                // æ£€æŸ¥æ˜¯å¦å›ºå®šæµè§ˆå™¨é…ç½®
                if (!$('#lockBrowserConfig').is(':checked')) {
                    // éšæœºé€‰æ‹©æ“ä½œç³»ç»Ÿï¼ˆåŒ…æ‹¬ç§»åŠ¨ç«¯ï¼‰
                    const osList = ['Windows', 'MacOS', 'Linux', 'Android', 'iOS'];
                    const selectedOS = osList[Math.floor(Math.random() * osList.length)];
                    $('#browserOS').val(selectedOS);

                    // æ ¹æ®æ“ä½œç³»ç»Ÿéšæœºé€‰æ‹©åˆé€‚çš„åˆ†è¾¨ç‡
                    let resolutions;
                    if (selectedOS === 'Android') {
                        resolutions = ['360x800', '412x915', '1080x2400'];
                    } else if (selectedOS === 'iOS') {
                        resolutions = ['390x844', '393x852', '428x926', '820x1180', '1024x1366'];
                    } else {
                        resolutions = ['1920x1080', '1366x768', '1280x720', '2560x1440', '3840x2160'];
                    }
                    const selectedRes = resolutions[Math.floor(Math.random() * resolutions.length)];
                    $('#browserResolution').val(selectedRes);

                    // éšæœºé€‰æ‹©è¯­è¨€
                    const locales = ['zh-CN', 'en-US', 'ja-JP', 'ko-KR'];
                    const selectedLocale = locales[Math.floor(Math.random() * locales.length)];
                    $('#browserLocale').val(selectedLocale);
                }

                // è·å–å½“å‰æ“ä½œç³»ç»Ÿ
                const os = $('#browserOS').val();

                // ç”ŸæˆåŸºç¡€æŒ‡çº¹
                await generateFingerprintBasedOnConfig();

                // è°ƒç”¨ç‹¬ç«‹çš„éšæœºåŠŸèƒ½ï¼ˆæ£€æŸ¥å›ºå®šçŠ¶æ€ï¼‰
                if (!locks.lockUA) {
                    await randomizeUA();
                }

                if (!locks.lockWebGL) {
                    await randomizeWebGL();
                }

                if (!locks.lockFonts) {
                    await randomizeFonts();
                }

                updateFingerprint();
                showSuccess('âœ… å·²ç”Ÿæˆå®Œå…¨éšæœºæŒ‡çº¹');
            } catch (ex) {
                console.error('ç”ŸæˆéšæœºæŒ‡çº¹å¤±è´¥:', ex);
                showError('ç”ŸæˆéšæœºæŒ‡çº¹å¤±è´¥: ' + ex.message);
            }
        }

        // åŸºäºé…ç½®ç”ŸæˆæŒ‡çº¹ï¼ˆä¸ WPF é€»è¾‘å®Œå…¨ä¸€è‡´ï¼‰
        async function generateFingerprintBasedOnConfig() {
            try {
                const os = $('#browserOS').val();
                const locale = $('#browserLocale').val();
                const resolution = $('#browserResolution').val().split('x');
                const width = parseInt(resolution[0]) || 1920;
                const height = parseInt(resolution[1]) || 1080;

                // ç”Ÿæˆ User-Agentï¼ˆä½¿ç”¨çœŸå® Chrome ç‰ˆæœ¬ï¼‰
                const chromeVersion = 141;
                const userAgent = generateUserAgent(os, chromeVersion);
                $('#userAgent').val(userAgent);

                // ç”Ÿæˆ Platform
                const platform = {
                    'Windows': 'Win32',
                    'MacOS': 'MacIntel',
                    'Linux': 'Linux x86_64',
                    'Android': 'Linux armv8l',
                    'iOS': 'iPhone'
                }[os] || 'Win32';
                $('#platform').val(platform);

                // ç”Ÿæˆ Timezone
                const timezone = {
                    'zh-CN': 'Asia/Shanghai',
                    'en-US': 'America/New_York',
                    'ja-JP': 'Asia/Tokyo',
                    'ko-KR': 'Asia/Seoul'
                }[locale] || 'Asia/Shanghai';
                $('#timezone').val(timezone);

                // ç”Ÿæˆç¡¬ä»¶é…ç½®ï¼ˆæ ¹æ® OS ä½¿ç”¨çœŸå®é…ç½®ï¼‰
                if (os === 'iOS') {
                    const iosCores = [4, 6];
                    const iosMemory = [4, 6, 8];
                    $('#cpuCores').val(iosCores[Math.floor(Math.random() * iosCores.length)]);
                    $('#memory').val(iosMemory[Math.floor(Math.random() * iosMemory.length)]);
                    $('#touchPoints').val(5);
                } else if (os === 'Android') {
                    const androidCores = [4, 6, 8];
                    const androidMemory = [4, 6, 8, 12];
                    $('#cpuCores').val(androidCores[Math.floor(Math.random() * androidCores.length)]);
                    $('#memory').val(androidMemory[Math.floor(Math.random() * androidMemory.length)]);
                    $('#touchPoints').val(Math.floor(Math.random() * 6) + 5);
                } else {
                    const commonCores = [4, 6, 8, 12, 16];
                    const commonMemory = [8, 16, 32];
                    $('#cpuCores').val(commonCores[Math.floor(Math.random() * commonCores.length)]);
                    $('#memory').val(commonMemory[Math.floor(Math.random() * commonMemory.length)]);
                    $('#touchPoints').val(0);
                }

                // WebGL é…ç½®ï¼ˆå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨æ•°æ®åº“éšæœºç”Ÿæˆï¼‰
                if (!$('#webglVendor').val() || !$('#webglRenderer').val()) {
                    await randomizeWebGL();
                }

                // ç”Ÿæˆé˜²æ£€æµ‹æ•°æ®
                await generateAntiDetectionData();

                updateFingerprint();
            } catch (ex) {
                console.error('ç”ŸæˆæŒ‡çº¹å¤±è´¥:', ex);
                showError('ç”ŸæˆæŒ‡çº¹å¤±è´¥: ' + ex.message);
            }
        }

        // ç”Ÿæˆ User-Agent
        function generateUserAgent(os, chromeVersion) {
            const templates = {
                'Windows': `Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/${chromeVersion}.0.0.0 Safari/537.36`,
                'MacOS': `Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/${chromeVersion}.0.0.0 Safari/537.36`,
                'Linux': `Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/${chromeVersion}.0.0.0 Safari/537.36`,
                'Android': `Mozilla/5.0 (Linux; Android 13; SM-S901B) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/${chromeVersion}.0.0.0 Mobile Safari/537.36`,
                'iOS': `Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1`
            };
            return templates[os] || templates['Windows'];
        }

        // éšæœº User Agentï¼ˆä½¿ç”¨çœŸå®çš„ Chrome ç‰ˆæœ¬æ•°æ®åº“ï¼‰
        async function randomizeUA() {
            try {
                const os = $('#browserOS').val();
                
                const response = await $.ajax({
                    url: '@Url.Action("GetChromeVersion", "FingerprintData")?os=' + os,
                    method: 'GET'
                });

                if (response.success && response.data) {
                    const chromeVersion = response.data.version;
                    const userAgent = generateUserAgent(os, chromeVersion.split('.')[0]);
                    $('#userAgent').val(userAgent);
                    updateFingerprint();
                } else {
                    throw new Error(response.error || 'è·å– Chrome ç‰ˆæœ¬å¤±è´¥');
                }
            } catch (ex) {
                console.error('éšæœº UA å¤±è´¥:', ex);
                showError('éšæœº User-Agent å¤±è´¥');
            }
        }

        // éšæœº WebGLï¼ˆä½¿ç”¨ GPU æ•°æ®åº“ï¼‰
        async function randomizeWebGL() {
            try {
                const os = $('#browserOS').val();
                
                const response = await $.ajax({
                    url: '@Url.Action("GetGpu", "FingerprintData")?os=' + os + '&count=1',
                    method: 'GET'
                });

                if (response.success && response.data && response.data.length > 0) {
                    const gpu = response.data[0];
                    $('#webglVendor').val(gpu.vendor);
                    $('#webglRenderer').val(gpu.renderer);
                    updateFingerprint();
                } else {
                    throw new Error(response.error || 'è·å– GPU é…ç½®å¤±è´¥');
                }
            } catch (ex) {
                console.error('éšæœº WebGL å¤±è´¥:', ex);
                showError('éšæœº WebGL å¤±è´¥');
            }
        }

        // éšæœºå­—ä½“ï¼ˆä½¿ç”¨å­—ä½“æœåŠ¡ï¼‰
        async function randomizeFonts() {
            try {
                const os = $('#browserOS').val();
                const osKey = os.toLowerCase();
                const count = Math.floor(Math.random() * 21) + 30; // 30-50
                
                const response = await $.ajax({
                    url: '@Url.Action("GetFonts", "FingerprintData")?os=' + osKey + '&count=' + count,
                    method: 'GET'
                });

                if (response.success && response.data) {
                    $('#fontsList').val(response.data.join(', '));
                    updateFingerprint();
                } else {
                    throw new Error(response.error || 'è·å–å­—ä½“åˆ—è¡¨å¤±è´¥');
                }
            } catch (ex) {
                console.error('éšæœºå­—ä½“å¤±è´¥:', ex);
                showError('éšæœºå­—ä½“å¤±è´¥');
            }
        }

        // ç”Ÿæˆé˜²æ£€æµ‹æ•°æ®ï¼ˆLanguages, Plugins, Sec-CH-UA ç­‰ï¼‰
        async function generateAntiDetectionData() {
            try {
                const requestData = {
                    userAgent: $('#userAgent').val(),
                    platform: $('#platform').val(),
                    locale: $('#browserLocale').val(),
                    hardwareConcurrency: parseInt($('#cpuCores').val()) || 8,
                    deviceMemory: parseInt($('#memory').val()) || 8,
                    maxTouchPoints: parseInt($('#touchPoints').val()) || 0
                };

                const response = await $.ajax({
                    url: '@Url.Action("GenerateAntiDetection", "FingerprintData")',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(requestData)
                });

                if (response.success && response.data) {
                    $('#languagesJson').val(response.data.languagesJson || '');
                    $('#pluginsJson').val(response.data.pluginsJson || '');
                    $('#secChUa').val(response.data.secChUa || '');
                    $('#secChUaPlatform').val(response.data.secChUaPlatform || '');
                }
            } catch (ex) {
                console.error('ç”Ÿæˆé˜²æ£€æµ‹æ•°æ®å¤±è´¥:', ex);
            }
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            if (typeof toastr !== 'undefined') {
                toastr.success(message);
            } else {
                alert('æˆåŠŸ: ' + message);
            }
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            if (typeof toastr !== 'undefined') {
                toastr.error(message);
            } else {
                alert('é”™è¯¯: ' + message);
            }
        }

        // åˆ é™¤æµè§ˆå™¨
        function deleteBrowserNow() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæµè§ˆå™¨å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) return;

            $.ajax({
                url: '@Url.Action("DeleteBrowser")' + '?id=' + browserId,
                method: 'DELETE',
                success: function(data) {
                    if (data.success) {
                        showSuccess('åˆ é™¤æˆåŠŸ');
                        // é€šçŸ¥çˆ¶çª—å£åˆ é™¤æˆåŠŸ
                        if (window.parent !== window) {
                            window.parent.postMessage({
                                type: 'browserSaved',
                                message: 'åˆ é™¤æˆåŠŸ'
                            }, '*');
                        } else {
                            // å¦‚æœä¸åœ¨ iframe ä¸­ï¼Œè·³è½¬åˆ°åˆ—è¡¨é¡µ
                            setTimeout(() => {
                                window.location.href = '@Url.Action("Index")';
                            }, 1000);
                        }
                    } else {
                        showError(data.error || 'åˆ é™¤å¤±è´¥');
                    }
                },
                error: function() {
                    showError('åˆ é™¤å¤±è´¥');
                }
            });
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEdit() {
            if (window.parent !== window) {
                // åœ¨ iframe ä¸­ï¼Œé€šçŸ¥çˆ¶çª—å£å…³é—­
                window.parent.postMessage({ type: 'browserSaved' }, '*');
            } else {
                // ä¸åœ¨ iframe ä¸­ï¼Œç›´æ¥è·³è½¬
                window.location.href = '@Url.Action("Index")';
            }
        }
    </script>

    <!-- Toastr CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <!-- Toastr JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
}
