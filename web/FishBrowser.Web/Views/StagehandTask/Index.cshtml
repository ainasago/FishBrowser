@{
    ViewData["Title"] = "Stagehand AI ä»»åŠ¡";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<style>
    .stagehand-container {
        display: flex;
        height: calc(100vh - 120px);
        gap: 20px;
    }

    .chat-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .script-section {
        width: 420px;
        display: flex;
        flex-direction: column;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .section-header {
        padding: 16px 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .status-ready {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .status-warning {
        background: #fff3e0;
        color: #e65100;
    }

    .status-error {
        background: #ffebee;
        color: #c62828;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }

    .message {
        margin-bottom: 16px;
        animation: fadeIn 0.3s;
    }

    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .message-user {
        display: flex;
        justify-content: flex-end;
    }

    .message-ai {
        display: flex;
        justify-content: flex-start;
    }

    .message-system {
        display: flex;
        justify-content: center;
    }

    .message-bubble {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 12px;
        word-wrap: break-word;
    }

    .message-user .message-bubble {
        background: #10a37f;
        color: white;
    }

    .message-ai .message-bubble {
        background: #f3f4f6;
        color: #333;
    }

    .message-system .message-bubble {
        background: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #81c784;
        max-width: 90%;
    }

    .examples-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;
        margin: 16px 20px;
    }

    .example-card {
        padding: 12px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .example-card:hover {
        border-color: #10a37f;
        background: #f8f9fa;
    }

    .example-icon {
        font-size: 24px;
        margin-bottom: 8px;
    }

    .example-name {
        font-weight: 600;
        margin-bottom: 4px;
    }

    .example-desc {
        font-size: 12px;
        color: #666;
    }

    .chat-input-area {
        padding: 16px 20px;
        border-top: 1px solid #e0e0e0;
    }

    .input-wrapper {
        display: flex;
        gap: 12px;
        align-items: flex-end;
    }

    .input-box {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid #e0e0e0;
        border-radius: 24px;
        resize: none;
        max-height: 120px;
        font-family: inherit;
    }

    .send-btn {
        padding: 12px 24px;
        background: #10a37f;
        color: white;
        border: none;
        border-radius: 24px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s;
    }

    .send-btn:hover {
        background: #0d8b6d;
    }

    .send-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .script-preview {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
    }

    .code-editor {
        width: 100%;
        height: 100%;
        padding: 16px;
        background: #1e1e1e;
        color: #d4d4d4;
        border: none;
        border-radius: 8px;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 13px;
        resize: none;
    }

    .script-info {
        padding: 16px;
        background: #f8f9fa;
        border-top: 1px solid #e0e0e0;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 13px;
    }

    .info-label {
        color: #666;
    }

    .script-actions {
        padding: 16px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .action-btn {
        padding: 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #10a37f;
        color: white;
    }

    .btn-primary:hover {
        background: #0d8b6d;
    }

    .btn-secondary {
        background: white;
        color: #333;
        border: 1px solid #e0e0e0;
    }

    .btn-secondary:hover {
        background: #f8f9fa;
    }

    .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #10a37f;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<div class="container-fluid mt-4">
    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 class="mb-0">ğŸ­ Stagehand AI ä»»åŠ¡</h4>
            <small class="text-muted">AI é©±åŠ¨çš„æµè§ˆå™¨è‡ªåŠ¨åŒ–è„šæœ¬ç”Ÿæˆ</small>
        </div>
        <div class="d-flex align-items-center gap-3">
            <select id="providerSelect" class="form-select" style="width: 200px;">
                <option value="">é€‰æ‹© AI æä¾›å•†...</option>
            </select>
            <button class="btn btn-sm btn-outline-primary" onclick="showGeminiSettings()">
                <i class="fas fa-key"></i> Gemini è®¾ç½®
            </button>
            <span id="statusBadge" class="status-badge status-warning">
                <span class="loading"></span>
                <span>æ£€æŸ¥ä¸­...</span>
            </span>
        </div>
    </div>
    
    <!-- Gemini API Key è®¾ç½®é¢æ¿ -->
    <div id="geminiSettingsPanel" class="card mb-3" style="display: none;">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <strong><i class="fas fa-key"></i> Gemini API Key é…ç½®</strong>
                <button class="btn btn-sm btn-light" onclick="hideGeminiSettings()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="alert alert-info mb-3">
                <i class="fas fa-info-circle"></i> 
                <strong>ä¸ºä»€ä¹ˆéœ€è¦ Gemini API Keyï¼Ÿ</strong><br>
                Stagehand éœ€è¦ AI æ¨¡å‹æ¥ç†è§£ç½‘é¡µç»“æ„å’Œæ‰§è¡Œæ™ºèƒ½æ“ä½œã€‚è®¾ç½®åå°†ä½œä¸ºç¯å¢ƒå˜é‡ä¼ é€’ç»™ Node.js è„šæœ¬ã€‚
            </div>
            
            <div class="mb-3">
                <label for="geminiApiKey" class="form-label">
                    <strong>Gemini API Key</strong>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="ms-2 small">
                        <i class="fas fa-external-link-alt"></i> è·å– API Key
                    </a>
                </label>
                <div class="input-group">
                    <input type="password" class="form-control" id="geminiApiKey" 
                           placeholder="è¾“å…¥ä½ çš„ Gemini API Key..." 
                           value="">
                    <button class="btn btn-outline-secondary" type="button" onclick="toggleApiKeyVisibility()">
                        <i class="fas fa-eye" id="toggleIcon"></i>
                    </button>
                </div>
                <small class="text-muted">
                    API Key å°†ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­ï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨
                </small>
            </div>
            
            <div class="mb-3">
                <label for="geminiModel" class="form-label"><strong>Gemini æ¨¡å‹</strong></label>
                <select class="form-select" id="geminiModel">
                    <option value="google/gemini-2.0-flash-exp">Gemini 2.0 Flash (æ¨è)</option>
                    <option value="google/gemini-2.5-flash">Gemini 2.5 Flash</option>
                    <option value="google/gemini-1.5-pro">Gemini 1.5 Pro</option>
                    <option value="google/gemini-1.5-flash">Gemini 1.5 Flash</option>
                </select>
                <small class="text-muted">
                    æ¨èä½¿ç”¨ Gemini 2.0 Flashï¼Œé€Ÿåº¦å¿«ä¸”æ•ˆæœå¥½
                </small>
            </div>
            
            <div class="d-flex gap-2">
                <button class="btn btn-primary" onclick="saveGeminiSettings()">
                    <i class="fas fa-save"></i> ä¿å­˜è®¾ç½®
                </button>
                <button class="btn btn-outline-danger" onclick="clearGeminiSettings()">
                    <i class="fas fa-trash"></i> æ¸…é™¤è®¾ç½®
                </button>
                <button class="btn btn-outline-secondary" onclick="testGeminiConnection()">
                    <i class="fas fa-vial"></i> æµ‹è¯•è¿æ¥
                </button>
            </div>
            
            <div id="geminiTestResult" class="mt-3" style="display: none;"></div>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="stagehand-container">
        <!-- å·¦ä¾§ï¼šå¯¹è¯åŒº -->
        <div class="chat-section">
            <div class="section-header">
                <div>
                    <strong>å¯¹è¯å†å²</strong>
                    <small class="text-muted ms-2">æè¿°ä½ çš„ä»»åŠ¡éœ€æ±‚</small>
                </div>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearChat()">
                    <i class="fas fa-trash"></i> æ¸…ç©º
                </button>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- æ¬¢è¿æ¶ˆæ¯ -->
                <div class="message message-system">
                    <div class="message-bubble">
                        <div class="mb-2"><strong>ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ Stagehand AI ä»»åŠ¡åŠ©æ‰‹</strong></div>
                        <div class="small">
                            æˆ‘å¯ä»¥å¸®ä½ åˆ›å»ºåŸºäº Stagehand çš„ç½‘é¡µè‡ªåŠ¨åŒ–ä»»åŠ¡ã€‚ç”¨è‡ªç„¶è¯­è¨€æè¿°éœ€æ±‚ï¼Œæˆ‘ä¼šç”Ÿæˆå¯æ‰§è¡Œçš„ JavaScript è„šæœ¬ã€‚
                        </div>
                    </div>
                </div>

                <!-- å¿«æ·ç¤ºä¾‹ -->
                <div class="examples-grid" id="examplesGrid">
                    <!-- åŠ¨æ€åŠ è½½ -->
                </div>
            </div>

            <div class="chat-input-area">
                <div class="input-wrapper">
                    <textarea id="userInput" class="input-box" placeholder="æè¿°ä½ çš„ä»»åŠ¡ï¼Œä¾‹å¦‚ï¼šæ‰“å¼€ GitHubï¼Œæœç´¢ stagehandï¼Œç‚¹å‡»ç¬¬ä¸€ä¸ªç»“æœ..." rows="2"></textarea>
                    <button id="sendBtn" class="send-btn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane me-1"></i> ç”Ÿæˆè„šæœ¬
                    </button>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šè„šæœ¬é¢„è§ˆåŒº -->
        <div class="script-section">
            <div class="section-header">
                <strong>ğŸ“ è„šæœ¬é¢„è§ˆ</strong>
            </div>

            <div class="script-preview">
                <textarea id="scriptEditor" class="code-editor" placeholder="// ç­‰å¾… AI ç”Ÿæˆ Stagehand è„šæœ¬...
// ä½ å¯ä»¥ç”¨è‡ªç„¶è¯­è¨€æè¿°ä»»åŠ¡éœ€æ±‚"></textarea>
            </div>

            <div class="script-info">
                <div class="info-row">
                    <span class="info-label">æ“ä½œæ•°ï¼š</span>
                    <span id="actionCount">0</span>
                </div>
                <div class="info-row">
                    <span class="info-label">é¢„è®¡æ—¶é—´ï¼š</span>
                    <span id="estimatedTime">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">å¤æ‚åº¦ï¼š</span>
                    <span id="complexity">-</span>
                </div>
            </div>

            <div class="script-actions">
                <button class="action-btn btn-primary" onclick="executeScript()">
                    <i class="fas fa-play me-1"></i> è¿è¡Œè„šæœ¬
                </button>
                <button class="action-btn btn-secondary" onclick="copyScript()">
                    <i class="fas fa-copy me-1"></i> å¤åˆ¶è„šæœ¬
                </button>
                <button class="action-btn btn-secondary" onclick="downloadScript()">
                    <i class="fas fa-download me-1"></i> å¯¼å‡ºä¸º .js
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
let currentScript = '';
let selectedProviderId = 0;

$(document).ready(function() {
    loadProviders();
    loadStatus();
    loadExamples();
    loadGeminiSettings();
    
    // Enter å‘é€
    $('#userInput').keydown(function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
});

// åŠ è½½ AI æä¾›å•†
async function loadProviders() {
    try {
        const resp = await fetch('/AIProvider/GetAll');
        const providers = await resp.json();
        
        const select = $('#providerSelect');
        select.empty();
        select.append('<option value="">é€‰æ‹© AI æä¾›å•†...</option>');
        
        providers.forEach(p => {
            select.append(`<option value="${p.id}">${p.name}</option>`);
        });
        
        // é€‰æ‹©ç¬¬ä¸€ä¸ª
        if (providers.length > 0) {
            select.val(providers[0].id);
            selectedProviderId = providers[0].id;
        }
    } catch (e) {
        console.error('Load providers failed:', e);
    }
}

$('#providerSelect').change(function() {
    selectedProviderId = parseInt($(this).val()) || 0;
});

// åŠ è½½çŠ¶æ€
async function loadStatus() {
    try {
        const resp = await fetch('@Url.Action("GetStatus")');
        const status = await resp.json();
        
        const badge = $('#statusBadge');
        if (status.nodeInstalled && status.stagehandInstalled) {
            badge.removeClass('status-warning status-error').addClass('status-ready');
            badge.html('<i class="fas fa-check-circle"></i> <span>Stagehand å·²å°±ç»ª</span>');
        } else if (!status.nodeInstalled) {
            badge.removeClass('status-warning status-ready').addClass('status-error');
            badge.html('<i class="fas fa-times-circle"></i> <span>Node.js æœªå®‰è£…</span>');
        } else {
            badge.removeClass('status-ready status-error').addClass('status-warning');
            badge.html('<i class="fas fa-exclamation-circle"></i> <span>Stagehand æœªå®‰è£…</span>');
        }
    } catch (e) {
        console.error('Load status failed:', e);
        $('#statusBadge').removeClass('status-warning status-ready').addClass('status-error');
        $('#statusBadge').html('<i class="fas fa-times-circle"></i> <span>çŠ¶æ€æ£€æŸ¥å¤±è´¥</span>');
    }
}

// åŠ è½½ç¤ºä¾‹
async function loadExamples() {
    try {
        const resp = await fetch('@Url.Action("GetExamples")');
        const examples = await resp.json();
        
        const grid = $('#examplesGrid');
        grid.empty();
        
        examples.forEach(ex => {
            grid.append(`
                <div class="example-card" onclick="useExample('${ex.prompt.replace(/'/g, "\\'")}')">
                    <div class="example-icon">${ex.icon}</div>
                    <div class="example-name">${ex.name}</div>
                    <div class="example-desc">${ex.description}</div>
                </div>
            `);
        });
    } catch (e) {
        console.error('Load examples failed:', e);
    }
}

// ä½¿ç”¨ç¤ºä¾‹
function useExample(prompt) {
    $('#userInput').val(prompt);
    sendMessage();
}

// å‘é€æ¶ˆæ¯
async function sendMessage() {
    const input = $('#userInput');
    const message = input.val().trim();
    
    if (!message) return;
    
    if (selectedProviderId === 0) {
        toastr.error('è¯·å…ˆé€‰æ‹© AI æä¾›å•†');
        return;
    }
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    addMessage('user', message);
    input.val('');
    
    // ç¦ç”¨è¾“å…¥
    input.prop('disabled', true);
    $('#sendBtn').prop('disabled', true).html('<span class="loading"></span> ç”Ÿæˆä¸­...');
    
    try {
        const resp = await fetch('@Url.Action("GenerateScript")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userMessage: message,
                providerId: selectedProviderId,
                history: []
            })
        });
        
        const result = await resp.json();
        
        if (result.success) {
            currentScript = result.script;
            $('#scriptEditor').val(result.script);
            $('#actionCount').text(result.actionCount);
            $('#estimatedTime').text(formatTime(result.estimatedSeconds));
            $('#complexity').text(result.complexity);
            
            addMessage('ai', `âœ… å·²ç”Ÿæˆ Stagehand è„šæœ¬ï¼\n\nè„šæœ¬åŒ…å« ${result.actionCount} ä¸ªæ“ä½œæ­¥éª¤ã€‚ä½ å¯ä»¥åœ¨å³ä¾§é¢„è§ˆå’Œç¼–è¾‘è„šæœ¬ï¼Œç„¶åç‚¹å‡»"è¿è¡Œè„šæœ¬"æ‰§è¡Œã€‚`);
        } else {
            addMessage('ai', `âŒ ${result.message}`);
        }
    } catch (e) {
        console.error('Generate failed:', e);
        addMessage('ai', `âŒ ç”Ÿæˆå¤±è´¥ï¼š${e.message}`);
    } finally {
        input.prop('disabled', false);
        $('#sendBtn').prop('disabled', false).html('<i class="fas fa-paper-plane me-1"></i> ç”Ÿæˆè„šæœ¬');
    }
}

// æ·»åŠ æ¶ˆæ¯
function addMessage(type, content) {
    const messages = $('#chatMessages');
    const messageClass = type === 'user' ? 'message-user' : (type === 'ai' ? 'message-ai' : 'message-system');
    
    // æ¸…ç† ANSI é¢œè‰²ä»£ç 
    const cleanContent = cleanAnsiCodes(content);
    
    // ç”Ÿæˆå”¯ä¸€ ID
    const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    
    messages.append(`
        <div class="message ${messageClass}">
            <div class="message-bubble" style="position: relative;">
                <button class="btn btn-sm btn-outline-secondary" 
                        style="position: absolute; top: 8px; right: 8px; padding: 2px 8px; font-size: 11px;"
                        onclick="copyMessage('${messageId}')"
                        title="å¤åˆ¶æ¶ˆæ¯">
                    <i class="fas fa-copy"></i>
                </button>
                <div id="${messageId}">${cleanContent.replace(/\n/g, '<br>')}</div>
            </div>
        </div>
    `);
    
    messages.scrollTop(messages[0].scrollHeight);
}

// æ¸…ç† ANSI é¢œè‰²ä»£ç 
function cleanAnsiCodes(text) {
    // ç§»é™¤ ANSI è½¬ä¹‰åºåˆ—
    return text.replace(/\x1b\[[0-9;]*m/g, '')
               .replace(/\[([0-9]+)m/g, '');
}

// å¤åˆ¶æ¶ˆæ¯
function copyMessage(messageId) {
    const element = document.getElementById(messageId);
    if (!element) return;
    
    // è·å–çº¯æ–‡æœ¬å†…å®¹ï¼ˆç§»é™¤ HTML æ ‡ç­¾ï¼‰
    const text = element.innerHTML.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '');
    
    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    navigator.clipboard.writeText(text).then(() => {
        toastr.success('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        toastr.error('å¤åˆ¶å¤±è´¥');
    });
}

// æ‰§è¡Œè„šæœ¬
async function executeScript() {
    const script = $('#scriptEditor').val().trim();
    
    if (!script) {
        toastr.error('è¯·å…ˆç”Ÿæˆè„šæœ¬');
        return;
    }
    
    // æ£€æŸ¥ Gemini è®¾ç½®
    const geminiSettings = getGeminiSettings();
    if (!geminiSettings.apiKey) {
        toastr.warning('å»ºè®®å…ˆé…ç½® Gemini API Key ä»¥è·å¾—æœ€ä½³æ•ˆæœ');
        if (!confirm('æœªé…ç½® Gemini API Keyï¼Œè„šæœ¬å¯èƒ½æ— æ³•æ­£å¸¸æ‰§è¡Œã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')) {
            return;
        }
    }
    
    if (!confirm('ç¡®å®šè¦æ‰§è¡Œæ­¤è„šæœ¬å—ï¼Ÿ')) return;
    
    addMessage('system', 'ğŸš€ å¼€å§‹æ‰§è¡Œè„šæœ¬...');
    
    try {
        const resp = await fetch('@Url.Action("ExecuteScript")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                script: script,
                debug: true,
                geminiApiKey: geminiSettings.apiKey,
                geminiModel: geminiSettings.model
            })
        });
        
        const result = await resp.json();
        
        if (result.success) {
            addMessage('system', `âœ… è„šæœ¬æ‰§è¡ŒæˆåŠŸï¼\n\nè¾“å‡ºï¼š\n${result.output}`);
            toastr.success('è„šæœ¬æ‰§è¡ŒæˆåŠŸï¼');
        } else {
            addMessage('system', `âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥\n\né”™è¯¯ï¼š\n${result.error}`);
            toastr.error('è„šæœ¬æ‰§è¡Œå¤±è´¥');
        }
    } catch (e) {
        console.error('Execute failed:', e);
        addMessage('system', `âŒ æ‰§è¡Œå¤±è´¥ï¼š${e.message}`);
        toastr.error('æ‰§è¡Œå¤±è´¥');
    }
}

// å¤åˆ¶è„šæœ¬
function copyScript() {
    const script = $('#scriptEditor').val();
    if (!script) {
        toastr.error('æ²¡æœ‰å¯å¤åˆ¶çš„è„šæœ¬');
        return;
    }
    
    navigator.clipboard.writeText(script).then(() => {
        toastr.success('è„šæœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    });
}

// ä¸‹è½½è„šæœ¬
function downloadScript() {
    const script = $('#scriptEditor').val();
    if (!script) {
        toastr.error('æ²¡æœ‰å¯ä¸‹è½½çš„è„šæœ¬');
        return;
    }
    
    const blob = new Blob([script], { type: 'text/javascript' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `stagehand-task-${Date.now()}.js`;
    a.click();
    URL.revokeObjectURL(url);
    
    toastr.success('è„šæœ¬å·²ä¸‹è½½');
}

// æ¸…ç©ºå¯¹è¯
function clearChat() {
    if (!confirm('ç¡®å®šè¦æ¸…ç©ºå¯¹è¯å†å²å—ï¼Ÿ')) return;
    
    $('#chatMessages').empty();
    addMessage('system', 'ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ Stagehand AI ä»»åŠ¡åŠ©æ‰‹\n\næˆ‘å¯ä»¥å¸®ä½ åˆ›å»ºåŸºäº Stagehand çš„ç½‘é¡µè‡ªåŠ¨åŒ–ä»»åŠ¡ã€‚ç”¨è‡ªç„¶è¯­è¨€æè¿°éœ€æ±‚ï¼Œæˆ‘ä¼šç”Ÿæˆå¯æ‰§è¡Œçš„ JavaScript è„šæœ¬ã€‚');
    loadExamples();
    
    $('#scriptEditor').val('// ç­‰å¾… AI ç”Ÿæˆ Stagehand è„šæœ¬...\n// ä½ å¯ä»¥ç”¨è‡ªç„¶è¯­è¨€æè¿°ä»»åŠ¡éœ€æ±‚');
    $('#actionCount').text('0');
    $('#estimatedTime').text('-');
    $('#complexity').text('-');
    currentScript = '';
}

// æ ¼å¼åŒ–æ—¶é—´
function formatTime(seconds) {
    if (seconds < 60) return `${seconds} ç§’`;
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${minutes} åˆ† ${secs} ç§’`;
}

// ========== Gemini è®¾ç½®ç›¸å…³å‡½æ•° ==========

// åŠ è½½ Gemini è®¾ç½®
function loadGeminiSettings() {
    const apiKey = localStorage.getItem('stagehand_gemini_api_key');
    const model = localStorage.getItem('stagehand_gemini_model') || 'google/gemini-2.0-flash-exp';
    
    if (apiKey) {
        $('#geminiApiKey').val(apiKey);
    }
    $('#geminiModel').val(model);
}

// æ˜¾ç¤º Gemini è®¾ç½®é¢æ¿
function showGeminiSettings() {
    $('#geminiSettingsPanel').slideDown();
}

// éšè— Gemini è®¾ç½®é¢æ¿
function hideGeminiSettings() {
    $('#geminiSettingsPanel').slideUp();
}

// åˆ‡æ¢ API Key å¯è§æ€§
function toggleApiKeyVisibility() {
    const input = $('#geminiApiKey');
    const icon = $('#toggleIcon');
    
    if (input.attr('type') === 'password') {
        input.attr('type', 'text');
        icon.removeClass('fa-eye').addClass('fa-eye-slash');
    } else {
        input.attr('type', 'password');
        icon.removeClass('fa-eye-slash').addClass('fa-eye');
    }
}

// ä¿å­˜ Gemini è®¾ç½®
function saveGeminiSettings() {
    const apiKey = $('#geminiApiKey').val().trim();
    const model = $('#geminiModel').val();
    
    if (!apiKey) {
        toastr.error('è¯·è¾“å…¥ Gemini API Key');
        return;
    }
    
    localStorage.setItem('stagehand_gemini_api_key', apiKey);
    localStorage.setItem('stagehand_gemini_model', model);
    
    toastr.success('Gemini è®¾ç½®å·²ä¿å­˜');
    hideGeminiSettings();
}

// æ¸…é™¤ Gemini è®¾ç½®
function clearGeminiSettings() {
    if (!confirm('ç¡®å®šè¦æ¸…é™¤ Gemini è®¾ç½®å—ï¼Ÿ')) return;
    
    localStorage.removeItem('stagehand_gemini_api_key');
    localStorage.removeItem('stagehand_gemini_model');
    
    $('#geminiApiKey').val('');
    $('#geminiModel').val('google/gemini-2.0-flash-exp');
    
    toastr.success('Gemini è®¾ç½®å·²æ¸…é™¤');
}

// æµ‹è¯• Gemini è¿æ¥
async function testGeminiConnection() {
    const apiKey = $('#geminiApiKey').val().trim();
    const model = $('#geminiModel').val();
    
    if (!apiKey) {
        toastr.error('è¯·å…ˆè¾“å…¥ Gemini API Key');
        return;
    }
    
    const resultDiv = $('#geminiTestResult');
    resultDiv.html('<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> æ­£åœ¨æµ‹è¯•è¿æ¥...</div>').show();
    
    try {
        // ç®€å•çš„æµ‹è¯•è¯·æ±‚
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model.replace('google/', '')}:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{
                    parts: [{ text: 'Hello' }]
                }]
            })
        });
        
        if (response.ok) {
            resultDiv.html('<div class="alert alert-success"><i class="fas fa-check-circle"></i> è¿æ¥æˆåŠŸï¼Gemini API Key æœ‰æ•ˆã€‚</div>');
        } else {
            const error = await response.text();
            resultDiv.html(`<div class="alert alert-danger"><i class="fas fa-times-circle"></i> è¿æ¥å¤±è´¥ï¼š${response.status} - ${error}</div>`);
        }
    } catch (error) {
        resultDiv.html(`<div class="alert alert-danger"><i class="fas fa-times-circle"></i> è¿æ¥å¤±è´¥ï¼š${error.message}</div>`);
    }
}

// è·å– Gemini è®¾ç½®ï¼ˆç”¨äºè„šæœ¬æ‰§è¡Œï¼‰
function getGeminiSettings() {
    return {
        apiKey: localStorage.getItem('stagehand_gemini_api_key'),
        model: localStorage.getItem('stagehand_gemini_model') || 'google/gemini-2.0-flash-exp'
    };
}
</script>
}
