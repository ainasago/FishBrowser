@{
    ViewData["Title"] = "å¿«é€Ÿé…ç½® AI æä¾›å•†";
}

<style>
.wizard-container { max-width: 900px; margin: 0 auto; }
.step-header { background: white; border-bottom: 1px solid #e0e0e0; padding: 24px; margin-bottom: 24px; }
.step-title { font-size: 20px; font-weight: bold; margin-bottom: 8px; }
.step-desc { color: #666; font-size: 13px; }
.provider-card { background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 20px; margin: 8px; cursor: pointer; transition: all 0.3s; width: 220px; height: 140px; display: inline-block; text-align: center; }
.provider-card:hover { border-color: #0078d4; box-shadow: 0 0 10px rgba(0,120,212,0.3); }
.provider-card.selected { border-color: #0078d4; border-width: 3px; box-shadow: 0 0 12px rgba(0,120,212,0.4); }
.provider-icon { font-size: 32px; margin-bottom: 8px; }
.provider-name { font-size: 16px; font-weight: bold; margin-bottom: 4px; }
.provider-sub { font-size: 11px; color: #666; margin-bottom: 4px; }
.provider-desc { font-size: 10px; color: #999; }
.model-card { background: white; border: 1px solid #e0e0e0; border-radius: 6px; padding: 16px; margin-bottom: 12px; cursor: pointer; }
.model-card:hover { border-color: #0078d4; }
.model-card.selected { border-color: #0078d4; background: #f0f8ff; }
.info-box { border-radius: 6px; padding: 16px; margin-bottom: 20px; }
.info-box.warning { background: #fff9e6; border: 1px solid #ffe5b3; }
.info-box.success { background: #e8f5e9; border: 1px solid #4caf50; }
.section-title { font-size: 14px; font-weight: 600; margin: 24px 0 12px 0; }
</style>

<div class="wizard-container">
    <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
    <div class="step-header">
        <div class="step-title" id="stepTitle">æ­¥éª¤ 1/3ï¼šé€‰æ‹© AI æä¾›å•†</div>
        <div class="step-desc" id="stepDesc">é€‰æ‹©ä½ æƒ³ä½¿ç”¨çš„ AI æœåŠ¡æä¾›å•†</div>
    </div>

    <!-- æ­¥éª¤ 1: é€‰æ‹©æä¾›å•† -->
    <div id="step1" class="step-content">
        <div class="section-title"> å›½é™…æä¾›å•†</div>
        <div>
            <div class="provider-card" data-type="1" data-name="OpenAI">
                <div class="provider-icon">ğŸ¤–</div>
                <div class="provider-name">OpenAI</div>
                <div class="provider-sub">GPT-4 / GPT-3.5</div>
                <div class="provider-desc">æœ€å¼ºå¤§ï¼Œé€‚åˆå¤æ‚ä»»åŠ¡</div>
            </div>
            <div class="provider-card" data-type="3" data-name="GoogleGemini">
                <div class="provider-icon">ğŸŒŸ</div>
                <div class="provider-name">Google Gemini</div>
                <div class="provider-sub">Gemini Pro</div>
                <div class="provider-desc">å…è´¹é¢åº¦å¤§</div>
            </div>
            <div class="provider-card" data-type="4" data-name="AnthropicClaude">
                <div class="provider-icon">ğŸ§ </div>
                <div class="provider-name">Claude</div>
                <div class="provider-sub">Claude 3</div>
                <div class="provider-desc">é•¿ä¸Šä¸‹æ–‡ï¼Œå®‰å…¨æ€§é«˜</div>
            </div>
        </div>

        <div class="section-title"> å›½å†…æä¾›å•†</div>
        <div>
            <div class="provider-card" data-type="101" data-name="AlibabaQwen">
                <div class="provider-icon">â˜ï¸</div>
                <div class="provider-name">é€šä¹‰åƒé—®</div>
                <div class="provider-sub">é˜¿é‡Œäº‘</div>
                <div class="provider-desc">ä¸­æ–‡ä¼˜ç§€ï¼Œæ€§ä»·æ¯”é«˜</div>
            </div>
            <div class="provider-card" data-type="109" data-name="ModelScope">
                <div class="provider-icon">ğŸª„</div>
                <div class="provider-name">é­”å¡”ç¤¾åŒº</div>
                <div class="provider-sub">ModelScope</div>
                <div class="provider-desc">å¼€æºæ¨¡å‹ï¼Œå…è´¹ä½¿ç”¨</div>
            </div>
            <div class="provider-card" data-type="110" data-name="SiliconFlow">
                <div class="provider-icon">âš¡</div>
                <div class="provider-name">ç¡…åŸºæµåŠ¨</div>
                <div class="provider-sub">SiliconFlow</div>
                <div class="provider-desc">é«˜æ€§èƒ½æ¨ç†ï¼ŒæŒ‰é‡è®¡è´¹</div>
            </div>
            <div class="provider-card" data-type="104" data-name="ZhipuGLM">
                <div class="provider-icon">ğŸ“</div>
                <div class="provider-name">æ™ºè°± GLM</div>
                <div class="provider-sub">GLM-4</div>
                <div class="provider-desc">æ¸…åèƒŒæ™¯ï¼Œä¸­æ–‡å¼º</div>
            </div>
            <div class="provider-card" data-type="106" data-name="MoonshotAI">
                <div class="provider-icon">ğŸŒ™</div>
                <div class="provider-name">Moonshot</div>
                <div class="provider-sub">Kimi</div>
                <div class="provider-desc">è¶…é•¿ä¸Šä¸‹æ–‡ 128K</div>
            </div>
        </div>

        <div class="section-title"> æœ¬åœ°éƒ¨ç½²</div>
        <div>
            <div class="provider-card" data-type="201" data-name="Ollama">
                <div class="provider-icon">ğŸ¦™</div>
                <div class="provider-name">Ollama</div>
                <div class="provider-sub">æœ¬åœ°æ¨¡å‹</div>
                <div class="provider-desc">å®Œå…¨å…è´¹ï¼Œæ•°æ®å®‰å…¨</div>
            </div>
        </div>
    </div>

    <!-- æ­¥éª¤ 2: é€‰æ‹©æ¨¡å‹ -->
    <div id="step2" class="step-content" style="display:none;">
        <div style="color: #666; margin-bottom: 16px;">å·²é€‰æ‹©ï¼š<span id="selectedProviderName"></span></div>
        <div class="section-title">é€‰æ‹©æ¨¡å‹</div>
        <div id="modelsList"></div>
    </div>

    <!-- æ­¥éª¤ 3: é…ç½® API Key -->
    <div id="step3" class="step-content" style="display:none;">
        <div style="color: #666; margin-bottom: 16px;">é…ç½®ï¼š<span id="step3ProviderInfo"></span></div>

        <div class="info-box warning">
            <div style="font-weight: 600; margin-bottom: 8px;"> å¦‚ä½•è·å– API Keyï¼Ÿ</div>
            <div id="apiKeyHelp" style="font-size: 12px; color: #666;"></div>
        </div>

        <div class="form-group">
            <label style="font-weight: 600; margin-bottom: 8px;">Base URL</label>
            <input type="text" class="form-control" id="baseUrlInput" placeholder="API åŸºç¡€åœ°å€">
            <small class="form-text text-muted">å¯ä»¥ä¿®æ”¹ä¸ºè‡ªå®šä¹‰çš„ API åœ°å€æˆ–ä»£ç†åœ°å€</small>
        </div>

        <div class="form-group">
            <label style="font-weight: 600; margin-bottom: 8px;">API å¯†é’¥</label>
            <div class="input-group">
                <input type="text" class="form-control" id="apiKeyInput" placeholder="è¾“å…¥ä½ çš„ API Key">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" id="btnPaste">ç²˜è´´</button>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label style="font-weight: 600; margin-bottom: 8px;">é…ç½®åç§°ï¼ˆå¯é€‰ï¼‰</label>
            <input type="text" class="form-control" id="configNameInput" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ Gemini">
        </div>

        <div class="info-box success">
            <div style="font-weight: 600; margin-bottom: 8px;"> é…ç½®å®Œæˆå</div>
            <div style="font-size: 12px; color: #666;">
                â€¢ ç³»ç»Ÿä¼šè‡ªåŠ¨æµ‹è¯•è¿æ¥<br>
                â€¢ å¯åœ¨ã€ŒAI ä»»åŠ¡ã€ä¸­ä½¿ç”¨<br>
                â€¢ å¯éšæ—¶æ·»åŠ æ›´å¤šå¯†é’¥
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨æŒ‰é’® -->
    <div style="background: white; border-top: 1px solid #e0e0e0; padding: 16px; margin-top: 24px;">
        <div class="d-flex justify-content-between">
            <button class="btn btn-outline-secondary" id="btnBack" style="display:none;"> ä¸Šä¸€æ­¥</button>
            <div class="ml-auto">
                <a href="@Url.Action("Index")" class="btn btn-outline-secondary mr-2">å–æ¶ˆ</a>
                <button class="btn btn-primary" id="btnNext" disabled>ä¸‹ä¸€æ­¥ â†’</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
let currentStep = 1;
let selectedType = null;
let selectedModel = null;
let selectedProviderName = '';

// æ¨¡å‹é…ç½®
const modelOptions = {
    1: [ // OpenAI
        { id: 'gpt-4-turbo', name: 'GPT-4 Turbo', desc: 'æœ€å¼ºå¤§ï¼Œé€‚åˆå¤æ‚ä»»åŠ¡', price: '$0.01/1K tokens', context: '128K ä¸Šä¸‹æ–‡', recommended: false },
        { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo', desc: 'æ€§ä»·æ¯”é«˜ï¼Œé€‚åˆæ—¥å¸¸ä½¿ç”¨ï¼ˆæ¨èï¼‰', price: '$0.0005/1K tokens', context: '16K ä¸Šä¸‹æ–‡', recommended: true }
    ],
    3: [ // Google Gemini
        { id: 'gemini-2.0-flash-exp', name: 'Gemini 2.0 Flash', desc: 'æœ€æ–°æ¨¡å‹ï¼Œé€Ÿåº¦å¿«ï¼ˆæ¨èï¼‰', price: 'å…è´¹é¢åº¦', context: '32K ä¸Šä¸‹æ–‡', recommended: true },
        { id: 'gemini-pro', name: 'Gemini Pro', desc: 'ç¨³å®šç‰ˆæœ¬', price: 'å…è´¹é¢åº¦', context: '32K ä¸Šä¸‹æ–‡', recommended: false }
    ],
    4: [ // Claude
        { id: 'claude-3-sonnet-20240229', name: 'Claude 3 Sonnet', desc: 'å¹³è¡¡æ€§èƒ½ä¸æˆæœ¬ï¼ˆæ¨èï¼‰', price: '$0.003/1K tokens', context: '200K ä¸Šä¸‹æ–‡', recommended: true },
        { id: 'claude-3-opus-20240229', name: 'Claude 3 Opus', desc: 'æœ€å¼ºå¤§ï¼Œé€‚åˆå¤æ‚ä»»åŠ¡', price: '$0.015/1K tokens', context: '200K ä¸Šä¸‹æ–‡', recommended: false }
    ],
    101: [ // é€šä¹‰åƒé—®
        { id: 'qwen-plus', name: 'é€šä¹‰åƒé—®-Plus', desc: 'æ€§ä»·æ¯”é«˜ï¼Œä¸­æ–‡ä¼˜ç§€ï¼ˆæ¨èï¼‰', price: 'Â¥0.004/1K tokens', context: '8K ä¸Šä¸‹æ–‡', recommended: true },
        { id: 'qwen-max', name: 'é€šä¹‰åƒé—®-Max', desc: 'æœ€å¼ºå¤§ï¼Œé€‚åˆå¤æ‚ä»»åŠ¡', price: 'Â¥0.04/1K tokens', context: '8K ä¸Šä¸‹æ–‡', recommended: false }
    ],
    109: [ // ModelScope
        { id: 'Qwen/Qwen2.5-32B-Instruct', name: 'Qwen2.5-32B', desc: 'å¹³è¡¡æ€§èƒ½ï¼Œä¸­æ–‡ä¼˜ç§€ï¼ˆæ¨èï¼‰', price: 'å…è´¹ä½¿ç”¨', context: '32K ä¸Šä¸‹æ–‡', recommended: true },
        { id: 'Qwen/Qwen2.5-72B-Instruct', name: 'Qwen2.5-72B', desc: 'æœ€å¼ºæ€§èƒ½', price: 'å…è´¹ä½¿ç”¨', context: '32K ä¸Šä¸‹æ–‡', recommended: false }
    ],
    110: [ // SiliconFlow
        { id: 'Qwen/QwQ-32B', name: 'QwQ-32B', desc: 'æ¨ç†ä¸“ç”¨æ¨¡å‹ï¼ˆæ¨èï¼‰', price: 'Â¥0.42/M tokens', context: '32K ä¸Šä¸‹æ–‡', recommended: true },
        { id: 'deepseek-ai/DeepSeek-V3', name: 'DeepSeek-V3', desc: 'æœ€å¼ºæ€§èƒ½', price: 'Â¥0.14/M tokens', context: '64K ä¸Šä¸‹æ–‡', recommended: false }
    ],
    104: [ // æ™ºè°±GLM
        { id: 'glm-4', name: 'GLM-4', desc: 'æœ€æ–°æ¨¡å‹ï¼Œä¸­æ–‡ä¼˜ç§€ï¼ˆæ¨èï¼‰', price: 'Â¥0.05/1K tokens', context: '128K ä¸Šä¸‹æ–‡', recommended: true }
    ],
    106: [ // Moonshot
        { id: 'moonshot-v1-8k', name: 'Moonshot 8K', desc: 'æ€§ä»·æ¯”é«˜ï¼ˆæ¨èï¼‰', price: 'Â¥0.012/1K tokens', context: '8K ä¸Šä¸‹æ–‡', recommended: true },
        { id: 'moonshot-v1-128k', name: 'Moonshot 128K', desc: 'è¶…é•¿ä¸Šä¸‹æ–‡', price: 'Â¥0.06/1K tokens', context: '128K ä¸Šä¸‹æ–‡', recommended: false }
    ],
    201: [ // Ollama
        { id: 'llama3', name: 'Llama 3', desc: 'Meta å¼€æºæ¨¡å‹ï¼ˆæ¨èï¼‰', price: 'å®Œå…¨å…è´¹', context: '8K ä¸Šä¸‹æ–‡', recommended: true },
        { id: 'qwen2.5', name: 'Qwen 2.5', desc: 'ä¸­æ–‡ä¼˜ç§€', price: 'å®Œå…¨å…è´¹', context: '32K ä¸Šä¸‹æ–‡', recommended: false }
    ]
};

const providerConfig = {
    1: { url: 'https://api.openai.com/v1', help: 'è®¿é—® https://platform.openai.com/api-keys è·å– API Key' },
    3: { url: 'https://generativelanguage.googleapis.com/v1beta', help: 'è®¿é—® https://ai.google.dev è·å– API Key' },
    4: { url: 'https://api.anthropic.com/v1', help: 'è®¿é—® https://console.anthropic.com è·å– API Key' },
    101: { url: 'https://dashscope.aliyuncs.com/api/v1', help: 'è®¿é—® https://dashscope.aliyun.com è·å– API Key' },
    109: { url: 'https://api-inference.modelscope.cn/v1', help: 'è®¿é—® https://www.modelscope.cn è·å– API Key' },
    110: { url: 'https://api.siliconflow.cn/v1', help: 'è®¿é—® https://siliconflow.cn è·å– API Key' },
    104: { url: 'https://open.bigmodel.cn/api/paas/v4', help: 'è®¿é—® https://open.bigmodel.cn è·å– API Key' },
    106: { url: 'https://api.moonshot.cn/v1', help: 'è®¿é—® https://platform.moonshot.cn è·å– API Key' },
    201: { url: 'http://localhost:11434', help: 'æœ¬åœ°è¿è¡Œï¼Œæ— éœ€ API Key' }
};

// æ­¥éª¤ 1: é€‰æ‹©æä¾›å•†
$('.provider-card').on('click', function() {
    $('.provider-card').removeClass('selected');
    $(this).addClass('selected');
    selectedType = parseInt($(this).data('type'));
    selectedProviderName = $(this).data('name');
    $('#btnNext').prop('disabled', false);
});

// æ­¥éª¤å¯¼èˆª
$('#btnNext').on('click', async () => {
    if (currentStep === 1) {
        if (!selectedType) { toastr.error('è¯·é€‰æ‹©æä¾›å•†'); return; }
        showStep2();
    } else if (currentStep === 2) {
        if (!selectedModel) { toastr.error('è¯·é€‰æ‹©æ¨¡å‹'); return; }
        showStep3();
    } else if (currentStep === 3) {
        await createProvider();
    }
});

$('#btnBack').on('click', () => {
    if (currentStep === 2) showStep1();
    else if (currentStep === 3) showStep2();
});

function showStep1() {
    currentStep = 1;
    $('#step1').show(); $('#step2, #step3').hide();
    $('#stepTitle').text('æ­¥éª¤ 1/3ï¼šé€‰æ‹© AI æä¾›å•†');
    $('#stepDesc').text('é€‰æ‹©ä½ æƒ³ä½¿ç”¨çš„ AI æœåŠ¡æä¾›å•†');
    $('#btnBack').hide();
    $('#btnNext').text('ä¸‹ä¸€æ­¥ â†’').prop('disabled', !selectedType);
}

function showStep2() {
    currentStep = 2;
    $('#step1, #step3').hide(); $('#step2').show();
    $('#stepTitle').text('æ­¥éª¤ 2/3ï¼šé€‰æ‹©æ¨¡å‹');
    $('#stepDesc').text('é€‰æ‹©é€‚åˆä½ éœ€æ±‚çš„æ¨¡å‹');
    $('#btnBack').show();
    $('#btnNext').text('ä¸‹ä¸€æ­¥ â†’').prop('disabled', true);
    
    $('#selectedProviderName').text(selectedProviderName);
    
    const models = modelOptions[selectedType] || [];
    let html = '';
    models.forEach(m => {
        html += `<div class="model-card ${m.recommended ? 'selected' : ''}" data-model="${m.id}">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div style="font-weight: 600; margin-bottom: 4px;">${m.name}${m.recommended ? ' â­' : ''}</div>
                    <div style="font-size: 12px; color: #666;">${m.desc}</div>
                </div>
                <div class="text-right">
                    <div style="font-size: 11px; color: #999;">${m.price}</div>
                    <div style="font-size: 11px; color: #999;">${m.context}</div>
                </div>
            </div>
        </div>`;
    });
    $('#modelsList').html(html);
    
    if (models.length > 0 && models[0].recommended) {
        selectedModel = models[0].id;
        $('#btnNext').prop('disabled', false);
    }
    
    $('.model-card').on('click', function() {
        $('.model-card').removeClass('selected');
        $(this).addClass('selected');
        selectedModel = $(this).data('model');
        $('#btnNext').prop('disabled', false);
    });
}

function showStep3() {
    currentStep = 3;
    $('#step1, #step2').hide(); $('#step3').show();
    $('#stepTitle').text('æ­¥éª¤ 3/3ï¼šé…ç½® API Key');
    $('#stepDesc').text('è¾“å…¥ API Key å®Œæˆé…ç½®');
    $('#btnNext').text('å®Œæˆé…ç½® âœ“');
    
    const modelName = modelOptions[selectedType].find(m => m.id === selectedModel)?.name || selectedModel;
    $('#step3ProviderInfo').text(`${selectedProviderName} - ${modelName}`);
    $('#apiKeyHelp').text(providerConfig[selectedType].help);
    $('#configNameInput').val(`${selectedProviderName} ${modelName}`);
    $('#baseUrlInput').val(providerConfig[selectedType].url);
    
    if (selectedType === 201) {
        $('#apiKeyInput').val('æœ¬åœ°è¿è¡Œï¼Œæ— éœ€å¯†é’¥').prop('disabled', true);
        $('#btnNext').prop('disabled', false);
    } else {
        $('#apiKeyInput').val('').prop('disabled', false);
        $('#btnNext').prop('disabled', true);
    }
}

$('#apiKeyInput').on('input', function() {
    $('#btnNext').prop('disabled', !$(this).val() && selectedType !== 201);
});

$('#btnPaste').on('click', async () => {
    try {
        const text = await navigator.clipboard.readText();
        $('#apiKeyInput').val(text.trim());
        $('#btnNext').prop('disabled', false);
    } catch (e) {
        toastr.error('æ— æ³•è®¿é—®å‰ªè´´æ¿');
    }
});

async function createProvider() {
    const data = {
        name: $('#configNameInput').val() || `${selectedProviderName} ${selectedModel}`,
        providerType: selectedType,
        modelId: selectedModel,
        baseUrl: $('#baseUrlInput').val() || providerConfig[selectedType].url,
        isEnabled: true,
        priority: 1,
        settings: { temperature: 0.7, maxTokens: 2000, timeoutSeconds: 60, maxRetries: 3 }
    };
    
    try {
        $('#btnNext').prop('disabled', true).text('é…ç½®ä¸­...');
        
        const resp = await fetch('@Url.Action("Create")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (!resp.ok) { toastr.error('åˆ›å»ºå¤±è´¥'); return; }
        
        const provider = await resp.json();
        
        if (selectedType !== 201 && $('#apiKeyInput').val()) {
            await fetch(`@Url.Action("AddApiKey")?id=${provider.id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ keyName: 'ä¸»å¯†é’¥', apiKey: $('#apiKeyInput').val() })
            });
        }
        
        $('#btnNext').text('æµ‹è¯•è¿æ¥...');
        const testResp = await fetch(`@Url.Action("TestConnection")?id=${provider.id}`, { method: 'POST' });
        const testResult = await testResp.json();
        
        if (testResult.isHealthy) {
            toastr.success('é…ç½®æˆåŠŸï¼æ­£åœ¨è·³è½¬...');
            setTimeout(() => window.location.replace('@Url.Action("Index")'), 1000);
        } else {
            toastr.warning('é…ç½®å·²ä¿å­˜ï¼Œä½†è¿æ¥æµ‹è¯•å¤±è´¥ã€‚æ­£åœ¨è·³è½¬...');
            setTimeout(() => window.location.replace('@Url.Action("Index")'), 2000);
        }
    } catch (e) {
        toastr.error('åˆ›å»ºå¤±è´¥: ' + e);
        $('#btnNext').prop('disabled', false).text('å®Œæˆé…ç½® âœ“');
    }
}
</script>
}
