@{
    ViewData["Title"] = "AI 提供商管理";
}

<div class="row mb-3">
    <div class="col-12">
        <div class="btn-group">
            <a href="@Url.Action("QuickSetup")" class="btn btn-primary"><i class="fas fa-magic mr-1"></i>快速设置</a>
            <button id="btn-refresh" class="btn btn-secondary"><i class="fas fa-sync-alt mr-1"></i>刷新</button>
        </div>
    </div>
</div>

<div id="emptyState" class="card" style="display:none;">
    <div class="card-body text-center py-5">
        <i class="fas fa-robot fa-4x text-muted mb-3"></i>
        <h5>还没有配置 AI 提供商</h5>
        <p class="text-muted">点击「快速设置」开始配置你的第一个 AI 提供商</p>
        <a href="@Url.Action("QuickSetup")" class="btn btn-primary mt-2"><i class="fas fa-magic mr-1"></i>快速设置</a>
    </div>
</div>

<div id="providersList" class="row"></div>

@section Scripts {
<script>
const providerTypeColors = {
    1: '#10A37F',    // OpenAI
    2: '#10A37F',    // AzureOpenAI
    3: '#4285F4',    // GoogleGemini
    4: '#D97757',    // AnthropicClaude
    5: '#624AFF',    // Cohere
    6: '#00D4AA',    // MistralAI
    101: '#FF6A00',  // AlibabaQwen
    102: '#2932E1',  // BaiduErnie
    103: '#006EFF',  // TencentHunyuan
    104: '#1E88E5',  // ZhipuGLM
    105: '#FF6A00',  // XunfeiSpark
    106: '#7C3AED',  // MoonshotAI
    107: '#FF6A00',  // MiniMax
    108: '#FF6A00',  // ZeroOneYi
    109: '#624AFF',  // ModelScope
    110: '#00D4AA',  // SiliconFlow
    201: '#6B7280',  // Ollama
    202: '#6B7280',  // LMStudio
    203: '#6B7280'   // LocalAI
};

const providerTypeNames = {
    1: 'OpenAI', 2: 'Azure OpenAI', 3: 'Google Gemini', 4: 'Claude', 5: 'Cohere', 6: 'Mistral AI',
    101: '通义千问', 102: '文心一言', 103: '腾讯混元', 104: '智谱 GLM', 105: '讯飞星火',
    106: 'Moonshot', 107: 'MiniMax', 108: '零一万物', 109: '魔塔社区', 110: '硅基流动',
    201: 'Ollama', 202: 'LM Studio', 203: 'LocalAI'
};

async function loadProviders() {
    try {
        const resp = await fetch('@Url.Action("GetAll")' + '?t=' + new Date().getTime());
        const providers = await resp.json();
        
        // 完全移除并重新创建容器
        const container = document.getElementById('providersList');
        const parent = container.parentNode;
        const newContainer = document.createElement('div');
        newContainer.id = 'providersList';
        newContainer.className = 'row';
        parent.replaceChild(newContainer, container);
        
        if (!providers || providers.length === 0) {
            $('#emptyState').show();
            $('#providersList').hide();
            return;
        }

        $('#emptyState').hide();
        $('#providersList').show();

        // 构建所有卡片的 HTML
        let html = '';
        providers.forEach(p => {
            const color = providerTypeColors[p.providerType] || '#0078D4';
            const typeName = providerTypeNames[p.providerType] || 'Unknown';
            
            html += `
                <div class="col-12 col-md-6 col-lg-4 mb-3" data-provider-id="${p.id}">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">${p.name}</h5>
                                <span class="badge" style="background-color:${color}">${typeName}</span>
                            </div>
                            <p class="text-muted small mb-2">${p.modelId}</p>
                            <div class="mb-2">
                                <span class="badge badge-${p.isEnabled ? 'success' : 'secondary'}">${p.isEnabled ? '启用' : '禁用'}</span>
                                <span class="badge badge-info">${p.apiKeyCount} 个密钥</span>
                                <span class="badge badge-light">今日 ${p.todayUsage} 次</span>
                            </div>
                            <div class="btn-group btn-group-sm w-100">
                                <a href="@Url.Action("Edit")?id=${p.id}" class="btn btn-outline-primary">编辑</a>
                                <button onclick="testProvider(${p.id})" class="btn btn-outline-success">测试</button>
                                <button onclick="deleteProvider(${p.id})" class="btn btn-outline-danger">删除</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        // 一次性设置所有 HTML
        document.getElementById('providersList').innerHTML = html;
        
        console.log('Loaded providers:', providers.length);
    } catch (e) {
        toastr.error('加载失败: ' + e);
        console.error('Load providers error:', e);
    }
}

async function testProvider(id) {
    try {
        const resp = await fetch('@Url.Action("TestConnection")?id=' + id, { method: 'POST' });
        const result = await resp.json();
        if (result.isHealthy) {
            toastr.success(`连接成功 (${result.responseTimeMs}ms)`);
        } else {
            toastr.error('连接失败: ' + result.message);
        }
    } catch (e) {
        toastr.error('测试失败: ' + e);
    }
}

async function deleteProvider(id) {
    if (!confirm('确定要删除这个 AI 提供商吗？\n\n删除后将无法恢复。')) return;
    try {
        const resp = await fetch('@Url.Action("Delete")?id=' + id, { method: 'DELETE' });
        if (resp.ok) {
            toastr.success('删除成功，正在刷新...');
            // 删除成功后直接刷新整个页面
            setTimeout(() => {
                window.location.reload(true);
            }, 500);
        } else {
            const error = await resp.text();
            toastr.error('删除失败: ' + error);
        }
    } catch (e) {
        toastr.error('删除失败: ' + e);
    }
}

$('#btn-refresh').on('click', loadProviders);
$(document).ready(loadProviders);
</script>
}
