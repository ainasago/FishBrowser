@{
    Layout = "_LayoutAdmin";
    ViewData["Title"] = "åˆ†ç»„ç®¡ç†";
}

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="row mb-3">
            <div class="col-12">
                <button type="button" class="btn btn-primary" onclick="showCreateModal()">
                    <i class="fas fa-plus"></i> æ–°å»ºåˆ†ç»„
                </button>
                <button type="button" class="btn btn-secondary ml-2" onclick="refreshGroups()">
                    <i class="fas fa-sync"></i> åˆ·æ–°
                </button>
            </div>
        </div>

        <!-- åˆ†ç»„åˆ—è¡¨ -->
        <div class="row" id="groupsContainer">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ“ æµè§ˆå™¨åˆ†ç»„</h3>
                    </div>
                    <div class="card-body">
                        <div id="groupsGrid" class="row">
                            <!-- åˆ†ç»„å¡ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                        <div id="loadingSpinner" class="text-center" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...
                        </div>
                        <div id="emptyMessage" class="text-center text-muted" style="display: none;">
                            <i class="fas fa-folder-open fa-3x mb-3"></i>
                            <p>æš‚æ— åˆ†ç»„ï¼Œç‚¹å‡»"æ–°å»ºåˆ†ç»„"åˆ›å»ºç¬¬ä¸€ä¸ªåˆ†ç»„</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- åˆ›å»º/ç¼–è¾‘åˆ†ç»„æ¨¡æ€æ¡† -->
<div class="modal fade" id="groupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="modalTitle">æ–°å»ºåˆ†ç»„</h4>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="groupForm">
                    <input type="hidden" id="groupId" value="">
                    
                    <div class="form-group">
                        <label for="groupName">åˆ†ç»„åç§° <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="groupName" placeholder="è¾“å…¥åˆ†ç»„åç§°" required>
                    </div>

                    <div class="form-group">
                        <label for="groupDescription">æè¿°</label>
                        <textarea class="form-control" id="groupDescription" rows="3" placeholder="è¾“å…¥åˆ†ç»„æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="groupIcon">å›¾æ ‡</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">
                                    <i id="iconPreview" class="fas fa-folder"></i>
                                </span>
                            </div>
                            <input type="text" class="form-control" id="groupIcon" value="fas fa-folder" placeholder="FontAwesome å›¾æ ‡ç±»å">
                        </div>
                        <small class="form-text text-muted">
                            å¸¸ç”¨å›¾æ ‡ï¼š
                            <span class="badge badge-light cursor-pointer" onclick="setIcon('fas fa-folder')"><i class="fas fa-folder"></i> folder</span>
                            <span class="badge badge-light cursor-pointer" onclick="setIcon('fas fa-users')"><i class="fas fa-users"></i> users</span>
                            <span class="badge badge-light cursor-pointer" onclick="setIcon('fas fa-globe')"><i class="fas fa-globe"></i> globe</span>
                            <span class="badge badge-light cursor-pointer" onclick="setIcon('fas fa-desktop')"><i class="fas fa-desktop"></i> desktop</span>
                            <span class="badge badge-light cursor-pointer" onclick="setIcon('fas fa-mobile')"><i class="fas fa-mobile"></i> mobile</span>
                            <span class="badge badge-light cursor-pointer" onclick="setIcon('fas fa-laptop')"><i class="fas fa-laptop"></i> laptop</span>
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveGroup()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Toastr CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <!-- Toastr JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <script>
        let allGroups = [];

        $(document).ready(function() {
            loadGroups();

            // å›¾æ ‡è¾“å…¥æ¡†å˜åŒ–æ—¶æ›´æ–°é¢„è§ˆ
            $('#groupIcon').on('input', function() {
                updateIconPreview();
            });
        });

        // åŠ è½½åˆ†ç»„åˆ—è¡¨
        function loadGroups() {
            $('#loadingSpinner').show();
            $('#emptyMessage').hide();
            $('#groupsGrid').empty();

            $.ajax({
                url: '@Url.Action("GetGroups")',
                method: 'GET',
                success: function(response) {
                    $('#loadingSpinner').hide();
                    
                    if (response.success && response.data) {
                        allGroups = response.data;
                        displayGroups(allGroups);
                    } else {
                        showError('åŠ è½½åˆ†ç»„å¤±è´¥: ' + (response.error || 'æœªçŸ¥é”™è¯¯'));
                        $('#emptyMessage').show();
                    }
                },
                error: function(xhr) {
                    $('#loadingSpinner').hide();
                    if (xhr.status === 401) {
                        window.location.href = '@Url.Action("Login", "Auth")';
                    } else {
                        showError('åŠ è½½åˆ†ç»„å¤±è´¥');
                        $('#emptyMessage').show();
                    }
                }
            });
        }

        // æ˜¾ç¤ºåˆ†ç»„
        function displayGroups(groups) {
            if (!groups || groups.length === 0) {
                $('#emptyMessage').show();
                return;
            }

            const html = groups.map(group => `
                <div class="col-md-4 col-sm-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">
                                    <i class="${group.icon || 'fas fa-folder'}"></i>
                                    ${escapeHtml(group.name)}
                                </h5>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <div class="dropdown-menu">
                                        <a class="dropdown-item" href="#" onclick="editGroup(${group.id})">
                                            <i class="fas fa-edit"></i> ç¼–è¾‘
                                        </a>
                                        <a class="dropdown-item text-danger" href="#" onclick="deleteGroup(${group.id}, '${escapeHtml(group.name)}')">
                                            <i class="fas fa-trash"></i> åˆ é™¤
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <p class="card-text text-muted small">${escapeHtml(group.description || 'æš‚æ— æè¿°')}</p>
                            <div class="mt-auto">
                                <span class="badge badge-info">
                                    <i class="fas fa-browser"></i> ${group.browserCount || 0} ä¸ªæµè§ˆå™¨
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            $('#groupsGrid').html(html);
        }

        // æ˜¾ç¤ºåˆ›å»ºæ¨¡æ€æ¡†
        function showCreateModal() {
            $('#modalTitle').text('æ–°å»ºåˆ†ç»„');
            $('#groupId').val('');
            $('#groupName').val('');
            $('#groupDescription').val('');
            $('#groupIcon').val('fas fa-folder');
            updateIconPreview();
            $('#groupModal').modal('show');
        }

        // ç¼–è¾‘åˆ†ç»„
        function editGroup(id) {
            const group = allGroups.find(g => g.id === id);
            if (!group) return;

            $('#modalTitle').text('ç¼–è¾‘åˆ†ç»„');
            $('#groupId').val(group.id);
            $('#groupName').val(group.name);
            $('#groupDescription').val(group.description || '');
            $('#groupIcon').val(group.icon || 'fas fa-folder');
            updateIconPreview();
            $('#groupModal').modal('show');
        }

        // ä¿å­˜åˆ†ç»„
        function saveGroup() {
            const id = $('#groupId').val();
            const name = $('#groupName').val().trim();
            const description = $('#groupDescription').val().trim();
            const icon = $('#groupIcon').val().trim();

            if (!name) {
                showError('è¯·è¾“å…¥åˆ†ç»„åç§°');
                return;
            }

            const data = {
                name: name,
                description: description || null,
                icon: icon || 'fas fa-folder'
            };

            const url = id ? '@Url.Action("UpdateGroup")' : '@Url.Action("CreateGroup")';
            const method = id ? 'PUT' : 'POST';
            const urlWithId = id ? url + '?id=' + id : url;

            $.ajax({
                url: urlWithId,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.success) {
                        $('#groupModal').modal('hide');
                        showSuccess(id ? 'åˆ†ç»„æ›´æ–°æˆåŠŸ' : 'åˆ†ç»„åˆ›å»ºæˆåŠŸ');
                        loadGroups();
                    } else {
                        showError(response.error || 'æ“ä½œå¤±è´¥');
                    }
                },
                error: function() {
                    showError('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            });
        }

        // åˆ é™¤åˆ†ç»„
        function deleteGroup(id, name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç»„"${name}"å—ï¼Ÿ\næ³¨æ„ï¼šåªèƒ½åˆ é™¤ç©ºåˆ†ç»„ï¼ˆä¸åŒ…å«æµè§ˆå™¨çš„åˆ†ç»„ï¼‰`)) {
                return;
            }

            $.ajax({
                url: '@Url.Action("DeleteGroup")?id=' + id,
                method: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        showSuccess('åˆ†ç»„åˆ é™¤æˆåŠŸ');
                        loadGroups();
                    } else {
                        showError(response.error || 'åˆ é™¤å¤±è´¥');
                    }
                },
                error: function() {
                    showError('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            });
        }

        // åˆ·æ–°åˆ†ç»„åˆ—è¡¨
        function refreshGroups() {
            loadGroups();
        }

        // è®¾ç½®å›¾æ ‡
        function setIcon(iconClass) {
            $('#groupIcon').val(iconClass);
            updateIconPreview();
        }

        // æ›´æ–°å›¾æ ‡é¢„è§ˆ
        function updateIconPreview() {
            const iconClass = $('#groupIcon').val() || 'fas fa-folder';
            $('#iconPreview').attr('class', iconClass);
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            if (typeof toastr !== 'undefined') {
                toastr.success(message);
            } else {
                alert('æˆåŠŸ: ' + message);
            }
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            if (typeof toastr !== 'undefined') {
                toastr.error(message);
            } else {
                alert('é”™è¯¯: ' + message);
            }
        }
    </script>

    <style>
        .cursor-pointer {
            cursor: pointer;
        }
        
        .badge.cursor-pointer:hover {
            background-color: #007bff !important;
            color: white !important;
        }
        
        .card {
            transition: transform 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
}
