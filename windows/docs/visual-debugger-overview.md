# AI 可视化脚本调试器 - 总体概述

## 📅 创建日期
2025-10-31

## 🎯 目标

为普通用户提供一个可视化的 DSL 脚本调试环境，无需手写代码即可创建、调试和优化网页自动化任务。通过 AI 辅助，用户可以：
- 在内嵌浏览器中实时查看脚本执行
- 通过点击页面元素生成选择器
- 让 AI 观察浏览器状态并自动修复脚本错误
- 录制用户操作自动生成 DSL 脚本

---

## 🏗️ 架构设计

### 三栏布局

```
┌─────────────────────────────────────────────────────────────┐
│  AI 脚本调试工作台                                            │
├──────────┬────────────────────────┬─────────────────────────┤
│          │                        │                         │
│  左栏    │       中栏             │        右栏             │
│  YAML    │    嵌入式浏览器         │      AI 助手            │
│  编辑器  │    (WebView2)          │    聊天 + 上下文        │
│          │                        │                         │
│  - 语法  │  - 实时渲染            │  - 对话历史             │
│    高亮  │  - 选择器拾取          │  - 浏览器状态           │
│  - 实时  │  - 元素高亮            │  - 错误诊断             │
│    校验  │  - 控制台/网络         │  - 一键修复             │
│  - 错误  │  - 截图预览            │  - 建议应用             │
│    提示  │                        │                         │
│          │                        │                         │
│  [运行]  │  [拾取] [录制] [截图]  │  [分享上下文] [应用]    │
│  [单步]  │                        │                         │
│  [停止]  │                        │                         │
└──────────┴────────────────────────┴─────────────────────────┘
```

---

## 🔑 核心功能

### 1. 可视化执行
- **实时预览**：DSL 步骤在内嵌浏览器中执行，用户可见
- **单步调试**：逐步执行，每步前暂停，允许修改
- **断点支持**：在特定步骤设置断点
- **执行高亮**：当前执行的步骤在左侧高亮显示

### 2. 选择器拾取器
- **悬停高亮**：鼠标悬停在页面元素上时高亮显示
- **点击生成**：点击元素自动生成稳健的 selector
- **多种策略**：CSS、XPath、Text、Placeholder、Role
- **优先级排序**：优先使用 ID、data-testid、稳定的 class

### 3. 录制模式
- **操作捕获**：记录用户在浏览器中的点击、输入、导航
- **自动生成 DSL**：将操作序列转换为 YAML 脚本
- **智能合并**：合并相似操作，优化脚本结构

### 4. AI 辅助修复
- **上下文感知**：AI 能看到截图、DOM 结构、错误日志
- **自动诊断**：分析失败原因，提出修复建议
- **一键应用**：用户确认后自动应用 AI 生成的补丁
- **迭代优化**：持续运行-失败-修复循环直到成功

---

## 🛠️ 技术栈

### 浏览器内嵌
- **WebView2**：Microsoft Edge WebView2 控件
  - 原生 WPF 集成
  - 完整的 Chromium 引擎
  - DevTools Protocol 支持
  - 性能优秀，稳定可靠

### 浏览器控制抽象
- **IBrowserController** 接口：
  - `PlaywrightController`：生产运行（无头/有头）
  - `WebView2Controller`：调试模式（内嵌 UI）
  - 统一 API：Navigate、Click、Fill、Wait、Screenshot

### AI 集成
- **结构化上下文**：
  - 错误信息 + 调用栈
  - 最近日志（最后 N 行）
  - 浏览器截图（缩略）
  - DOM 摘要（限制大小）
  - 失败步骤的 DSL 片段
- **受限命令集**：
  - `propose_patch`：YAML 补丁
  - `suggest_selector`：选择器候选
  - `run_step`：执行特定步骤
- **安全沙箱**：
  - 只接受 JSON schema 验证的回复
  - 用户确认后才应用修改
  - 脱敏处理（密码、token 等）

---

## 📊 工作流程

### 典型使用场景

#### 场景 1：从零创建脚本
1. 用户点击"AI 脚本助手"打开工作台
2. 在右侧输入任务描述："登录 example.com"
3. AI 生成初始 DSL 脚本 → 左侧编辑器
4. 点击"运行" → 中间浏览器执行
5. 如果失败：
   - AI 自动分析上下文
   - 提出修复建议
   - 用户点击"应用" → 脚本更新
6. 重复直到成功 → 保存任务

#### 场景 2：录制操作
1. 点击"录制模式"
2. 在中间浏览器中手动操作：
   - 打开 URL
   - 点击按钮
   - 填写表单
   - 提交
3. 点击"停止录制"
4. 左侧自动生成 DSL 脚本
5. 用户微调 → 保存

#### 场景 3：修复现有脚本
1. 从历史任务加载 DSL
2. 点击"运行" → 发现某步失败
3. 点击"拾取选择器" → 在浏览器中点击正确元素
4. 新选择器自动替换失败步骤
5. 继续运行 → 成功

---

## 🚀 实现里程碑

### M1: 基础可视化调试（1-2 天）
- ✅ 三栏布局 UI
- ✅ WebView2 集成
- ✅ IBrowserController 抽象
- ✅ WebView2Controller 基本实现
- ✅ DslExecutor 支持 IBrowserController
- ✅ 运行/单步/停止控制

### M2: 选择器拾取 & 录制（2-3 天）
- ⏳ 注入 Overlay JS（元素高亮）
- ⏳ 选择器生成策略
- ⏳ 录制模式（捕获 DOM 事件）
- ⏳ 操作转 DSL 逻辑

### M3: AI 辅助回路（2-3 天）
- ⏳ Debug Context 构建
- ⏳ AI 提示词模板
- ⏳ 结构化命令解析
- ⏳ 一键应用补丁
- ⏳ 迭代修复流程

### M4: 增强功能（1-2 天）
- ⏳ 网络/控制台日志面板
- ⏳ 执行时间线
- ⏳ 断点管理
- ⏳ YAML 语法高亮

---

## 🔒 安全与隐私

### 数据脱敏
- 自动检测并隐藏：
  - 密码字段（`type="password"`）
  - Token/API Key 模式
  - 信用卡号、身份证号
- 用户可配置脱敏规则

### 上下文限制
- 截图：最大 500KB，压缩质量 70%
- DOM 文本：最大 50KB，截断并标记
- 日志：最近 100 行
- 仅在用户点击"分享上下文"时发送

### 权限控制
- AI 只能提出建议，不能直接执行
- 所有修改需用户确认
- 可完全关闭 AI 访问浏览器内容

---

## 📝 相关文档

- [架构设计详细说明](./workbench-architecture.md)
- [WebView2Controller 实现指南](./webview2-controller-guide.md)
- [选择器拾取器设计](./selector-picker-design.md)
- [AI 调试上下文协议](./ai-debug-context-protocol.md)
- [录制模式实现](./recording-mode-implementation.md)

---

## 🎯 成功指标

- **易用性**：非技术用户能在 10 分钟内创建第一个任务
- **准确性**：AI 修复建议的采纳率 > 70%
- **效率**：相比手写 DSL，创建时间减少 80%
- **稳定性**：调试模式下脚本执行成功率 > 95%

---

## 🔄 后续演进

### Phase 2 功能
- 多浏览器支持（Firefox、Safari）
- 协作模式（多人编辑同一脚本）
- 脚本市场（分享/导入社区脚本）
- 可视化流程图编辑器

### Phase 3 功能
- 自然语言转 DSL（无需手动编辑）
- 智能等待策略（自动检测页面加载完成）
- 异常恢复（自动重试、回退）
- 性能分析（步骤耗时、瓶颈识别）

---

**状态**：设计完成，待实现
**负责人**：开发团队
**优先级**：P0（核心功能）
