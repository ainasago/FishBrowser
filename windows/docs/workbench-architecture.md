# AI è„šæœ¬è°ƒè¯•å·¥ä½œå° - æ¶æ„è®¾è®¡

## ğŸ“… åˆ›å»ºæ—¥æœŸ
2025-10-31

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### åˆ†å±‚è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Presentation Layer                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         AIDebugWorkbench.xaml (WPF View)             â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  YAML    â”‚   WebView2       â”‚   AI Chat        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Editor  â”‚   Browser        â”‚   Panel          â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Service Layer                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ DslExecutor  â”‚  â”‚ AIDebugger   â”‚  â”‚ Recorder     â”‚      â”‚
â”‚  â”‚   Service    â”‚  â”‚   Service    â”‚  â”‚   Service    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Browser Abstraction Layer                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              IBrowserController (Interface)          â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ PlaywrightControllerâ”‚  â”‚ WebView2Controller   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  (Production)       â”‚  â”‚  (Debug Mode)        â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Browser Engines                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Playwright        â”‚  â”‚  WebView2 (Edge Chromium)    â”‚   â”‚
â”‚  â”‚  (Chromium/FF/WK)  â”‚  â”‚  + DevTools Protocol         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§© æ ¸å¿ƒç»„ä»¶

### 1. AIDebugWorkbench (View)

**èŒè´£**ï¼šä¸» UI å®¹å™¨ï¼Œåè°ƒä¸‰æ äº¤äº’

**ç»„ä»¶**ï¼š
- `YamlEditorPanel`ï¼šå·¦ä¾§ YAML ç¼–è¾‘å™¨
  - TextBox + è¯­æ³•é«˜äº®ï¼ˆAvalonEdit æˆ–è‡ªå®šä¹‰ï¼‰
  - å®æ—¶æ ¡éªŒï¼ˆè°ƒç”¨ `DslParser`ï¼‰
  - é”™è¯¯/è­¦å‘Šæ ‡è®°
  - å½“å‰æ‰§è¡Œè¡Œé«˜äº®
- `BrowserPanel`ï¼šä¸­é—´æµè§ˆå™¨é¢æ¿
  - WebView2 æ§ä»¶
  - å·¥å…·æ ï¼šæ‹¾å–ã€å½•åˆ¶ã€æˆªå›¾ã€åˆ·æ–°
  - è¦†ç›–å±‚ï¼šå…ƒç´ é«˜äº®ã€é€‰æ‹©å™¨æ˜¾ç¤º
- `AIChatPanel`ï¼šå³ä¾§ AI åŠ©æ‰‹
  - å¯¹è¯å†å²ï¼ˆScrollViewer + ItemsControlï¼‰
  - ä¸Šä¸‹æ–‡å¡ç‰‡ï¼ˆæˆªå›¾ã€æ—¥å¿—ã€é”™è¯¯ï¼‰
  - è¾“å…¥æ¡† + å‘é€æŒ‰é’®
  - æ“ä½œæŒ‰é’®ï¼šåº”ç”¨è¡¥ä¸ã€é‡æ–°ç”Ÿæˆ

**å…³é”®æ–¹æ³•**ï¼š
```csharp
public partial class AIDebugWorkbench : Page
{
    private WebView2Controller _browserController;
    private DslExecutor _executor;
    private AIDebuggerService _aiDebugger;
    private RecorderService _recorder;
    
    // è¿è¡Œæ•´ä¸ªè„šæœ¬
    private async Task RunScript();
    
    // å•æ­¥æ‰§è¡Œ
    private async Task StepNext();
    
    // åœæ­¢æ‰§è¡Œ
    private void StopExecution();
    
    // å¼€å¯é€‰æ‹©å™¨æ‹¾å–æ¨¡å¼
    private void StartPickerMode();
    
    // å¼€å¯å½•åˆ¶æ¨¡å¼
    private void StartRecording();
    
    // ä¸ AI åˆ†äº«å½“å‰ä¸Šä¸‹æ–‡
    private async Task ShareContextWithAI();
    
    // åº”ç”¨ AI å»ºè®®çš„è¡¥ä¸
    private void ApplyAIPatch(string yamlPatch);
}
```

---

### 2. IBrowserController (Interface)

**èŒè´£**ï¼šç»Ÿä¸€æµè§ˆå™¨æ§åˆ¶ APIï¼Œæ”¯æŒå¤šç§åç«¯

**æ¥å£å®šä¹‰**ï¼š
```csharp
public interface IBrowserController : IAsyncDisposable
{
    // åˆå§‹åŒ–
    Task InitializeAsync(FingerprintProfile? fingerprint = null, bool headless = false);
    
    // å¯¼èˆª
    Task NavigateAsync(string url, int timeoutMs = 30000);
    
    // å…ƒç´ äº¤äº’
    Task ClickAsync(string selector, int timeoutMs = 30000);
    Task FillAsync(string selector, string value, int timeoutMs = 30000);
    Task TypeAsync(string selector, string text, int delayMs = 100);
    
    // ç­‰å¾…
    Task WaitForSelectorAsync(string selector, int timeoutMs = 30000);
    Task WaitForNavigationAsync(int timeoutMs = 30000);
    Task WaitForLoadStateAsync(LoadState state = LoadState.NetworkIdle);
    
    // å†…å®¹è·å–
    Task<string> GetContentAsync();
    Task<string> GetTextContentAsync(string selector);
    Task<string> GetAttributeAsync(string selector, string attribute);
    
    // æˆªå›¾
    Task<byte[]> ScreenshotAsync(string? filePath = null);
    Task<byte[]> ScreenshotElementAsync(string selector);
    
    // è„šæœ¬æ‰§è¡Œ
    Task<object?> EvaluateAsync(string script);
    Task<T?> EvaluateAsync<T>(string script);
    
    // äº‹ä»¶
    event EventHandler<ConsoleMessageEventArgs> ConsoleMessage;
    event EventHandler<RequestEventArgs> RequestSent;
    event EventHandler<ResponseEventArgs> ResponseReceived;
    event EventHandler<string> PageLoaded;
    
    // çŠ¶æ€
    string? CurrentUrl { get; }
    bool IsInitialized { get; }
}
```

---

### 3. WebView2Controller (Implementation)

**èŒè´£**ï¼šåœ¨ WPF WebView2 æ§ä»¶ä¸­å®ç° IBrowserController

**æ ¸å¿ƒå®ç°**ï¼š
```csharp
public class WebView2Controller : IBrowserController
{
    private readonly WebView2 _webView;
    private readonly ILogService _logger;
    
    public WebView2Controller(WebView2 webView, ILogService logger)
    {
        _webView = webView;
        _logger = logger;
    }
    
    public async Task InitializeAsync(FingerprintProfile? fingerprint = null, bool headless = false)
    {
        await _webView.EnsureCoreWebView2Async();
        
        // è®¢é˜…äº‹ä»¶
        _webView.CoreWebView2.ConsoleMessageReceived += OnConsoleMessage;
        _webView.CoreWebView2.WebResourceRequested += OnResourceRequested;
        
        // æ³¨å…¥æŒ‡çº¹è„šæœ¬ï¼ˆå¦‚æœæä¾›ï¼‰
        if (fingerprint != null)
        {
            var script = new FingerprintManager().GenerateInjectionScript(fingerprint);
            await _webView.CoreWebView2.AddScriptToExecuteOnDocumentCreatedAsync(script);
        }
        
        _logger.LogInfo("WebView2Controller", "Initialized");
    }
    
    public async Task NavigateAsync(string url, int timeoutMs = 30000)
    {
        var tcs = new TaskCompletionSource<bool>();
        var cts = new CancellationTokenSource(timeoutMs);
        
        void OnNavigationCompleted(object? s, CoreWebView2NavigationCompletedEventArgs e)
        {
            _webView.CoreWebView2.NavigationCompleted -= OnNavigationCompleted;
            tcs.TrySetResult(e.IsSuccess);
        }
        
        _webView.CoreWebView2.NavigationCompleted += OnNavigationCompleted;
        _webView.CoreWebView2.Navigate(url);
        
        await tcs.Task;
    }
    
    public async Task ClickAsync(string selector, int timeoutMs = 30000)
    {
        // ä½¿ç”¨ DevTools Protocol æˆ– JS æ‰§è¡Œ
        var script = $@"
            (function() {{
                const el = document.querySelector('{selector}');
                if (!el) throw new Error('Element not found: {selector}');
                el.click();
                return true;
            }})();
        ";
        await EvaluateAsync(script);
    }
    
    public async Task FillAsync(string selector, string value, int timeoutMs = 30000)
    {
        var escapedValue = value.Replace("'", "\\'");
        var script = $@"
            (function() {{
                const el = document.querySelector('{selector}');
                if (!el) throw new Error('Element not found: {selector}');
                el.value = '{escapedValue}';
                el.dispatchEvent(new Event('input', {{ bubbles: true }}));
                el.dispatchEvent(new Event('change', {{ bubbles: true }}));
                return true;
            }})();
        ";
        await EvaluateAsync(script);
    }
    
    public async Task<byte[]> ScreenshotAsync(string? filePath = null)
    {
        // WebView2 æˆªå›¾éœ€è¦ä½¿ç”¨ DevTools Protocol
        var result = await _webView.CoreWebView2.CallDevToolsProtocolMethodAsync(
            "Page.captureScreenshot",
            "{\"format\":\"png\",\"quality\":90}"
        );
        
        var json = JsonDocument.Parse(result);
        var base64 = json.RootElement.GetProperty("data").GetString();
        var bytes = Convert.FromBase64String(base64!);
        
        if (!string.IsNullOrEmpty(filePath))
        {
            await File.WriteAllBytesAsync(filePath, bytes);
        }
        
        return bytes;
    }
    
    public async Task<T?> EvaluateAsync<T>(string script)
    {
        var result = await _webView.CoreWebView2.ExecuteScriptAsync(script);
        return JsonSerializer.Deserialize<T>(result);
    }
    
    // ... å…¶ä»–æ–¹æ³•å®ç°
}
```

---

### 4. AIDebuggerService

**èŒè´£**ï¼šæ„å»ºè°ƒè¯•ä¸Šä¸‹æ–‡ï¼Œä¸ AI äº¤äº’ï¼Œè§£æ AI å»ºè®®

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```csharp
public class AIDebuggerService
{
    private readonly AIClientService _aiClient;
    private readonly ILogService _logger;
    
    // æ„å»ºè°ƒè¯•ä¸Šä¸‹æ–‡
    public async Task<DebugContext> BuildContextAsync(
        DslFlow flow,
        int failedStepIndex,
        Exception error,
        IBrowserController browser,
        List<string> recentLogs)
    {
        var screenshot = await browser.ScreenshotAsync();
        var dom = await GetDOMSummaryAsync(browser);
        
        return new DebugContext
        {
            FlowName = flow.Name,
            FailedStep = flow.Steps[failedStepIndex],
            FailedStepIndex = failedStepIndex,
            ErrorMessage = error.Message,
            ErrorStack = error.StackTrace,
            CurrentUrl = browser.CurrentUrl,
            Screenshot = screenshot,
            DOMSummary = dom,
            RecentLogs = recentLogs.TakeLast(50).ToList(),
            PreviousSteps = flow.Steps.Take(failedStepIndex).ToList(),
            NextSteps = flow.Steps.Skip(failedStepIndex + 1).Take(2).ToList()
        };
    }
    
    // è¯·æ±‚ AI ä¿®å¤å»ºè®®
    public async Task<AIDebugSuggestion> GetFixSuggestionAsync(DebugContext context)
    {
        var prompt = BuildDebugPrompt(context);
        var response = await _aiClient.SendMessageAsync(prompt);
        
        return ParseAISuggestion(response);
    }
    
    // åº”ç”¨ YAML è¡¥ä¸
    public string ApplyYamlPatch(string originalYaml, string patch)
    {
        // ç®€å•å®ç°ï¼šæ›¿æ¢ç‰¹å®šè¡Œæˆ–æ­¥éª¤
        // å¤æ‚å®ç°ï¼šä½¿ç”¨ YAML diff/patch åº“
        return patch; // ä¸´æ—¶è¿”å›æ•´ä¸ªè¡¥ä¸
    }
    
    private string BuildDebugPrompt(DebugContext context)
    {
        return $@"
ä½ æ˜¯ä¸€ä¸ªç½‘é¡µè‡ªåŠ¨åŒ–è„šæœ¬è°ƒè¯•ä¸“å®¶ã€‚ç”¨æˆ·çš„ DSL è„šæœ¬åœ¨æ‰§è¡Œæ—¶å¤±è´¥äº†ï¼Œè¯·åˆ†æé—®é¢˜å¹¶æä¾›ä¿®å¤å»ºè®®ã€‚

**ä»»åŠ¡ä¿¡æ¯**ï¼š
- ä»»åŠ¡åç§°ï¼š{context.FlowName}
- å½“å‰ URLï¼š{context.CurrentUrl}

**å¤±è´¥æ­¥éª¤**ï¼ˆç¬¬ {context.FailedStepIndex + 1} æ­¥ï¼‰ï¼š
```yaml
{SerializeStep(context.FailedStep)}
```

**é”™è¯¯ä¿¡æ¯**ï¼š
{context.ErrorMessage}

**æœ€è¿‘æ—¥å¿—**ï¼ˆæœ€å 10 è¡Œï¼‰ï¼š
{string.Join("\n", context.RecentLogs.TakeLast(10))}

**é¡µé¢çŠ¶æ€**ï¼š
- æˆªå›¾å·²æä¾›ï¼ˆè§é™„ä»¶ï¼‰
- DOM æ‘˜è¦ï¼š{context.DOMSummary}

**è¯·æä¾›**ï¼š
1. é—®é¢˜è¯Šæ–­ï¼ˆä¸ºä»€ä¹ˆå¤±è´¥ï¼‰
2. ä¿®å¤å»ºè®®ï¼ˆå¦‚ä½•ä¿®æ”¹ DSLï¼‰
3. å¦‚æœéœ€è¦æ›´æ¢é€‰æ‹©å™¨ï¼Œæä¾›æ–°çš„ selector å»ºè®®

**è¾“å‡ºæ ¼å¼**ï¼ˆJSONï¼‰ï¼š
{{
  ""diagnosis"": ""é—®é¢˜åŸå› åˆ†æ"",
  ""suggestion"": ""ä¿®å¤å»ºè®®è¯´æ˜"",
  ""patch"": ""ä¿®å¤åçš„å®Œæ•´ YAML è„šæœ¬"",
  ""selectorSuggestions"": [
    {{ ""type"": ""css"", ""value"": ""..."", ""confidence"": 0.9 }}
  ]
}}
";
    }
}
```

---

### 5. RecorderService

**èŒè´£**ï¼šå½•åˆ¶ç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­çš„æ“ä½œï¼Œç”Ÿæˆ DSL

**æ ¸å¿ƒé€»è¾‘**ï¼š
```csharp
public class RecorderService
{
    private readonly IBrowserController _browser;
    private readonly List<RecordedAction> _actions = new();
    private bool _isRecording;
    
    public async Task StartRecordingAsync()
    {
        _isRecording = true;
        _actions.Clear();
        
        // æ³¨å…¥å½•åˆ¶è„šæœ¬
        await _browser.EvaluateAsync(@"
            window.__recorder = {
                actions: [],
                record: function(type, data) {
                    this.actions.push({ type, data, timestamp: Date.now() });
                    window.chrome.webview.postMessage({ 
                        type: 'recorded_action', 
                        action: { type, data } 
                    });
                }
            };
            
            // ç›‘å¬ç‚¹å‡»
            document.addEventListener('click', (e) => {
                const selector = getSelector(e.target);
                window.__recorder.record('click', { selector });
            }, true);
            
            // ç›‘å¬è¾“å…¥
            document.addEventListener('input', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    const selector = getSelector(e.target);
                    window.__recorder.record('fill', { 
                        selector, 
                        value: e.target.value 
                    });
                }
            }, true);
            
            // ç›‘å¬å¯¼èˆª
            const originalPushState = history.pushState;
            history.pushState = function() {
                originalPushState.apply(this, arguments);
                window.__recorder.record('navigate', { url: location.href });
            };
            
            function getSelector(el) {
                // ç”Ÿæˆç¨³å¥çš„é€‰æ‹©å™¨
                if (el.id) return '#' + el.id;
                if (el.getAttribute('data-testid')) 
                    return '[data-testid=""' + el.getAttribute('data-testid') + '""]';
                // ... æ›´å¤šç­–ç•¥
                return getCssPath(el);
            }
        ");
    }
    
    public async Task<string> StopRecordingAsync()
    {
        _isRecording = false;
        
        // è½¬æ¢ä¸º DSL
        var dsl = ConvertActionsToDsl(_actions);
        return dsl;
    }
    
    private string ConvertActionsToDsl(List<RecordedAction> actions)
    {
        var sb = new StringBuilder();
        sb.AppendLine("dslVersion: v1.0");
        sb.AppendLine($"id: recorded_{DateTime.Now:yyyyMMddHHmmss}");
        sb.AppendLine("name: å½•åˆ¶çš„ä»»åŠ¡");
        sb.AppendLine("steps:");
        
        foreach (var action in actions)
        {
            sb.AppendLine($"  - type: {action.Type}");
            if (action.Type == "navigate")
            {
                sb.AppendLine($"    url: {action.Data["url"]}");
            }
            else if (action.Type == "click")
            {
                sb.AppendLine($"    selector:");
                sb.AppendLine($"      type: css");
                sb.AppendLine($"      value: {action.Data["selector"]}");
            }
            else if (action.Type == "fill")
            {
                sb.AppendLine($"    selector:");
                sb.AppendLine($"      type: css");
                sb.AppendLine($"      value: {action.Data["selector"]}");
                sb.AppendLine($"    value: {action.Data["value"]}");
            }
        }
        
        return sb.ToString();
    }
}
```

---

## ğŸ”„ æ•°æ®æµ

### æ‰§è¡Œæµç¨‹
```
ç”¨æˆ·ç‚¹å‡»"è¿è¡Œ"
    â†“
AIDebugWorkbench.RunScript()
    â†“
DslParser.ValidateAndParseAsync(yaml)
    â†“
DslExecutor.ExecuteAsync(flow, webView2Controller, progress)
    â†“
[æ¯ä¸ªæ­¥éª¤]
    â†“
WebView2Controller.ClickAsync/FillAsync/...
    â†“
WebView2 æ‰§è¡Œ JS â†’ é¡µé¢æ›´æ–°
    â†“
[å¦‚æœå¤±è´¥]
    â†“
AIDebuggerService.BuildContextAsync(...)
    â†“
AIDebuggerService.GetFixSuggestionAsync(context)
    â†“
æ˜¾ç¤º AI å»ºè®® â†’ ç”¨æˆ·ç¡®è®¤
    â†“
ApplyYamlPatch(yaml, patch)
    â†“
é‡æ–°è¿è¡Œ
```

### å½•åˆ¶æµç¨‹
```
ç”¨æˆ·ç‚¹å‡»"å½•åˆ¶"
    â†“
RecorderService.StartRecordingAsync()
    â†“
æ³¨å…¥ç›‘å¬è„šæœ¬åˆ° WebView2
    â†“
ç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­æ“ä½œ
    â†“
JS æ•è·äº‹ä»¶ â†’ postMessage åˆ° .NET
    â†“
RecorderService æ”¶é›† actions
    â†“
ç”¨æˆ·ç‚¹å‡»"åœæ­¢"
    â†“
RecorderService.StopRecordingAsync()
    â†“
ConvertActionsToDsl(actions)
    â†“
YAML æ˜¾ç¤ºåœ¨å·¦ä¾§ç¼–è¾‘å™¨
```

---

## ğŸ“¦ æ–‡ä»¶ç»“æ„

```
WebScraperApp/
â”œâ”€â”€ Views/
â”‚   â”œâ”€â”€ AIDebugWorkbench.xaml
â”‚   â”œâ”€â”€ AIDebugWorkbench.xaml.cs
â”‚   â””â”€â”€ Controls/
â”‚       â”œâ”€â”€ YamlEditorControl.xaml
â”‚       â”œâ”€â”€ BrowserPanelControl.xaml
â”‚       â””â”€â”€ AIChatPanelControl.xaml
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ IBrowserController.cs
â”‚   â”œâ”€â”€ WebView2Controller.cs
â”‚   â”œâ”€â”€ AIDebuggerService.cs
â”‚   â””â”€â”€ RecorderService.cs
â”œâ”€â”€ Models/
â”‚   â”œâ”€â”€ DebugContext.cs
â”‚   â”œâ”€â”€ AIDebugSuggestion.cs
â”‚   â””â”€â”€ RecordedAction.cs
â””â”€â”€ Assets/
    â””â”€â”€ Scripts/
        â”œâ”€â”€ selector-picker.js
        â”œâ”€â”€ recorder.js
        â””â”€â”€ element-highlighter.js
```

---

## ğŸ”§ é…ç½®ä¸æ‰©å±•

### é…ç½®é¡¹
```json
{
  "debugger": {
    "maxScreenshotSize": 512000,
    "maxDOMTextLength": 51200,
    "maxLogLines": 100,
    "enableDataSanitization": true,
    "sanitizationRules": [
      { "pattern": "password", "action": "redact" },
      { "pattern": "token", "action": "redact" }
    ]
  }
}
```

### æ‰©å±•ç‚¹
- **è‡ªå®šä¹‰é€‰æ‹©å™¨ç­–ç•¥**ï¼šå®ç° `ISelectorStrategy`
- **è‡ªå®šä¹‰å½•åˆ¶è¿‡æ»¤å™¨**ï¼šå®ç° `IRecordingFilter`
- **AI æç¤ºè¯æ¨¡æ¿**ï¼šå¯é…ç½®çš„ Prompt æ¨¡æ¿

---

**çŠ¶æ€**ï¼šè®¾è®¡å®Œæˆ
**ä¸‹ä¸€æ­¥**ï¼šå¼€å§‹å®ç° M1 åŸºç¡€åŠŸèƒ½
