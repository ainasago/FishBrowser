# AI ä»»åŠ¡æµ‹è¯•è¿è¡Œå™¨ - å®ç°æ€»ç»“

## ğŸ“‹ å®ŒæˆçŠ¶æ€

### âœ… å·²å®Œæˆ

#### 1. æ•°æ®æ¨¡å‹ï¼ˆModelsï¼‰
- âœ… `TestRunOptions.cs` - æµ‹è¯•è¿è¡Œé€‰é¡¹
- âœ… `TestProgress.cs` - æµ‹è¯•è¿›åº¦ä¿¡æ¯ï¼ˆåŒ…å« TestStageã€LogLevel æšä¸¾ï¼‰
- âœ… `TestRunResult.cs` - æµ‹è¯•ç»“æœï¼ˆåŒ…å« StepResultï¼‰

#### 2. æ ¸å¿ƒæœåŠ¡ï¼ˆServicesï¼‰
- âœ… `TaskTestRunnerService.cs` - æµ‹è¯•è¿è¡Œåè°ƒå™¨
  - ç”ŸæˆéšæœºæŒ‡çº¹
  - åˆ›å»ºä¸´æ—¶æµè§ˆå™¨ç¯å¢ƒ
  - å¯åŠ¨æµè§ˆå™¨
  - æ‰§è¡Œ DSL æ­¥éª¤ï¼ˆå ä½ï¼‰
  - æ¸…ç†èµ„æº

#### 3. UI ç»„ä»¶ï¼ˆViews/Dialogsï¼‰
- âœ… `TaskTestProgressDialog.xaml` - è¿›åº¦å¯¹è¯æ¡† UI
  - è¿›åº¦æ¡å’Œé˜¶æ®µæ˜¾ç¤º
  - å®æ—¶æ—¥å¿—é¢æ¿
  - æˆªå›¾é¢„è§ˆ
  - ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ­¥éª¤æ•°ã€æ—¶é—´ã€æˆåŠŸ/å¤±è´¥ï¼‰
  - æ“ä½œæŒ‰é’®ï¼ˆåœæ­¢ã€å¤åˆ¶æ—¥å¿—ã€å…³é—­ï¼‰
- âœ… `TaskTestProgressDialog.xaml.cs` - è¿›åº¦å¯¹è¯æ¡†é€»è¾‘
  - è¿›åº¦æ›´æ–°
  - æ—¥å¿—æ˜¾ç¤º
  - æˆªå›¾åŠ è½½
  - å–æ¶ˆæ”¯æŒ

#### 4. é›†æˆï¼ˆAITaskViewï¼‰
- âœ… ä¿®æ”¹ `AITaskView.xaml.cs` çš„ `RunTest_Click` æ–¹æ³•
  - ä» DI å®¹å™¨è·å– TaskTestRunnerService
  - åˆ›å»ºè¿›åº¦å¯¹è¯æ¡†
  - é…ç½®æµ‹è¯•é€‰é¡¹
  - åå°è¿è¡Œæµ‹è¯•
  - æ˜¾ç¤ºç»“æœ

#### 5. ä¾èµ–æ³¨å…¥
- âœ… åœ¨ `ServiceCollectionExtensions.cs` æ³¨å†Œ TaskTestRunnerService

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### åˆ†å±‚ç»“æ„

```
UI Layer
  â””â”€ AITaskView (è¿è¡Œæµ‹è¯•æŒ‰é’®)
  â””â”€ TaskTestProgressDialog (è¿›åº¦æ˜¾ç¤º)
       â†“
Service Layer
  â””â”€ TaskTestRunnerService (åè°ƒå™¨)
       â†“
Engine Layer
  â””â”€ PlaywrightController (æµè§ˆå™¨æ§åˆ¶)
```

### æ•°æ®æµ

```
ç”¨æˆ·ç‚¹å‡»"è¿è¡Œæµ‹è¯•"
  â†’ TaskTestRunnerService.RunTestAsync()
  â†’ IProgress<TestProgress> å›è°ƒ
  â†’ TaskTestProgressDialog.UpdateProgress()
  â†’ UI æ›´æ–°ï¼ˆè¿›åº¦æ¡ã€æ—¥å¿—ã€æˆªå›¾ï¼‰
```

---

## ğŸ”§ å…³é”®å®ç°

### 1. å¼‚æ­¥è¿›åº¦æŠ¥å‘Š

```csharp
var progress = new Progress<TestProgress>(p => progressDialog.UpdateProgress(p));
await testRunner.RunTestAsync(dsl, options, progress, cts.Token);
```

### 2. å–æ¶ˆæ”¯æŒ

```csharp
var cts = new CancellationTokenSource();
progressDialog.SetCancellationTokenSource(cts);
// ç”¨æˆ·ç‚¹å‡»åœæ­¢æ—¶è°ƒç”¨ cts.Cancel()
```

### 3. èµ„æºæ¸…ç†

```csharp
finally
{
    if (controller != null)
        await controller.DisposeAsync();
    
    if (options.CleanupAfterTest && tempUserDataPath != null)
        Directory.Delete(tempUserDataPath, recursive: true);
}
```

### 4. éšæœºæŒ‡çº¹ç”Ÿæˆ

```csharp
var preset = await _fingerprintPresetService.GetRandomPresetAsync();
var profile = await _fingerprintGeneratorService.GenerateFromPresetAsync(preset);
profile.Name = $"Test_{DateTime.Now:yyyyMMdd_HHmmss}";
```

---

## ğŸ“Š UI è®¾è®¡

### è¿›åº¦å¯¹è¯æ¡†å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ§ª æµ‹è¯•è¿è¡Œä¸­ - ä»»åŠ¡åç§°          âœ–    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å½“å‰é˜¶æ®µï¼šæ‰§è¡Œæ­¥éª¤ (3/5)               â”‚
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 60%       â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ“‹ æ‰§è¡Œæ—¥å¿—                        â”‚ â”‚
â”‚  â”‚ [14:23:01] âœ… åˆå§‹åŒ–æµè§ˆå™¨         â”‚ â”‚
â”‚  â”‚ [14:23:02] âœ… ç”ŸæˆéšæœºæŒ‡çº¹         â”‚ â”‚
â”‚  â”‚ [14:23:03] â–¶ï¸  æ‰§è¡Œæ­¥éª¤ 1: open   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ“¸ å®æ—¶æˆªå›¾                        â”‚ â”‚
â”‚  â”‚   [æµè§ˆå™¨æˆªå›¾é¢„è§ˆ]                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚  å·²æ‰§è¡Œ: 3/5  æ—¶é—´: 00:15  æˆåŠŸ: 3  å¤±è´¥: 0 â”‚
â”‚                                         â”‚
â”‚  â¹ï¸ åœæ­¢  ğŸ“‹ å¤åˆ¶æ—¥å¿—  å…³é—­            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ·å¼è§„èŒƒ

- **ä¸»è‰²è°ƒ**: #2196F3 (è“è‰²)
- **æˆåŠŸè‰²**: #4CAF50 (ç»¿è‰²)
- **è­¦å‘Šè‰²**: #FF9800 (æ©™è‰²)
- **é”™è¯¯è‰²**: #F44336 (çº¢è‰²)
- **èƒŒæ™¯è‰²**: #F5F5F5
- **è¾¹æ¡†è‰²**: #E0E0E0

---

## ğŸš€ ä½¿ç”¨æµç¨‹

### ç”¨æˆ·æ“ä½œæµç¨‹

1. åœ¨ AI ä»»åŠ¡ç•Œé¢ç”Ÿæˆ DSL è„šæœ¬
2. ç‚¹å‡»"â–¶ï¸ è¿è¡Œæµ‹è¯•"æŒ‰é’®
3. ç³»ç»Ÿè‡ªåŠ¨ï¼š
   - ç”ŸæˆéšæœºæŒ‡çº¹é…ç½®
   - åˆ›å»ºä¸´æ—¶æµè§ˆå™¨ç¯å¢ƒ
   - å¯åŠ¨æµè§ˆå™¨ï¼ˆæ˜¾ç¤ºæ¨¡å¼ï¼‰
   - æ‰§è¡Œ DSL æ­¥éª¤
4. å®æ—¶æŸ¥çœ‹ï¼š
   - è¿›åº¦æ¡å’Œå½“å‰é˜¶æ®µ
   - æ‰§è¡Œæ—¥å¿—
   - æµè§ˆå™¨æˆªå›¾
   - ç»Ÿè®¡ä¿¡æ¯
5. æµ‹è¯•å®Œæˆåï¼š
   - æŸ¥çœ‹ç»“æœæ‘˜è¦
   - å¤åˆ¶æ—¥å¿—
   - å…³é—­å¯¹è¯æ¡†

### æµ‹è¯•é€‰é¡¹

```csharp
var options = new TestRunOptions
{
    UseRandomFingerprint = true,  // ä½¿ç”¨éšæœºæŒ‡çº¹
    Headless = false,              // æ˜¾ç¤ºæµè§ˆå™¨
    TimeoutSeconds = 300,          // 5åˆ†é’Ÿè¶…æ—¶
    SaveScreenshots = true,        // ä¿å­˜æˆªå›¾
    CleanupAfterTest = true        // æµ‹è¯•åæ¸…ç†
};
```

---

## ğŸ“ å¾…å®ç°åŠŸèƒ½

### Phase 2: DSL æ‰§è¡Œå™¨ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

éœ€è¦å®ç°å®Œæ•´çš„ DSL è§£æå’Œæ‰§è¡Œé€»è¾‘ï¼š

1. **DslParser** - YAML è§£æ
   - ä½¿ç”¨ YamlDotNet è§£æ DSL
   - éªŒè¯å¿…éœ€å­—æ®µ
   - æ„å»º DslFlow å¯¹è±¡

2. **DslExecutor** - æ­¥éª¤æ‰§è¡Œ
   - å®ç°æ‰€æœ‰æ­¥éª¤ç±»å‹ï¼š
     - `open/goto` - å¯¼èˆª
     - `click` - ç‚¹å‡»
     - `type/fill` - è¾“å…¥
     - `waitFor` - ç­‰å¾…
     - `extract` - æ•°æ®æå–
     - `screenshot` - æˆªå›¾
     - `if/for/while` - æ§åˆ¶æµ
   - å˜é‡ç®¡ç†
   - é”™è¯¯å¤„ç†
   - é‡è¯•æœºåˆ¶

3. **PlaywrightController æ‰©å±•**
   - æ·»åŠ æ­¥éª¤æ‰§è¡Œæ–¹æ³•
   - é€‰æ‹©å™¨è§£æ
   - æ•°æ®æå–
   - æˆªå›¾æ•è·

### Phase 3: é«˜çº§åŠŸèƒ½ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

1. **æ–­ç‚¹è°ƒè¯•**
   - æš‚åœ/ç»§ç»­æ‰§è¡Œ
   - å•æ­¥æ‰§è¡Œ
   - æŸ¥çœ‹å˜é‡

2. **æ­¥éª¤ç¼–è¾‘**
   - ä¿®æ”¹æ­¥éª¤å‚æ•°
   - é‡æ–°æ‰§è¡Œå¤±è´¥æ­¥éª¤

3. **ç½‘ç»œç›‘æ§**
   - è¯·æ±‚/å“åº”æ—¥å¿—
   - æ€§èƒ½åˆ†æ

### Phase 4: æ‰¹é‡æµ‹è¯•ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

1. å¤šä»»åŠ¡å¹¶è¡Œæµ‹è¯•
2. æµ‹è¯•æŠ¥å‘Šç”Ÿæˆ
3. æ€§èƒ½åŸºå‡†æµ‹è¯•

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ–°å»ºæ–‡ä»¶

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `Models/TestRunOptions.cs` | æ¨¡å‹ | æµ‹è¯•è¿è¡Œé€‰é¡¹ |
| `Models/TestProgress.cs` | æ¨¡å‹ | æµ‹è¯•è¿›åº¦ä¿¡æ¯ |
| `Models/TestRunResult.cs` | æ¨¡å‹ | æµ‹è¯•ç»“æœ |
| `Services/TaskTestRunnerService.cs` | æœåŠ¡ | æµ‹è¯•è¿è¡Œåè°ƒå™¨ |
| `Views/Dialogs/TaskTestProgressDialog.xaml` | UI | è¿›åº¦å¯¹è¯æ¡† |
| `Views/Dialogs/TaskTestProgressDialog.xaml.cs` | UI | è¿›åº¦å¯¹è¯æ¡†é€»è¾‘ |
| `docs/ai-task-test-runner-design.md` | æ–‡æ¡£ | è®¾è®¡æ–‡æ¡£ |
| `docs/ai-task-test-runner-implementation.md` | æ–‡æ¡£ | å®ç°æ€»ç»“ |

### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `Views/AITaskView.xaml.cs` | å®ç° RunTest_Click æ–¹æ³• |
| `Infrastructure/Configuration/ServiceCollectionExtensions.cs` | æ³¨å†Œ TaskTestRunnerService |

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•
- [ ] TestRunOptions é»˜è®¤å€¼
- [ ] TestProgress æ•°æ®ä¼ é€’
- [ ] TestRunResult ç»“æœæ”¶é›†

### é›†æˆæµ‹è¯•
- [ ] éšæœºæŒ‡çº¹ç”Ÿæˆ
- [ ] ä¸´æ—¶ç¯å¢ƒåˆ›å»º
- [ ] æµè§ˆå™¨å¯åŠ¨
- [ ] èµ„æºæ¸…ç†

### UI æµ‹è¯•
- [ ] è¿›åº¦å¯¹è¯æ¡†æ˜¾ç¤º
- [ ] æ—¥å¿—å®æ—¶æ›´æ–°
- [ ] æˆªå›¾é¢„è§ˆ
- [ ] å–æ¶ˆåŠŸèƒ½

### ç«¯åˆ°ç«¯æµ‹è¯•
- [ ] å®Œæ•´æµ‹è¯•æµç¨‹
- [ ] é”™è¯¯åœºæ™¯å¤„ç†
- [ ] è¶…æ—¶å¤„ç†

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³è¡ŒåŠ¨ï¼ˆP0ï¼‰
1. âœ… æ³¨å†Œ TaskTestRunnerService åˆ° DI å®¹å™¨
2. â³ å®ç° DslParserï¼ˆYAML è§£æï¼‰
3. â³ å®ç° DslExecutorï¼ˆæ­¥éª¤æ‰§è¡Œï¼‰
4. â³ æ‰©å±• PlaywrightController æ­¥éª¤æ–¹æ³•

### çŸ­æœŸç›®æ ‡ï¼ˆP1ï¼‰
1. å®ŒæˆåŸºç¡€æ­¥éª¤æ‰§è¡Œï¼ˆopenã€clickã€typeã€waitForï¼‰
2. å®ç°æ•°æ®æå–ï¼ˆextractï¼‰
3. å®ç°æˆªå›¾æ•è·
4. ç«¯åˆ°ç«¯æµ‹è¯•

### ä¸­æœŸç›®æ ‡ï¼ˆP2ï¼‰
1. å®ç°æ§åˆ¶æµï¼ˆifã€forã€whileï¼‰
2. å®ç°é”™è¯¯å¤„ç†å’Œé‡è¯•
3. æ·»åŠ æ–­ç‚¹è°ƒè¯•
4. æ€§èƒ½ä¼˜åŒ–

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [AI ä»»åŠ¡æµ‹è¯•è¿è¡Œå™¨ - è®¾è®¡æ–‡æ¡£](./ai-task-test-runner-design.md)
- [Task Flow DSL è§„èŒƒ](./task-flow-dsl-spec.md)
- [AI ä»»åŠ¡ç•Œé¢ä½¿ç”¨æŒ‡å—](./ai-task-ui-guide.md)

---

**ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¶é—´**: 2025-10-31  
**çŠ¶æ€**: Phase 1 å®Œæˆï¼ŒPhase 2 å¾…å®ç°  
**ä¸‹ä¸€é‡Œç¨‹ç¢‘**: å®ç° DSL æ‰§è¡Œå™¨
