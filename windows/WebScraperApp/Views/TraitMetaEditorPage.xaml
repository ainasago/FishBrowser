<Page x:Class="FishBrowser.WPF.Views.TraitMetaEditorPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      Title="元配置编辑器">
  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
      <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>

    <DockPanel Grid.Row="0" Margin="10">
      <TextBlock Text="选择元配置:" VerticalAlignment="Center"/>
      <ComboBox x:Name="MetaCombo" Width="320" Margin="8,0,0,0" SelectionChanged="MetaCombo_SelectionChanged"/>
      <Button Content="新建" Margin="8,0,0,0" Width="70" Click="NewMeta_Click"/>
      <Button Content="保存" Margin="8,0,0,0" Width="70" Click="SaveMeta_Click"/>
      <Button Content="生成 Profile" Margin="8,0,0,0" Width="110" Click="GenerateProfile_Click"/>
      <Button Content="生成UA(Chrome+Windows)" Margin="8,0,0,0" Width="180" Click="GenerateUA_Click"/>
      <TextBlock Text="排序:" Margin="12,0,0,0" VerticalAlignment="Center"/>
      <ComboBox Width="120" Margin="6,0,0,0"
                SelectedValuePath="Tag"
                SelectedValue="{Binding SelectedSortMode, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
        <ComboBoxItem Tag="weight">按权重</ComboBoxItem>
        <ComboBoxItem Tag="label">按标签</ComboBoxItem>
        <ComboBoxItem Tag="value">按值</ComboBoxItem>
      </ComboBox>
      <TextBlock Text="区域:" Margin="12,0,0,0" VerticalAlignment="Center"/>
      <ComboBox Width="120" Margin="6,0,0,0"
                ItemsSource="{Binding Regions}"
                SelectedItem="{Binding SelectedRegion, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
      <TextBlock Text="厂商:" Margin="8,0,0,0" VerticalAlignment="Center"/>
      <ComboBox Width="120" Margin="6,0,0,0"
                ItemsSource="{Binding Vendors}"
                SelectedItem="{Binding SelectedVendor, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
      <TextBlock Text="设备:" Margin="8,0,0,0" VerticalAlignment="Center"/>
      <ComboBox Width="120" Margin="6,0,0,0"
                ItemsSource="{Binding DeviceClasses}"
                SelectedItem="{Binding SelectedDeviceClass, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
      <Grid>
        <TextBlock Text="搜索键..." 
                   Foreground="Gray" 
                   Margin="20,0,0,0" 
                   VerticalAlignment="Center" 
                   HorizontalAlignment="Left"
                   IsHitTestVisible="False"
                   x:Name="PlaceholderText"/>
        <TextBox x:Name="SearchBox" Width="220" Margin="20,0,0,0" TextChanged="SearchBox_TextChanged" Background="Transparent"/>
      </Grid>
    </DockPanel>

    <Grid Grid.Row="1" Margin="10">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="*"/>
        <ColumnDefinition Width="360"/>
      </Grid.ColumnDefinitions>

      <DataGrid x:Name="TraitGrid" Grid.Column="0" AutoGenerateColumns="False" CanUserAddRows="True" CanUserDeleteRows="True">
        <DataGrid.Columns>
          <DataGridTemplateColumn Header="Key" Width="2*">
            <DataGridTemplateColumn.CellTemplate>
              <DataTemplate>
                <ComboBox IsEditable="True"
                          ItemsSource="{Binding DataContext.AllKeys, RelativeSource={RelativeSource AncestorType=Page}}"
                          Text="{Binding Key, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                          IsTextSearchEnabled="True"
                          StaysOpenOnEdit="True"
                          MinWidth="200"/>
              </DataTemplate>
            </DataGridTemplateColumn.CellTemplate>
          </DataGridTemplateColumn>
          <DataGridTemplateColumn Header="Value (JSON 或文本)" Width="3*">
            <DataGridTemplateColumn.CellTemplate>
              <DataTemplate>
                <ComboBox IsEditable="True"
                          ItemsSource="{Binding FilteredOptions}"
                          SelectedValuePath="ValueJson"
                          SelectedValue="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                          Text="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                          IsTextSearchEnabled="True"
                          StaysOpenOnEdit="True"
                          MinWidth="260">
                  <ComboBox.ItemTemplate>
                    <DataTemplate>
                      <TextBlock>
                        <Run Text="{Binding Prefix}"/>
                        <Run Text="{Binding Match}" FontWeight="Bold"/>
                        <Run Text="{Binding Suffix}"/>
                      </TextBlock>
                    </DataTemplate>
                  </ComboBox.ItemTemplate>
                </ComboBox>
              </DataTemplate>
            </DataGridTemplateColumn.CellTemplate>
          </DataGridTemplateColumn>
          <DataGridTemplateColumn Header="操作" Width="120">
            <DataGridTemplateColumn.CellTemplate>
              <DataTemplate>
                <Button Content="从选项选择" Click="PickOption_Click"/>
              </DataTemplate>
            </DataGridTemplateColumn.CellTemplate>
          </DataGridTemplateColumn>
        </DataGrid.Columns>
      </DataGrid>

      <GroupBox Header="随机/锁定" Grid.Column="1" Margin="10,0,0,0">
        <StackPanel Margin="8">
          <TextBlock Text="锁定键 (LockFlagsJson)" FontWeight="Bold"/>
          <TextBox x:Name="LockFlagsBox" Height="80" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Text="[]"/>
          <StackPanel Orientation="Horizontal" Margin="0,6,0,6">
            <Button Content="锁定全部" Width="90" Margin="0,0,6,0" Click="LockAll_Click"/>
            <Button Content="清除锁定" Width="90" Click="UnlockAll_Click"/>
          </StackPanel>
          <Separator Margin="0,8,0,8"/>
          <Button Content="补齐缺省值" Width="110" Click="FillMissingWithDefaults_Click"/>
          <Separator Margin="0,8,0,8"/>
          <TextBlock Text="随机计划 (RandomizationPlanJson)" FontWeight="Bold"/>
          <TextBox x:Name="RandomPlanBox" Height="180" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Text="{}"/>
          <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
            <Button Content="示例随机计划" Width="110" Click="FillRandomPlanSample_Click"/>
          </StackPanel>
          <TextBlock Text="示例: {&quot;device.viewport.width&quot;: { &quot;type&quot;: &quot;UniformInt&quot;, &quot;min&quot;: 1280, &quot;max&quot;: 1920 },&quot;device.viewport.height&quot;: { &quot;type&quot;: &quot;NormalInt&quot;, &quot;mean&quot;: 900, &quot;stddev&quot;: 120, &quot;min&quot;: 720, &quot;max&quot;: 1200 }}" TextWrapping="Wrap" Margin="0,6,0,0"/>
        </StackPanel>
      </GroupBox>
    </Grid>

    <DockPanel Grid.Row="2" Margin="10">
      <TextBlock x:Name="StatusText"/>
    </DockPanel>
  </Grid>
</Page>